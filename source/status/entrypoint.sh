#!/bin/sh
# status/entrypoint.sh
# Версия 1.0.1: Исправлен вызов команды flask для создания пользователя.

# Выход при ошибке
set -e

echo "Entrypoint: Запуск скрипта..."

# Небольшая пауза, чтобы дать БД время полностью подняться (опционально, но может помочь)
# sleep 5 # Если БД стартует медленно, можно увеличить

echo "Entrypoint: Попытка создания пользователя 'adm' (пароль '123')..."

# <<< ИСПРАВЛЕН ВЫЗОВ КОМАНДЫ: flask user create ... >>>
# Выполняем команду Flask для создания пользователя.
# Подавляем стандартный вывод (чтобы не мешать логам Gunicorn),
# но выводим сообщение, если команда завершилась с ошибкой.
if flask user create adm 123; then # Проверяем код возврата команды
    echo "Entrypoint: Пользователь 'adm' успешно создан или уже существовал."
else
    # Команда завершилась с ошибкой (код возврата не 0)
    # Сама команда flask user create должна выводить сообщение об ошибке в stderr,
    # которое будет видно в логах Docker. Здесь просто логируем факт неудачи.
    echo "Entrypoint: Не удалось создать пользователя 'adm'. См. вывод команды flask выше для деталей."
fi

# Строка ниже теперь не нужна, т.к. результат уже обработан
# flask user create adm 123 || echo "Entrypoint: Не удалось создать пользователя 'adm' (возможно, уже существует или ошибка БД)."

# Эту строку можно оставить для лога, но она дублирует сообщение из if/else
# echo "Entrypoint: Пользователь 'adm' проверен/создан (или уже существовал)."

echo "Entrypoint: Запуск основной команды (Gunicorn)..."

# exec "$@" выполняет команду, которая передана в CMD Dockerfile
exec "$@"