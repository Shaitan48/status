<!-- status/app/templates/manage_api_keys.html -->
{# –ù–∞—Å–ª–µ–¥—É–µ–º –±–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—é #}
{% extends "base.html" %}

{# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —ç—Ç–æ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã #}
{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –ö–ª—é—á–∞–º–∏ - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ü–¢–ö{% endblock %}

{# –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ CSS —Å—Ç–∏–ª–∏ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –±–ª–æ–∫ head_extra –±–∞–∑–æ–≤–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ #}
{% block head_extra %}
<style>
    /* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ —Å–µ–∫—Ü–∏–π --- */
    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–π –Ω–∞ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏: —Ñ–æ—Ä–º–∞ —Å–ª–µ–≤–∞, —Å–ø–∏—Å–æ–∫ —Å–ø—Ä–∞–≤–∞ */
    .manage-container { display: grid; grid-template-columns: minmax(350px, 1fr) 2fr; gap: 2rem; align-items: start; margin-top: 1rem; }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ (—Å–µ–∫—Ü–∏–π) */
    .form-section, .list-section { background-color: var(--card-bg); padding: 1.5rem; border-radius: 5px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); }
    /* –î–µ–ª–∞–µ–º —Ñ–æ—Ä–º—É "–ª–∏–ø–∫–æ–π" –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ */
    .form-section { position: sticky; top: 80px; }
    /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–µ–∫—Ü–∏–π */
    .form-section h3, .list-section h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 0.8rem; margin-bottom: 1rem; }
    /* --- –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—ã --- */
    .form-group { margin-bottom: 1rem; } /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏ –ø–æ–ª–µ–π */
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.95em; } /* –õ–µ–π–±–ª—ã */
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select {
        width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em;
    } /* –ü–æ–ª—è –≤–≤–æ–¥–∞ –∏ —Å–µ–ª–µ–∫—Ç—ã */
    .form-actions { margin-top: 1.5rem; text-align: right; display: flex; justify-content: flex-end; gap: 0.5rem; } /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–æ—Ä–º—ã */
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–µ–π–±–ª–∞ –∏ —á–µ–∫–±–æ–∫—Å–∞ "–ê–∫—Ç–∏–≤–µ–Ω" */
    .form-group label.checkbox-label { display: inline-block; margin-left: 5px; font-weight: normal; cursor: pointer; vertical-align: middle;}
    .form-group input[type="checkbox"] { width: auto; vertical-align: middle;}

    /* --- –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–µ–π --- */
    .filter-controls { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 1.5rem; padding: 1rem; background-color: #f8f9fa; border: 1px solid var(--border-color); border-radius: 4px; }
    .filter-group { display: flex; flex-direction: column; } /* –ì—Ä—É–ø–ø–∞: –ª–µ–π–±–ª + –ø–æ–ª–µ */
    .filter-group label { margin-bottom: 5px; font-size: 0.9em; font-weight: 500; }
    .filter-controls select, .filter-controls input { padding: 6px 8px; font-size: 0.95em; border-radius: 3px; border: 1px solid #ccc; min-width: 150px; }
    #apply-filters-btn { align-self: flex-end; padding: 6px 15px; } /* –ö–Ω–æ–ø–∫–∞ –ü—Ä–∏–º–µ–Ω–∏—Ç—å */

    /* --- –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –∫–ª—é—á–µ–π --- */
    .keys-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .keys-table th, .keys-table td { border: 1px solid var(--border-color); padding: 8px 12px; text-align: left; vertical-align: middle; }
    .keys-table th { background-color: var(--light-grey); font-weight: 600; white-space: nowrap; }
    .keys-table .actions { text-align: center; white-space: nowrap; width: 100px; } /* –ö–æ–ª–æ–Ω–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π */
    .keys-table .actions button { padding: 4px 8px; font-size: 0.9em; cursor: pointer; border: none; border-radius: 3px; color: white; margin: 2px; }
    .keys-table .edit-btn { background-color: var(--warning-color); color: #333; }
    .keys-table .edit-btn:hover { background-color: #e0a800; }
    .keys-table .delete-btn { background-color: var(--danger-color); }
    .keys-table .delete-btn:hover { background-color: #c82333; }

    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å—Ç–∞—Ç—É—Å–∞ "–ê–∫—Ç–∏–≤–µ–Ω" */
    .active-switch { display: inline-block; position: relative; width: 40px; height: 20px; }
    .active-switch input { opacity: 0; width: 0; height: 0; } /* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —á–µ–∫–±–æ–∫—Å */
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; } /* –ö—Ä—É–≥–ª—ã–π –ø–æ–ª–∑—É–Ω–æ–∫ */
    input:checked + .slider { background-color: var(--success-color); } /* –¶–≤–µ—Ç –≤–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
    input:focus + .slider { box-shadow: 0 0 1px var(--success-color); }
    input:checked + .slider:before { transform: translateX(20px); } /* –°–¥–≤–∏–≥–∞–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –≤–ø—Ä–∞–≤–æ */

    /* --- –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–∫—Ü–∏–∏ –ø–æ–∫–∞–∑–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞ --- */
    #generated-key-section { margin-top: 1.5rem; padding: 1rem; border: 1px solid var(--warning-color); background-color: #fff9e6; border-radius: 5px; display: none; /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–æ */ }
    #generated-key-section h4 { margin-top: 0; color: #856404; }
    #generated-api-key { font-family: monospace; font-size: 1.1em; word-break: break-all; background-color: #fff; padding: 8px; border: 1px dashed #ccc; border-radius: 3px; display: inline-block; margin-right: 10px; user-select: all; } /* –ü–æ–ª–µ —Å –∫–ª—é—á–æ–º */
    .copy-key-btn { padding: 5px 10px; font-size: 0.9em; vertical-align: middle;} /* –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è */

    /* --- –°—Ç–∏–ª–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ --- */
    .pagination-controls { margin-top: 1.5rem; text-align: center; }
    .pagination-controls button, .pagination-controls span { display: inline-block; padding: 5px 10px; margin: 0 3px; border: 1px solid #ccc; border-radius: 3px; background-color: #fff; cursor: pointer; font-size: 0.9em; }
    .pagination-controls button:disabled { background-color: #eee; color: #aaa; cursor: not-allowed; }
    .pagination-controls span.current-page { background-color: var(--primary-color); color: white; border-color: var(--primary-color); cursor: default; }

    /* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π (feedback) --- */
    .feedback-area { min-height: 1.5em; margin-top: 1rem; font-weight: 500; padding: 5px; border-radius: 3px; text-align: center; }
    .feedback-area.error-feedback { color: var(--danger-color); background-color: #f8d7da; border: 1px solid #f5c6cb; }
    .feedback-area.success-feedback { color: var(--success-color); background-color: #d4edda; border: 1px solid #c3e6cb;}
    /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–ª–µ–π */
    .error-feedback { color: var(--danger-color); font-size: 0.9em; margin-top: 5px; display: block; /* –ß—Ç–æ–±—ã –∑–∞–Ω–∏–º–∞–ª–æ –≤—Å—é —à–∏—Ä–∏–Ω—É */ min-height: 1em; }

    /* –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ –≤ —Ç–∞–±–ª–∏—Ü–µ */
    .loading-message { text-align: center; padding: 1em; color: var(--secondary-color); font-style: italic; }
    .error-message { color: var(--danger-color); font-weight: bold; text-align: center; padding: 1em;}

</style>
{% endblock %}

{# –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã #}
{% block content %}
<h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –ö–ª—é—á–∞–º–∏</h2>

{# –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ layout —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏) #}
<div class="manage-container">

    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞ -->
    <section class="form-section">
        <h3 id="form-title">–°–æ–∑–¥–∞—Ç—å –ù–æ–≤—ã–π API –ö–ª—é—á</h3>
        <form id="api-key-form">
            {# –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID –∫–ª—é—á–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è #}
            <input type="hidden" id="edit-key-id">

            {# –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –æ–ø–∏—Å–∞–Ω–∏—è –∫–ª—é—á–∞ #}
            <div class="form-group">
                <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
                <input type="text" id="description" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –û–Ω–ª–∞–π–Ω –∞–≥–µ–Ω—Ç –¥–ª—è –ü–£">
                {# –û–±–ª–∞—Å—Ç—å –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—è #}
                <div class="error-feedback" id="description-error"></div>
            </div>

            {# –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ –∫–ª—é—á–∞ #}
            <div class="form-group">
                <label for="role">–†–æ–ª—å *</label>
                <select id="role" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å --</option>
                    <option value="agent">agent (–ê–≥–µ–Ω—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)</option>
                    <option value="loader">loader (–ó–∞–≥—Ä—É–∑—á–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)</option>
                    <option value="configurator">configurator (–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä –∞–≥–µ–Ω—Ç–æ–≤)</option>
                    <option value="admin">admin (–ü–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∞, –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                </select>
                 <div class="error-feedback" id="role-error"></div>
            </div>

            {# –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é (–ø–æ ObjectID) #}
            <div class="form-group">
                <label for="object-id">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <select id="object-id">
                    <option value="">-- –ù–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å --</option>
                    {# –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å –ø–æ–º–æ—â—å—é JavaScript #}
                </select>
                 <div class="error-feedback" id="object-id-error"></div>
            </div>

            {# –ß–µ–∫–±–æ–∫—Å "–ê–∫—Ç–∏–≤–µ–Ω", –≤–∏–¥–∏–º—ã–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ #}
             <div class="form-group" id="is-active-group" style="display: none;">
                <label class="checkbox-label">
                    <input type="checkbox" id="is-active"> –ê–∫—Ç–∏–≤–µ–Ω
                </label>
             </div>

            {# –û–±–ª–∞—Å—Ç—å –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç API) #}
            <div id="form-feedback" class="feedback-area"></div>

            {# –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π —Ñ–æ—Ä–º—ã #}
            <div class="form-actions">
                {# –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∞", –≤–∏–¥–∏–º–∞—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ #}
                <button type="button" id="cancel-edit-btn" style="display: none; background-color: var(--secondary-color);">–û—Ç–º–µ–Ω–∞</button>
                {# –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ (–°–æ–∑–¥–∞—Ç—å/–°–æ—Ö—Ä–∞–Ω–∏—Ç—å) #}
                <button type="submit" id="submit-key-btn">–°–æ–∑–¥–∞—Ç—å –ö–ª—é—á</button>
            </div>
        </form>

        <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è -->
        <div id="generated-key-section">
            <h4>‚úÖ API –ö–ª—é—á –£—Å–ø–µ—à–Ω–æ –°–æ–∑–¥–∞–Ω!</h4>
            <p style="color: #dc3545; font-weight: bold;">
                –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á —Å–µ–π—á–∞—Å. –û–Ω –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω.
            </p>
            <div style="margin-bottom: 10px;">
                 <code id="generated-api-key"></code> {# –°—é–¥–∞ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω –∫–ª—é—á #}
                 <button type="button" class="copy-key-btn" id="copy-key-btn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <button type="button" id="close-generated-key-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

    </section>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª—é—á–µ–π -->
    <section class="list-section">
        <h3>–°–ø–∏—Å–æ–∫ –°—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ö–ª—é—á–µ–π</h3>

        <!-- –ë–ª–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã -->
        <div class="filter-controls">
             {# –§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–ª–∏ #}
             <div class="filter-group">
                 <label for="filter-role">–†–æ–ª—å:</label>
                 <select id="filter-role">
                     <option value="">–í—Å–µ</option>
                     <option value="agent">agent</option>
                     <option value="loader">loader</option>
                     <option value="configurator">configurator</option>
                     <option value="admin">admin</option>
                 </select>
             </div>
             {# –§–∏–ª—å—Ç—Ä –ø–æ Object ID –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è #}
             <div class="filter-group">
                 <label for="filter-object-id">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ (Object ID):</label>
                 <select id="filter-object-id">
                     <option value="">–í—Å–µ</option>
                     {# –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ #}
                 </select>
             </div>
             {# –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ #}
             <div class="filter-group">
                 <label for="filter-is-active">–°—Ç–∞—Ç—É—Å:</label>
                 <select id="filter-is-active">
                     <option value="">–í—Å–µ</option>
                     <option value="true">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                     <option value="false">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                 </select>
             </div>
             {# –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ #}
             <button id="apply-filters-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>

        {# –û–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è) #}
        <div id="list-feedback" class="feedback-area"></div>

        {# –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–ª—é—á–µ–π #}
        <table class="keys-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th>–†–æ–ª—å</th>
                    <th>Object ID</th>
                    <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                    <th>–°–æ–∑–¥–∞–Ω</th>
                    <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            {# –¢–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã, –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ JavaScript #}
            <tbody id="key-list">
                <tr><td colspan="8" class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–µ–π...</td></tr>
            </tbody>
        </table>

        {# –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π, –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç—ã #}
        <div class="pagination-controls" id="pagination-controls" style="display: none;">
            <button id="prev-page" disabled>¬´ –ù–∞–∑–∞–¥</button>
            <span id="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ - –∏–∑ -</span>
            <button id="next-page" disabled>–í–ø–µ—Ä–µ–¥ ¬ª</button>
        </div>
    </section>
</div>
{% endblock %}

{# –ë–ª–æ–∫ –¥–ª—è JavaScript –∫–æ–¥–∞ #}
{% block scripts %}
<script>
    // --- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã DOM ---
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
    const form = document.getElementById('api-key-form');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-key-btn');
    const cancelBtn = document.getElementById('cancel-edit-btn');
    const editKeyIdInput = document.getElementById('edit-key-id');
    const descriptionInput = document.getElementById('description');
    const roleSelect = document.getElementById('role');
    const objectIdSelect = document.getElementById('object-id'); // –°–µ–ª–µ–∫—Ç –¥–ª—è Object ID
    const isActiveGroup = document.getElementById('is-active-group');
    const isActiveCheckbox = document.getElementById('is-active');
    const formFeedback = document.getElementById('form-feedback');
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Å–µ–∫—Ü–∏–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞
    const generatedKeySection = document.getElementById('generated-key-section');
    const generatedApiKeyElement = document.getElementById('generated-api-key');
    const copyKeyBtn = document.getElementById('copy-key-btn');
    const closeGeneratedKeyBtn = document.getElementById('close-generated-key-btn');
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const keyList = document.getElementById('key-list');
    const listFeedback = document.getElementById('list-feedback');
    const filterRoleSelect = document.getElementById('filter-role');
    const filterObjectIdSelect = document.getElementById('filter-object-id'); // –°–µ–ª–µ–∫—Ç –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
    const filterIsActiveSelect = document.getElementById('filter-is-active');
    const applyFiltersBtn = document.getElementById('apply-filters-btn');
    // –≠–ª–µ–º–µ–Ω—Ç—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    const paginationControls = document.getElementById('pagination-controls');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const pageInfoSpan = document.getElementById('page-info');

    // --- URL API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ ---
    const API_URL_KEYS = "{{ url_for('api_keys.get_api_keys_route') }}"; // –î–ª—è GET (—Å–ø–∏—Å–æ–∫) –∏ POST (—Å–æ–∑–¥–∞–Ω–∏–µ)
    const API_URL_KEY_DETAIL_TPL = "{{ url_for('api_keys.update_api_key_route', key_id=0) }}"; // –î–ª—è PUT (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ) –∏ DELETE
    const API_URL_SUBDIVISIONS = "{{ url_for('subdivisions.api_get_subdivisions') }}"; // –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π –≤ —Å–µ–ª–µ–∫—Ç—ã

    // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
    let apiKeysCache = []; // –ö—ç—à –∫–ª—é—á–µ–π –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    let subdivisionsCache = []; // –ö—ç—à –í–°–ï–• –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ–≤
    let currentEditKeyId = null; // ID –∫–ª—é—á–∞, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç
    let currentPage = 1;         // –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    let itemsPerPage = 15;       // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    let totalKeys = 0;           // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π (—Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤)

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

    /**
     * –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ API, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏ –∏ API.
     * @param {string} url - URL —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞.
     * @param {object} options - –û–ø—Ü–∏–∏ –¥–ª—è fetch (method, headers, body).
     * @returns {Promise<object|null>} - Promise —Å —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–º JSON-–æ—Ç–≤–µ—Ç–æ–º –∏–ª–∏ null –ø—Ä–∏ —É—Å–ø–µ—Ö–µ –±–µ–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (204).
     * @throws {Error} - –ö–∞—Å—Ç–æ–º–Ω–∞—è –æ—à–∏–±–∫–∞ —Å –ø–æ–ª—è–º–∏ message, details, code, status –ø—Ä–∏ –æ—à–∏–±–∫–µ.
     */
     async function fetchData(url, options = {}) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ POST/PUT/DELETE
        const method = options.method ? options.method.toUpperCase() : 'GET';
        if (method === 'GET') {
            showListFeedback('–ó–∞–≥—Ä—É–∑–∫–∞...'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è GET
        }
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                // ... (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∫–∞–∫ —Ä–∞–Ω—å—à–µ) ...
                 let errorText = `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${response.status} ${response.statusText}`;
                 let errorDetails = null; let errorCode = 'NETWORK_ERROR';
                 try {
                      const errorData = await response.json();
                      if (errorData && errorData.error) {
                         errorCode = errorData.error.code || 'API_ERROR';
                         if (errorData.error.message) errorText += ` - ${errorData.error.message}`;
                         else if (typeof errorData.error === 'string') errorText += ` - ${errorData.error}`;
                         errorDetails = errorData.error.details || errorData.error.message || errorData.error;
                      } else if (errorData && typeof errorData === 'string') { errorText += ` - ${errorData}`; errorDetails = errorData; }
                      else { errorDetails = errorData; }
                 } catch (e) {
                     try { const rawErrorText = await response.text(); errorText += ` - ${rawErrorText}`; errorDetails = rawErrorText; } catch (e2) {}
                 }
                 const error = new Error(errorText); error.details = errorDetails; error.code = errorCode; error.status = response.status; throw error;
            }
            // –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
            if (method === 'GET') {
                 showListFeedback(''); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ GET
            }
            if (response.status === 204) return null;
            const text = await response.text();
            try { return text ? JSON.parse(text) : null; }
            catch (e) { console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON:", text); return { rawText: text }; }
        } catch (error) {
             console.error("–û—à–∏–±–∫–∞ fetchData:", error);
             showListFeedback(`–û—à–∏–±–∫–∞: ${error.message}`, true); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º
             throw error;
        }
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã.
     * @param {object|string} errors - –û–±—ä–µ–∫—Ç {field_name: message} –∏–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å –æ–±—â–µ–π –æ—à–∏–±–∫–æ–π.
     * @param {string} prefix - –ü—Ä–µ—Ñ–∏–∫—Å ID —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Å—Ç–æ–π).
     */
    function displayValidationErrors(errors, prefix = '') {
         clearValidationErrors(prefix); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
         let firstErrorField = null; // –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–æ–∫—É—Å–∞
         const feedbackEl = document.getElementById(`${prefix}form-feedback`); // –û–±–ª–∞—Å—Ç—å –¥–ª—è –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫
         if (!feedbackEl) { console.error("Feedback element not found for prefix:", prefix); return; }

         if (errors && typeof errors === 'object') {
             // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –æ—à–∏–±–∫–∏ –ø–æ –ø–æ–ª—è–º
             for (const field in errors) {
                  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –ø–æ–ª—è –∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –æ—à–∏–±–∫–∏ (e.g., object_id -> object-id)
                  const fieldId = field.replace(/_([a-z])/g, (match, p1) => p1.toUpperCase());
                  const errorElementId = `${prefix}${fieldId}-error`;
                  const inputElementId = `${prefix}${fieldId}`; // ID —Å–∞–º–æ–≥–æ –ø–æ–ª—è –≤–≤–æ–¥–∞/—Å–µ–ª–µ–∫—Ç–∞

                  const errorElement = document.getElementById(errorElementId);
                  const inputElement = document.getElementById(inputElementId);

                  if (errorElement) { // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π div –¥–ª—è –æ—à–∏–±–∫–∏ –ø–æ–ª—è
                      errorElement.textContent = errors[field];
                      if (inputElement && !firstErrorField) firstErrorField = inputElement; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ñ–æ–∫—É—Å–∞
                      if (inputElement) inputElement.classList.add('invalid'); // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –ø–æ–ª—è
                  } else { // –ï—Å–ª–∏ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –æ–±—â–µ–π –æ–±–ª–∞—Å—Ç–∏ –ø–æ–¥ —Ñ–æ—Ä–º–æ–π
                      console.warn(`Element with id ${errorElementId} not found for field ${field}.`);
                      feedbackEl.textContent += ` ${field}: ${errors[field]}`;
                  }
             }
             if (feedbackEl.textContent) { // –ï—Å–ª–∏ –±—ã–ª–∏ –æ–±—â–∏–µ –æ—à–∏–±–∫–∏
                  feedbackEl.className = 'feedback-area error-feedback';
             } else if (Object.keys(errors).length > 0 && !firstErrorField) {
                  // –ï—Å–ª–∏ –æ—à–∏–±–∫–∏ –±—ã–ª–∏, –Ω–æ –¥–ª—è –Ω–∏—Ö –Ω–µ –Ω–∞—à–ª–æ—Å—å –ø–æ–ª–µ–π, –ø–æ–∫–∞–∂–µ–º –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                  feedbackEl.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ.";
                  feedbackEl.className = 'feedback-area error-feedback';
             }
         } else if (typeof errors === 'string') { // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å –æ–±—â–µ–π –æ—à–∏–±–∫–æ–π
             feedbackEl.textContent = errors;
             feedbackEl.className = 'feedback-area error-feedback';
         }
         // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ —Å –æ—à–∏–±–∫–æ–π
         if (firstErrorField) { firstErrorField.focus(); }
    }

    /** –û—á–∏—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º—ã. */
    function clearValidationErrors(prefix = '') {
        const feedbackEl = document.getElementById(`${prefix}form-feedback`);
        if (feedbackEl) { feedbackEl.textContent = ''; feedbackEl.className = 'feedback-area'; }
        document.querySelectorAll(`#${prefix}api-key-form .error-feedback`).forEach(el => el.textContent = '');
        document.querySelectorAll(`#${prefix}api-key-form input.invalid, #${prefix}api-key-form select.invalid`)
                .forEach(el => el.classList.remove('invalid'));
    }

    /** –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ (listFeedback –∏–ª–∏ formFeedback). */
    function showFeedback(element, message, isError = false) {
         if (!element) return;
         element.textContent = message;
         element.className = 'feedback-area'; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª–∞—Å—Å—ã
         if (message) { element.classList.add(isError ? 'error-feedback' : 'success-feedback'); }
    }
    /** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º –∫–ª—é—á–µ–π. */
    function showListFeedback(message, isError = false) { showFeedback(listFeedback, message, isError); }
    /** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥ —Ñ–æ—Ä–º–æ–π —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. */
    function showFormFeedback(message, isError = false) { showFeedback(formFeedback, message, isError); }

    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞—Ç—É –≤ —Å—Ç—Ä–æ–∫—É –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.
     * @param {string|Date} dateStr - –°—Ç—Ä–æ–∫–∞ –¥–∞—Ç—ã ISO –∏–ª–∏ –æ–±—ä–µ–∫—Ç Date.
     * @returns {string} - –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ 'N/A'.
     */
    function formatDateTime(dateStr) {
        if (!dateStr) return 'N/A';
        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return '–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞';
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Ä–µ–º—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ç–∞–π–º–∑–æ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            return date.toLocaleString('ru-RU', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        } catch (e) { console.error("–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã:", dateStr, e); return '–û—à–∏–±–∫–∞ –¥–∞—Ç—ã'; }
    }

    /**
     * –ö–æ–ø–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.
     * @param {string} text - –¢–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.
     */
    function copyToClipboard(text) { /* ... (–∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞) ... */ }

    /**
     * –ó–∞–ø–æ–ª–Ω—è–µ—Ç HTMLSelectElement –æ–ø—Ü–∏—è–º–∏ –∏–∑ –º–∞—Å—Å–∏–≤–∞ –¥–∞–Ω–Ω—ã—Ö.
     * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–µ—Ä–∞—Ä—Ö–∏—é –¥–ª—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π (–µ—Å–ª–∏ addHierarchy=true).
     * @param {HTMLSelectElement} selectElement - –¶–µ–ª–µ–≤–æ–π select.
     * @param {Array<Object>} items - –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö.
     * @param {string} valueField - –ò–º—è –ø–æ–ª—è –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏—è option ('id' –∏–ª–∏ 'object_id').
     * @param {string} textField - –ò–º—è –ø–æ–ª—è –¥–ª—è —Ç–µ–∫—Å—Ç–∞ option ('short_name' –∏–ª–∏ 'name').
     * @param {string} placeholder - –¢–µ–∫—Å—Ç –¥–ª—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –ø—É—Å—Ç–æ–π –æ–ø—Ü–∏–∏.
     * @param {boolean} addHierarchy - –°—Ç—Ä–æ–∏—Ç—å –ª–∏ –∏–µ—Ä–∞—Ä—Ö–∏—é (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç parent_id –∏ priority)?
     * @param {number|null} excludeId - ID —ç–ª–µ–º–µ–Ω—Ç–∞ (–ø–æ 'id'), –∫–æ—Ç–æ—Ä—ã–π –∏ —á—å–∏—Ö –ø–æ—Ç–æ–º–∫–æ–≤ –Ω—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å.
     */
     function populateSelect(selectElement, items, valueField, textField, placeholder, addHierarchy = false, excludeId = null) {
        const currentSelectedValue = selectElement.value; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        selectElement.innerHTML = `<option value="">${placeholder}</option>`; // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä

        if (!items || items.length === 0) {
            console.warn(`populateSelect –¥–ª—è ${selectElement.id}: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö`);
            return;
        }

        if (addHierarchy) { // –õ–æ–≥–∏–∫–∞ –¥–ª—è –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–≥–æ —Å–µ–ª–µ–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã–±–æ—Ä —Ä–æ–¥–∏—Ç–µ–ª—è)
            const map = {}; const roots = []; const descendantIds = new Set();
            function getDescendants(itemId) { if (!map[itemId]?.rawChildren) return; map[itemId].rawChildren.forEach(childId => { if (!descendantIds.has(childId)) { descendantIds.add(childId); getDescendants(childId); } }); }
            items.forEach(item => { map[item.id] = { ...item, rawChildren: [] }; }); // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –∫–∞–∫ –∫–ª—é—á –∫–∞—Ä—Ç—ã
            items.forEach(item => { if (item.parent_id !== null && map[item.parent_id]) { map[item.parent_id].rawChildren.push(item.id); } });
            if (excludeId !== null) { descendantIds.add(excludeId); getDescendants(excludeId); }

            const selectMap = {};
            items.forEach(item => { if (!descendantIds.has(item.id)) { selectMap[item.id] = { ...item, children: [] }; if (item.parent_id === null || !selectMap[item.parent_id]) { if (!roots.includes(item.id)) roots.push(item.id); } else if (selectMap[item.parent_id]) { selectMap[item.parent_id].children.push(item.id); } } });

            function addOption(itemId, level) {
                const item = selectMap[itemId]; if (!item) return;
                const option = document.createElement('option');
                option.value = item[valueField]; // valueField –∑–¥–µ—Å—å –æ–±—ã—á–Ω–æ 'id'
                const name = item.short_name || item[textField];
                option.textContent = '\u00A0'.repeat(level * 3) + name + ` (ID: ${item.id})`;
                selectElement.appendChild(option);
                item.children.map(id => selectMap[id]).filter(child => child)
                    .sort((a, b) => (a.priority || 999) - (b.priority || 999) || (a.short_name || a[textField]).localeCompare(b.short_name || b[textField]))
                    .forEach(child => addOption(child.id, level + 1));
            }
            roots.map(id => selectMap[id]).filter(root => root)
                .sort((a, b) => (a.priority || 999) - (b.priority || 999) || (a.short_name || a[textField]).localeCompare(b.short_name || b[textField]))
                .forEach(root => addOption(root.id, 0));

        } else { // –ü–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ (–¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –∏ –≤—ã–±–æ—Ä–∞ ObjectID –≤ —Ñ–æ—Ä–º–µ)
            items
                .filter(item => item[valueField] !== null && item[valueField] !== undefined) // –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –±–µ–∑ –Ω—É–∂–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è object_id)
                .sort((a, b) => (a[textField] || '').localeCompare(b[textField] || '')) // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ç–µ–∫—Å—Ç—É
                .forEach(item => {
                    const option = document.createElement('option');
                    option.value = item[valueField]; // valueField —Ç—É—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å 'object_id'
                    option.textContent = item[textField];
                    // –î–æ–±–∞–≤–ª—è–µ–º ObjectID –≤ —Ç–µ–∫—Å—Ç –æ–ø—Ü–∏–∏ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                    if (item.object_id !== null && item.object_id !== undefined) {
                         option.textContent += ` (OID: ${item.object_id})`;
                    } else {
                         option.textContent += ` (ID: ${item.id})`;
                    }
                    selectElement.appendChild(option);
                });
        }

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±–æ—Ä
        if (currentSelectedValue && selectElement.querySelector(`option[value="${currentSelectedValue}"]`)) {
            selectElement.value = currentSelectedValue;
        } else {
            selectElement.value = "";
        }
    }


    // --- –§—É–Ω–∫—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∏ UI ---

    /** –†–µ–Ω–¥–µ—Ä–∏—Ç —Ç–∞–±–ª–∏—Ü—É API –∫–ª—é—á–µ–π */
    function renderKeyTable(keys) {
         if (!Array.isArray(keys)) {
             keyList.innerHTML = `<tr><td colspan="8" class="error-message">–û—à–∏–±–∫–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–µ–π.</td></tr>`;
             return;
         }
         // <<< –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±—Ä–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É `keys.length === 0` –∑–¥–µ—Å—å, —Ç.–∫. –æ–Ω–∞ –Ω–∏–∂–µ >>>

         // <<< –ò–°–ü–†–ê–í–õ–ï–ù–û: –û—á–∏—â–∞–µ–º –õ–Æ–ë–û–ï –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –≤–∫–ª—é—á–∞—è "–ó–∞–≥—Ä—É–∑–∫–∞..." >>>
         keyList.innerHTML = '';

         // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –ø—É—Å—Ç–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
         if (keys.length === 0) {
             const filtersActive = filterRoleSelect.value || filterObjectIdSelect.value || filterIsActiveSelect.value;
             keyList.innerHTML = `<tr><td colspan="8" style="text-align: center;">API –∫–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã${filtersActive ? ' (—Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤)' : ''}.</td></tr>`;
             return;
         }

        // <<< –ò–°–ü–†–ê–í–õ–ï–ù–û: –û—Ç–æ–±—Ä–∞–∂–∞–µ–º ObjectID, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∫–ª—é—á–∞ –Ω–∞–ø—Ä—è–º—É—é >>>
         keys.forEach(key => {
             const created = formatDateTime(key.created_at);
             const lastUsed = formatDateTime(key.last_used_at);
             const activeChecked = key.is_active ? 'checked' : '';
             const objIdText = key.object_id !== null ? key.object_id : '---'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–∞

             const activeSwitch = `
                 <label class="active-switch">
                     <input type="checkbox" class="active-toggle" data-id="${key.id}" ${activeChecked}>
                     <span class="slider"></span>
                 </label>
             `;

             const row = keyList.insertRow();
             row.dataset.id = key.id;
             row.innerHTML = `
                 <td>${key.id}</td>
                 <td>${key.description || '---'}</td>
                 <td>${key.role}</td>
                 <td>${objIdText}</td>
                 <td>${activeSwitch}</td>
                 <td title="${key.created_at || ''}">${created}</td>
                 <td title="${key.last_used_at || ''}">${lastUsed}</td>
                 <td class="actions">
                      <button class="edit-btn" data-id="${key.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                      <button class="delete-btn" data-id="${key.id}" data-description="${key.description || `ID ${key.id}`}" title="–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á">üóëÔ∏è</button>
                 </td>
             `;
         });
    }

    /** –û–±–Ω–æ–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π */
    function renderPagination() {
        // ... (–∫–æ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
         if (!paginationControls || !pageInfoSpan || !prevPageBtn || !nextPageBtn) return;
         const totalPages = Math.ceil(totalKeys / itemsPerPage);
         pageInfoSpan.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages} (–í—Å–µ–≥–æ: ${totalKeys})`;
         prevPageBtn.disabled = currentPage <= 1;
         nextPageBtn.disabled = currentPage >= totalPages;
         paginationControls.style.display = totalKeys > 0 && totalPages > 1 ? 'block' : 'none';
    }

    /** –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ —Ä–µ–Ω–¥–µ—Ä–∏—Ç –∫–ª—é—á–∏ —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */
    async function loadAndRenderKeys(page = 1) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ó–∞–≥—Ä—É–∑–∫–∞..." –≤ –¢–ê–ë–õ–ò–¶–ï, –∞ –Ω–µ –≤ –æ–±—â–µ–º —Ñ–∏–¥–±–µ–∫–µ
        keyList.innerHTML = `<tr><td colspan="8" class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–µ–π...</td></tr>`;
        // –û—á–∏—â–∞–µ–º –æ–±—â–∏–π —Ñ–∏–¥–±–µ–∫
        showListFeedback('');
        currentPage = page;
        const offset = (currentPage - 1) * itemsPerPage;

        const params = new URLSearchParams();
        params.append('limit', itemsPerPage);
        params.append('offset', offset);
        if (filterRoleSelect.value) params.append('role', filterRoleSelect.value);
        if (filterObjectIdSelect.value) params.append('object_id', filterObjectIdSelect.value);
        if (filterIsActiveSelect.value) params.append('is_active', filterIsActiveSelect.value);

        try {
            const url = `${API_URL_KEYS}?${params.toString()}`;
            // –í—ã–∑—ã–≤–∞–µ–º fetchData –±–µ–∑ –ø–æ–∫–∞–∑–∞ "–ó–∞–≥—Ä—É–∑–∫–∞..." –≤ listFeedback
            const result = await fetchData(url); // fetchData —Å–∞–º–∞ –æ—á–∏—Å—Ç–∏—Ç listFeedback –ø—Ä–∏ —É—Å–ø–µ—Ö–µ GET
            apiKeysCache = (result && result.items) ? result.items : [];
            totalKeys = (result && result.total_count !== undefined) ? result.total_count : apiKeysCache.length;
            renderKeyTable(apiKeysCache); // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É (–æ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤)
            renderPagination();
            // showListFeedback(''); // –£–∂–µ –æ—á–∏—â–µ–Ω–æ –≤ fetchData
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ API –∫–ª—é—á–µ–π:", error);
            // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∂–µ—Ç—Å—è –≤ listFeedback –∏–∑ fetchData
            keyList.innerHTML = `<tr><td colspan="8" class="error-message">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª—é—á–∏.</td></tr>`;
            renderPagination(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é —Å 0 –∑–∞–ø–∏—Å–µ–π
        }
    }

    /** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ–∫—Ü–∏—é —Å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–ª—é—á–æ–º */
    function displayGeneratedKey(apiKey) {
        generatedApiKeyElement.textContent = apiKey;
        generatedKeySection.style.display = 'block';
        generatedKeySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º—ã ---
    /** –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞ */
    function resetForm() {
        form.reset(); // –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π
        editKeyIdInput.value = ''; currentEditKeyId = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º ID —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        formTitle.textContent = '–°–æ–∑–¥–∞—Ç—å –ù–æ–≤—ã–π API –ö–ª—é—á'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –ö–ª—é—á'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
        submitBtn.disabled = false; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        cancelBtn.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –û—Ç–º–µ–Ω–∞
        isActiveGroup.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å Active
        // objectIdSelect.disabled = false; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç, –µ—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏
        clearValidationErrors(); // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        showFormFeedback(''); // –û—á–∏—â–∞–µ–º –æ–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
        generatedKeySection.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å –∫–ª—é—á–æ–º
    }

    /**
     * –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
     * @param {object} apiKeyData - –û–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞ (–∏–∑ API –∏–ª–∏ –∫—ç—à–∞).
     */
    function fillFormForEdit(apiKeyData) {
        resetForm(); // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        currentEditKeyId = apiKeyData.id;
        editKeyIdInput.value = apiKeyData.id; // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ ID
        formTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å API –ö–ª—é—á ID: ${apiKeyData.id}`;
        submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        cancelBtn.style.display = 'inline-block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –û—Ç–º–µ–Ω–∞
        isActiveGroup.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å Active

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
        descriptionInput.value = apiKeyData.description || '';
        roleSelect.value = apiKeyData.role || '';
        objectIdSelect.value = apiKeyData.object_id !== null ? apiKeyData.object_id : ''; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç
        isActiveCheckbox.checked = apiKeyData.is_active === true;

        // –ú–æ–∂–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏/object_id, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        // roleSelect.disabled = true;
        // objectIdSelect.disabled = true;

        generatedKeySection.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å –∫–ª—é—á–æ–º
        form.scrollIntoView({ behavior: 'smooth', block: 'start' }); // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ñ–æ—Ä–º–µ
    }

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---

    /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã (—Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ) */
    async function handleFormSubmit(event) {
        event.preventDefault();
        clearValidationErrors();
        showFormFeedback('');
        generatedKeySection.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞
        submitBtn.disabled = true;
        submitBtn.textContent = currentEditKeyId ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ–∑–¥–∞–Ω–∏–µ...';

        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
        const formData = {
            description: descriptionInput.value.trim(),
            role: roleSelect.value, // –†–æ–ª—å –±–µ—Ä–µ–º –∏–∑ —Å–µ–ª–µ–∫—Ç–∞
            object_id: objectIdSelect.value ? parseInt(objectIdSelect.value, 10) : null // ObjectID –±–µ—Ä–µ–º –∏–∑ —Å–µ–ª–µ–∫—Ç–∞
        };

        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
        if (currentEditKeyId) {
            formData.is_active = isActiveCheckbox.checked;
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
        let clientErrors = {};
        if (!formData.description) clientErrors.description = '–û–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.';
        if (!currentEditKeyId && !formData.role) clientErrors.role = '–†–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏.';
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ object_id –Ω–µ –Ω—É–∂–Ω–∞, —Ç.–∫. –∏—Å–ø–æ–ª—å–∑—É–µ–º select

        if (Object.keys(clientErrors).length > 0) {
            displayValidationErrors(clientErrors);
            submitBtn.disabled = false; submitBtn.textContent = currentEditKeyId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å –ö–ª—é—á';
            return;
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL –∏ –º–µ—Ç–æ–¥
        const url = currentEditKeyId ? API_URL_KEY_DETAIL_TPL.replace('/0', `/${currentEditKeyId}`) : API_URL_KEYS;
        const method = currentEditKeyId ? 'PUT' : 'POST';

        // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —É–¥–∞–ª—è–µ–º —Ä–æ–ª—å –∏–∑ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω–∞ –ø—É—Å—Ç–∞—è (—á—Ç–æ–±—ã –Ω–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å–ª—É—á–∞–π–Ω–æ)
        if (currentEditKeyId && !formData.role) {
            delete formData.role;
        }

        try {
            const result = await fetchData(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            if (method === 'POST' && result && result.api_key) { // –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ
                 displayGeneratedKey(result.api_key);
                 form.reset(); // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                 showListFeedback('–ö–ª—é—á —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –ù–µ –∑–∞–±—É–¥—å—Ç–µ –µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.', false);
                 await loadAndRenderKeys(1); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É (–ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ 1 —Å—Ç—Ä–∞–Ω–∏—Ü—É)
            } else if (method === 'PUT') { // –£—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                 showListFeedback(`–ö–ª—é—á ID ${currentEditKeyId} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω.`, false);
                 resetForm(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                 await loadAndRenderKeys(currentPage); // –û–±–Ω–æ–≤–ª—è–µ–º –¢–ï–ö–£–©–£–Æ —Å—Ç—Ä–∞–Ω–∏—Ü—É
            } else if (method === 'POST') { // –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è (API –Ω–µ –≤–µ—Ä–Ω—É–ª –∫–ª—é—á)
                 throw new Error("API –Ω–µ –≤–µ—Ä–Ω—É–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á.");
            }

        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ ${method} API –∫–ª—é—á–∞:`, error);
            displayValidationErrors(error.details); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
            showFormFeedback(`–û—à–∏–±–∫–∞: ${error.message}`, true); // –û–±—â–∞—è –æ—à–∏–±–∫–∞ —Ñ–æ—Ä–º—ã
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = currentEditKeyId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å –ö–ª—é—á';
        }
    }

    /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–ª—é—á–∞ */
    async function handleToggleActive(keyId, isActive) {
        showListFeedback(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–ª—é—á–∞ ID ${keyId}...`);
        const url = API_URL_KEY_DETAIL_TPL.replace('/0', `/${keyId}`);
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
            await fetchData(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_active: isActive })
            });
            showListFeedback(`–°—Ç–∞—Ç—É—Å –∫–ª—é—á–∞ ID ${keyId} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω.`, false);
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
            const keyInCache = apiKeysCache.find(k => k.id === keyId);
            if (keyInCache) keyInCache.is_active = isActive;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∫–ª—é—á–∞:", error);
            showListFeedback(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${error.message}`, true);
            // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å
            const checkbox = keyList.querySelector(`.active-toggle[data-id="${keyId}"]`);
            if (checkbox) checkbox.checked = !isActive;
        }
    }

    /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ */
    async function handleDeleteClick(keyId, description) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å API –∫–ª—é—á "${description}" (ID: ${keyId})? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) return;
        showListFeedback(`–£–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ ID ${keyId}...`);
        const url = API_URL_KEY_DETAIL_TPL.replace('/0', `/${keyId}`);
        try {
            await fetchData(url, { method: 'DELETE' }); // –û–∂–∏–¥–∞–µ–º 204 No Content
            showListFeedback(`–ö–ª—é—á ID ${keyId} "${description}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.`, false);
            // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –∫–ª—é—á, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            if (currentEditKeyId === keyId) { resetForm(); }
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¢–ï–ö–£–©–£–Æ —Å—Ç—Ä–∞–Ω–∏—Ü—É (–∏–ª–∏ –ø–µ—Ä–≤—É—é, –µ—Å–ª–∏ –Ω–∞ —Ç–µ–∫—É—â–µ–π –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤?)
            // –ü—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â—É—é
            await loadAndRenderKeys(currentPage);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–∞:", error);
            // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ –≤ fetchData
        }
    }

     /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ */
     function handleEditClick(keyId) {
         const keyData = apiKeysCache.find(k => k.id === keyId); // –ò—â–µ–º –≤ –∫—ç—à–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
         if (keyData) {
             fillFormForEdit(keyData); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
         } else {
             // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ –∫—ç—à–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏/–ø–∞–≥–∏–Ω–∞—Ü–∏–∏),
             // –Ω—É–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∏—Ö –æ—Ç–¥–µ–ª—å–Ω–æ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç—É –ª–æ–≥–∏–∫—É –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
             console.error(`–î–∞–Ω–Ω—ã–µ –¥–ª—è –∫–ª—é—á–∞ ${keyId} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫—ç—à–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.`);
             showListFeedback(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞ ${keyId}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫.`, true);
         }
     }

     // <<< –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤ >>>
    async function loadSelectData() {
        showListFeedback("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤...");
        try {
            const subdivisionsRes = await fetchData(API_URL_SUBDIVISIONS + '?limit=1000'); // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
            subdivisionsCache = (subdivisionsRes && subdivisionsRes.items) ? subdivisionsRes.items : [];

            console.log("Subdivisions loaded for selects:", subdivisionsCache); // –õ–æ–≥ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç –≤ —Ñ–æ—Ä–º–µ (–∑–Ω–∞—á–µ–Ω–∏–µ - object_id, —Ç–µ–∫—Å—Ç - short_name + OID)
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º textField='short_name' –∏ valueField='object_id'
            // –¢—Ä–µ—Ç–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä textfield –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–µ—Ä–∞—Ä—Ö–∏–∏, –æ–Ω–∞ –±–µ—Ä–µ—Ç short_name
            populateSelect(objectIdSelect, subdivisionsCache, 'object_id', 'short_name', '-- –ù–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å --', true);

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç –≤ —Ñ–∏–ª—å—Ç—Ä–µ (–∑–Ω–∞—á–µ–Ω–∏–µ - object_id, —Ç–µ–∫—Å—Ç - short_name + OID)
            // –ë–µ–∑ –∏–µ—Ä–∞—Ä—Ö–∏–∏
            populateSelect(filterObjectIdSelect, subdivisionsCache, 'object_id', 'short_name', '–í—Å–µ –æ–±—ä–µ–∫—Ç—ã', false);

            showListFeedback(""); // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
        } catch (error) {
             console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤:", error);
             // –û—à–∏–±–∫–∞ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–∞ –≤ fetchData
             // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
             // showListFeedback("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤.", true);
        }
    }


    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
    /** –ó–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è) –∏ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–ª—é—á–µ–π */
    async function initializePage() {
         // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∂–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ
         keyList.innerHTML = `<tr><td colspan="8" class="loading-message">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</td></tr>`;
         try {
             await loadSelectData(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤
             await loadAndRenderKeys(1); // –ó–∞—Ç–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–ª—é—á–µ–π
         } catch(e) {
              // –û—à–∏–±–∫–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏ –≤—ã–≤–µ–¥–µ–Ω—ã –≤ loadSelectData –∏ loadAndRenderKeys
              console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
              // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤ —Ç–∞–±–ª–∏—Ü–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –∞ –Ω–µ "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è"
              if (!keyList.querySelector('.error-message')) {
                   keyList.innerHTML = `<tr><td colspan="8" class="error-message">–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.</td></tr>`;
              }
         }
    }

    // --- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π ---
    form.addEventListener('submit', handleFormSubmit);
    copyKeyBtn.addEventListener('click', () => copyToClipboard(generatedApiKeyElement.textContent));
    closeGeneratedKeyBtn.addEventListener('click', () => generatedKeySection.style.display = 'none');
    // –ö–Ω–æ–ø–∫–∞ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
    applyFiltersBtn.addEventListener('click', () => loadAndRenderKeys(1));
    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    cancelBtn.addEventListener('click', resetForm);

    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
    keyList.addEventListener('change', (event) => {
        if (event.target.classList.contains('active-toggle')) {
            const keyId = parseInt(event.target.dataset.id, 10);
            const isActive = event.target.checked;
            handleToggleActive(keyId, isActive);
        }
    });
    keyList.addEventListener('click', (event) => {
        const deleteBtn = event.target.closest('.delete-btn');
        const editBtn = event.target.closest('.edit-btn');
        if (deleteBtn) {
            handleDeleteClick(parseInt(deleteBtn.dataset.id, 10), deleteBtn.dataset.description);
        } else if (editBtn) {
             handleEditClick(parseInt(editBtn.dataset.id, 10));
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    prevPageBtn.addEventListener('click', () => { if (currentPage > 1) loadAndRenderKeys(currentPage - 1); });
    nextPageBtn.addEventListener('click', () => { if (currentPage * itemsPerPage < totalKeys) loadAndRenderKeys(currentPage + 1); });

    // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    document.addEventListener('DOMContentLoaded', initializePage);

</script>
{% endblock %}