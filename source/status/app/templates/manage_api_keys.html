<!-- status/app/templates/manage_api_keys.html -->
{# –ù–∞—Å–ª–µ–¥—É–µ–º –±–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—é #}
{% extends "base.html" %}

{# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —ç—Ç–æ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã #}
{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –ö–ª—é—á–∞–º–∏ - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ü–¢–ö{% endblock %}

{# –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ CSS —Å—Ç–∏–ª–∏ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –±–ª–æ–∫ head_extra –±–∞–∑–æ–≤–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ #}
{% block head_extra %}
<style>
    /* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ —Å–µ–∫—Ü–∏–π --- */
    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–π –Ω–∞ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏: —Ñ–æ—Ä–º–∞ —Å–ª–µ–≤–∞, —Å–ø–∏—Å–æ–∫ —Å–ø—Ä–∞–≤–∞ */
    .manage-container { display: grid; grid-template-columns: minmax(350px, 1fr) 2fr; gap: 2rem; align-items: start; margin-top: 1rem; }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ (—Å–µ–∫—Ü–∏–π) */
    .form-section, .list-section { background-color: var(--card-bg); padding: 1.5rem; border-radius: 5px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); }
    /* –î–µ–ª–∞–µ–º —Ñ–æ—Ä–º—É "–ª–∏–ø–∫–æ–π" –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ */
    .form-section { position: sticky; top: 80px; }
    /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–µ–∫—Ü–∏–π */
    .form-section h3, .list-section h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 0.8rem; margin-bottom: 1rem; }

    /* --- –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—ã --- */
    .form-group { margin-bottom: 1rem; } /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏ –ø–æ–ª–µ–π */
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.95em; } /* –õ–µ–π–±–ª—ã */
    .form-group input[type="text"],
    .form-group input[type="number"], /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è */
    .form-group select {
        width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em;
    } /* –ü–æ–ª—è –≤–≤–æ–¥–∞ –∏ —Å–µ–ª–µ–∫—Ç—ã */
    .form-actions { margin-top: 1.5rem; text-align: right; display: flex; justify-content: flex-end; gap: 0.5rem; } /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–æ—Ä–º—ã */
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–µ–π–±–ª–∞ –∏ —á–µ–∫–±–æ–∫—Å–∞ "–ê–∫—Ç–∏–≤–µ–Ω" */
    .form-group label.checkbox-label { display: inline-block; margin-left: 5px; font-weight: normal; cursor: pointer; vertical-align: middle;}
    .form-group input[type="checkbox"] { width: auto; vertical-align: middle;}

    /* --- –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–µ–π --- */
    .filter-controls { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 1.5rem; padding: 1rem; background-color: #f8f9fa; border: 1px solid var(--border-color); border-radius: 4px; }
    .filter-group { display: flex; flex-direction: column; } /* –ì—Ä—É–ø–ø–∞: –ª–µ–π–±–ª + –ø–æ–ª–µ */
    .filter-group label { margin-bottom: 5px; font-size: 0.9em; font-weight: 500; }
    .filter-controls select, .filter-controls input[type="number"] { /* –£—Ç–æ—á–Ω–µ–Ω–æ –¥–ª—è object_id */
        padding: 6px 8px; font-size: 0.95em; border-radius: 3px; border: 1px solid #ccc; min-width: 150px;
    }
    #apply-filters-btn { align-self: flex-end; padding: 6px 15px; } /* –ö–Ω–æ–ø–∫–∞ –ü—Ä–∏–º–µ–Ω–∏—Ç—å */

    /* --- –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –∫–ª—é—á–µ–π --- */
    .keys-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .keys-table th, .keys-table td { border: 1px solid var(--border-color); padding: 8px 12px; text-align: left; vertical-align: middle; }
    .keys-table th { background-color: var(--light-grey); font-weight: 600; white-space: nowrap; }
    .keys-table .actions { text-align: center; white-space: nowrap; width: 100px; } /* –ö–æ–ª–æ–Ω–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π */
    .keys-table .actions button { padding: 4px 8px; font-size: 0.9em; cursor: pointer; border: none; border-radius: 3px; color: white; margin: 2px; }
    .keys-table .edit-btn { background-color: var(--warning-color); color: #333; }
    .keys-table .edit-btn:hover { background-color: #e0a800; }
    .keys-table .delete-btn { background-color: var(--danger-color); }
    .keys-table .delete-btn:hover { background-color: #c82333; }

    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å—Ç–∞—Ç—É—Å–∞ "–ê–∫—Ç–∏–≤–µ–Ω" (–∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ) */
    .active-switch { display: inline-block; position: relative; width: 40px; height: 20px; vertical-align: middle; }
    .active-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--success-color); }
    input:focus + .slider { box-shadow: 0 0 1px var(--success-color); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* --- –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–∫—Ü–∏–∏ –ø–æ–∫–∞–∑–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞ --- */
    #generated-key-section { margin-top: 1.5rem; padding: 1rem; border: 1px solid var(--warning-color); background-color: #fff9e6; border-radius: 5px; display: none; /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–æ */ }
    #generated-key-section h4 { margin-top: 0; color: #856404; }
    #generated-api-key { font-family: monospace; font-size: 1.1em; word-break: break-all; background-color: #fff; padding: 8px; border: 1px dashed #ccc; border-radius: 3px; display: inline-block; margin-right: 10px; user-select: all; }
    .copy-key-btn { padding: 5px 10px; font-size: 0.9em; vertical-align: middle;}

    /* --- –°—Ç–∏–ª–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (–æ–±—â–∏–µ) --- */
    .pagination-controls { margin-top: 1.5rem; text-align: center; }
    .pagination-controls button, .pagination-controls span { display: inline-block; padding: 5px 10px; margin: 0 3px; border: 1px solid #ccc; border-radius: 3px; background-color: #fff; cursor: pointer; font-size: 0.9em; }
    .pagination-controls button:disabled { background-color: #eee; color: #aaa; cursor: not-allowed; }
    .pagination-controls span.current-page { background-color: var(--primary-color); color: white; border-color: var(--primary-color); cursor: default; }

    /* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π (feedback) –∏ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ --- */
    .feedback-area { min-height: 1.5em; margin-top: 1rem; font-weight: 500; padding: 5px; border-radius: 3px; text-align: center; }
    .feedback-area.error-feedback { color: var(--danger-color); background-color: #f8d7da; border: 1px solid #f5c6cb; }
    .feedback-area.success-feedback { color: var(--success-color); background-color: #d4edda; border: 1px solid #c3e6cb;}
    .error-feedback { /* –î–ª—è –æ—à–∏–±–æ–∫ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ */
        color: var(--danger-color); font-size: 0.9em; margin-top: 5px; display: block; min-height: 1em;
    }
    /* –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ –≤ —Ç–∞–±–ª–∏—Ü–µ */
    .loading-message { text-align: center; padding: 1em; color: var(--secondary-color); font-style: italic; }
    .error-message { color: var(--danger-color); font-weight: bold; text-align: center; padding: 1em;}
</style>
{% endblock %}

{# –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã #}
{% block content %}
<h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –ö–ª—é—á–∞–º–∏</h2>

{# –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ layout —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏) #}
<div class="manage-container">

    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞ -->
    <section class="form-section">
        <h3 id="form-title">–°–æ–∑–¥–∞—Ç—å –ù–æ–≤—ã–π API –ö–ª—é—á</h3>
        <form id="api-key-form">
            {# –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID –∫–ª—é—á–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è #}
            <input type="hidden" id="edit-key-id">

            <div class="form-group">
                <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
                <input type="text" id="description" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –û–Ω–ª–∞–π–Ω –∞–≥–µ–Ω—Ç –¥–ª—è –ü–£">
                <div class="error-feedback" id="description-error"></div>
            </div>

            <div class="form-group">
                <label for="role">–†–æ–ª—å *</label>
                <select id="role" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å --</option>
                    <option value="agent">agent (–ê–≥–µ–Ω—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)</option>
                    <option value="loader">loader (–ó–∞–≥—Ä—É–∑—á–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)</option>
                    <option value="configurator">configurator (–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä –∞–≥–µ–Ω—Ç–æ–≤)</option>
                    <option value="admin">admin (–ü–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∞, –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                </select>
                 <div class="error-feedback" id="role-error"></div>
            </div>

            <div class="form-group">
                <label for="object-id">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é (–ø–æ ObjectID, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <select id="object-id">
                    <option value="">-- –ù–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å --</option>
                    {# –û–ø—Ü–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ–ª–µ–∫—Ç–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å –ø–æ–º–æ—â—å—é JavaScript #}
                </select>
                 <div class="error-feedback" id="object-id-error"></div>
            </div>

            {# –ß–µ–∫–±–æ–∫—Å "–ê–∫—Ç–∏–≤–µ–Ω", –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª—é—á–∞ #}
             <div class="form-group" id="is-active-group" style="display: none;">
                <label class="checkbox-label">
                    <input type="checkbox" id="is-active"> –ê–∫—Ç–∏–≤–µ–Ω
                </label>
             </div>

            {# –û–±–ª–∞—Å—Ç—å –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç API) –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± —É—Å–ø–µ—Ö–µ #}
            <div id="form-feedback" class="feedback-area"></div>

            {# –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π —Ñ–æ—Ä–º—ã #}
            <div class="form-actions">
                <button type="button" id="cancel-edit-btn" style="display: none; background-color: var(--secondary-color);">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" id="submit-key-btn">–°–æ–∑–¥–∞—Ç—å –ö–ª—é—á</button>
            </div>
        </form>

        <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ API-–∫–ª—é—á–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è -->
        <div id="generated-key-section">
            <h4>‚úÖ API –ö–ª—é—á –£—Å–ø–µ—à–Ω–æ –°–æ–∑–¥–∞–Ω!</h4>
            <p style="color: var(--danger-color); font-weight: bold;">
                –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á —Å–µ–π—á–∞—Å. –û–Ω –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω.
            </p>
            <div style="margin-bottom: 10px;">
                 <code id="generated-api-key"></code> {# –°—é–¥–∞ JavaScript –≤—Å—Ç–∞–≤–∏—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á #}
                 <button type="button" class="copy-key-btn" id="copy-key-btn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <button type="button" id="close-generated-key-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </section>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö API-–∫–ª—é—á–µ–π -->
    <section class="list-section">
        <h3>–°–ø–∏—Å–æ–∫ –°—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ö–ª—é—á–µ–π</h3>

        <!-- –ë–ª–æ–∫ —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π —Ç–∞–±–ª–∏—Ü—ã -->
        <div class="filter-controls">
             <div class="filter-group">
                 <label for="filter-role">–§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–ª–∏:</label>
                 <select id="filter-role">
                     <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                     <option value="agent">agent</option>
                     <option value="loader">loader</option>
                     <option value="configurator">configurator</option>
                     <option value="admin">admin</option>
                 </select>
             </div>
             <div class="filter-group">
                 <label for="filter-object-id">–§–∏–ª—å—Ç—Ä –ø–æ Object ID:</label>
                 <select id="filter-object-id"> {# –ò–∑–º–µ–Ω–µ–Ω input –Ω–∞ select –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö #}
                     <option value="">–í—Å–µ –æ–±—ä–µ–∫—Ç—ã</option>
                     {# –û–ø—Ü–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ–ª–µ–∫—Ç–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ #}
                 </select>
             </div>
             <div class="filter-group">
                 <label for="filter-is-active">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É:</label>
                 <select id="filter-is-active">
                     <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                     <option value="true">–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                     <option value="false">–¢–æ–ª—å–∫–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                 </select>
             </div>
             <button id="apply-filters-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
        </div>

        {# –û–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–± —É—Å–ø–µ—Ö–µ —É–¥–∞–ª–µ–Ω–∏—è) #}
        <div id="list-feedback" class="feedback-area"></div>

        <table class="keys-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th>–†–æ–ª—å</th>
                    <th>Object ID</th>
                    <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                    <th>–°–æ–∑–¥–∞–Ω</th>
                    <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="key-list">
                <!-- –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ -->
                <tr><td colspan="8" class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ API –∫–ª—é—á–µ–π...</td></tr>
            </tbody>
        </table>

        <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç—ã -->
        <div class="pagination-controls" id="pagination-controls" style="display: none;">
            <button id="prev-page" disabled>¬´ –ù–∞–∑–∞–¥</button>
            <span id="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ - –∏–∑ -</span>
            <button id="next-page" disabled>–í–ø–µ—Ä–µ–¥ ¬ª</button>
        </div>
    </section>
</div>
{% endblock %}

{# –ë–ª–æ–∫ –¥–ª—è JavaScript –∫–æ–¥–∞, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–≥–æ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã #}
{% block scripts %}
<script>
    // --- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM ---
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const apiKeyForm = document.getElementById('api-key-form');
    const formTitleElement = document.getElementById('form-title');
    const submitButton = document.getElementById('submit-key-btn');
    const cancelButton = document.getElementById('cancel-edit-btn');
    const hiddenEditKeyIdInput = document.getElementById('edit-key-id');
    const descriptionInputElement = document.getElementById('description');
    const roleSelectElement = document.getElementById('role');
    const objectIdSelectElement = document.getElementById('object-id'); // –°–µ–ª–µ–∫—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ Object ID
    const isActiveGroupElement = document.getElementById('is-active-group');
    const isActiveCheckboxElement = document.getElementById('is-active');
    const formFeedbackElement = document.getElementById('form-feedback');

    // –≠–ª–µ–º–µ–Ω—Ç—ã —Å–µ–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞
    const generatedKeySectionElement = document.getElementById('generated-key-section');
    const generatedApiKeyDisplayElement = document.getElementById('generated-api-key');
    const copyKeyButton = document.getElementById('copy-key-btn');
    const closeGeneratedKeyButton = document.getElementById('close-generated-key-btn');

    // –≠–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞ –∫–ª—é—á–µ–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞–º–∏/–ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
    const keyListTableBody = document.getElementById('key-list');
    const listFeedbackElement = document.getElementById('list-feedback');
    const filterRoleSelectElement = document.getElementById('filter-role');
    const filterObjectIdSelectElement = document.getElementById('filter-object-id'); // –°–µ–ª–µ–∫—Ç –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ Object ID
    const filterIsActiveSelectElement = document.getElementById('filter-is-active');
    const applyFiltersButton = document.getElementById('apply-filters-btn');
    const paginationControlsElement = document.getElementById('pagination-controls');
    const prevPageButton = document.getElementById('prev-page');
    const nextPageButton = document.getElementById('next-page');
    const pageInfoSpanElement = document.getElementById('page-info');

    // --- URL API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è Flask) ---
    const API_URL_KEYS_CRUD = "{{ url_for('api_keys.get_api_keys_route') }}"; // –î–ª—è GET (—Å–ø–∏—Å–æ–∫) –∏ POST (—Å–æ–∑–¥–∞–Ω–∏–µ)
    const API_URL_KEY_DETAIL_TEMPLATE = "{{ url_for('api_keys.update_api_key_route', key_id=0) }}"; // –®–∞–±–ª–æ–Ω –¥–ª—è PUT/DELETE –ø–æ ID
    const API_URL_SUBDIVISIONS_LIST = "{{ url_for('subdivisions.api_get_subdivisions') }}"; // –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π

    // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
    let currentApiKeysCache = [];    // –ö—ç—à –∫–ª—é—á–µ–π, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏)
    let allSubdivisionsCache = [];   // –ö—ç—à –≤—Å–µ—Ö –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π (–¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ–≤)
    let currentEditingKeyId = null;  // ID –∫–ª—é—á–∞, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç (null, –µ—Å–ª–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π)
    let listCurrentPage = 1;         // –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –∫–ª—é—á–µ–π
    let listItemsPerPage = 15;       // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    let listTotalKeys = 0;           // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π (—Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤)

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

    /**
     * –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ API.
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ HTTP-–æ—à–∏–±–∫–∏ –∏ –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ JSON.
     * @param {string} url - URL API-—ç–Ω–¥–ø–æ–∏–Ω—Ç–∞.
     * @param {object} [options={}] - –û–ø—Ü–∏–∏ –¥–ª—è `fetch` (method, headers, body).
     * @returns {Promise<object|null>} - Promise, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è —Å —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–º JSON-–æ—Ç–≤–µ—Ç–æ–º
     *                                   –∏–ª–∏ `null` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –æ—Ç–≤–µ—Ç–∞ 204 No Content).
     * @throws {Error} - –ö–∞—Å—Ç–æ–º–Ω—ã–π –æ–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏ —Å –ø–æ–ª—è–º–∏ `message`, `details`, `code`, `status`
     *                   –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏, HTTP-–æ—à–∏–±–∫–∏ –∏–ª–∏ –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON.
     */
    async function fetchDataApi(url, options = {}) {
        const method = options.method ? options.method.toUpperCase() : 'GET';
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º —Ç–æ–ª—å–∫–æ –¥–ª—è GET-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Å–ø–∏—Å–∫—É –∫–ª—é—á–µ–π
        if (method === 'GET' && url.startsWith(API_URL_KEYS_CRUD)) {
            showListFeedbackMessage('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
        }
        try {
            const response = await fetch(url, options);
            if (!response.ok) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ HTTP-–æ—à–∏–±–æ–∫ (—Å—Ç–∞—Ç—É—Å—ã 4xx, 5xx)
                let errorText = `–û—à–∏–±–∫–∞ API: ${response.status} ${response.statusText}`;
                let errorDetails = null;
                let errorCode = 'NETWORK_ERROR'; // –ö–æ–¥ –æ—à–∏–±–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                try { // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ –∏–∑ JSON-–æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
                    const errorData = await response.json();
                    if (errorData && errorData.error) {
                        errorCode = errorData.error.code || 'API_ERROR_UNKNOWN_CODE';
                        errorText = errorData.error.message || errorText; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
                        errorDetails = errorData.error.details || errorData.error.message || errorData.error;
                    } else if (errorData && typeof errorData === 'string') { // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∞
                        errorText = errorData; errorDetails = errorData;
                    } else { errorDetails = errorData; }
                } catch (e_json) { /* –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON-–æ—Ç–≤–µ—Ç–∞ —Å –æ—à–∏–±–∫–æ–π - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π errorText */
                    try { const rawText = await response.text(); if(rawText) errorDetails = rawText; } catch(e_text){}
                }
                const error = new Error(errorText);
                error.details = errorDetails; error.code = errorCode; error.status = response.status;
                throw error; // –í—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –æ—à–∏–±–∫—É
            }

            // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å GET –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Å–ø–∏—Å–∫—É –±—ã–ª —É—Å–ø–µ—à–Ω—ã–º, –æ—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
            if (method === 'GET' && url.startsWith(API_URL_KEYS_CRUD)) {
                showListFeedbackMessage('');
            }

            if (response.status === 204) return null; // –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ —Ç–µ–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, DELETE)

            const responseText = await response.text(); // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç
            try { // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
                return responseText ? JSON.parse(responseText) : null;
            } catch (e_parse) {
                console.warn("fetchDataApi: –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –∏–∑ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:", responseText, e_parse);
                return { _rawResponseText: responseText }; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å, –µ—Å–ª–∏ –Ω–µ JSON
            }
        } catch (error) { // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –æ—à–∏–±–∫–∏, —Ç–∞–∫ –∏ –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏ (fetch rejected)
            console.error(`–û—à–∏–±–∫–∞ fetchDataApi –¥–ª—è URL: ${url}`, error);
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—à–∏–±–∫—É –≤ –æ–±—â–µ–º —Ñ–∏–¥–±–µ–∫–µ –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º
            showListFeedbackMessage(`–û—à–∏–±–∫–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏.'}`, true);
            throw error; // –ü–µ—Ä–µ–¥–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –≤—ã–∑—ã–≤–∞—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
        }
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã.
     * @param {object|string} errors - –û–±—ä–µ–∫—Ç {field_name: message} –∏–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å –æ–±—â–µ–π –æ—à–∏–±–∫–æ–π.
     * @param {string} [formFeedbackElementId='form-feedback'] - ID —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã.
     * @param {string} [fieldErrorSuffix='-error'] - –°—É—Ñ—Ñ–∏–∫—Å –¥–ª—è ID —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –æ—à–∏–±–æ–∫ –ø–æ–ª–µ–π.
     */
    function displayFormValidationErrors(errors, formFeedbackElementId = 'form-feedback', fieldErrorSuffix = '-error') {
        clearFormValidationErrors(formFeedbackElementId, fieldErrorSuffix); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ
        const generalFeedbackElement = document.getElementById(formFeedbackElementId);
        let firstInvalidFieldElement = null;

        if (typeof errors === 'string') { // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å –æ–±—â–µ–π –æ—à–∏–±–∫–æ–π
            if (generalFeedbackElement) showFeedback(generalFeedbackElement, errors, true);
        } else if (errors && typeof errors === 'object') { // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –æ–±—ä–µ–∫—Ç {–ø–æ–ª–µ: —Å–æ–æ–±—â–µ–Ω–∏–µ}
            let hasFieldSpecificErrors = false;
            for (const fieldName in errors) {
                const errorDisplayElement = document.getElementById(`${fieldName}${fieldErrorSuffix}`);
                const fieldInputElement = document.getElementById(fieldName); // –ò—â–µ–º —Å–∞–º–æ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                if (errorDisplayElement) {
                    errorDisplayElement.textContent = errors[fieldName];
                    if (fieldInputElement) {
                        fieldInputElement.classList.add('invalid'); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                        if (!firstInvalidFieldElement) firstInvalidFieldElement = fieldInputElement; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
                    }
                    hasFieldSpecificErrors = true;
                } else { // –ï—Å–ª–∏ –Ω–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –æ—à–∏–±–∫–∏ –ø–æ–ª—è, –≤—ã–≤–æ–¥–∏–º –≤ –æ–±—â–∏–π —Ñ–∏–¥–±–µ–∫
                    console.warn(`displayFormValidationErrors: –≠–ª–µ–º–µ–Ω—Ç –æ—à–∏–±–∫–∏ –¥–ª—è –ø–æ–ª—è '${fieldName}' (ID: ${fieldName}${fieldErrorSuffix}) –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
                    if (generalFeedbackElement) {
                        const p = document.createElement('p'); p.textContent = `${fieldName}: ${errors[fieldName]}`;
                        generalFeedbackElement.appendChild(p);
                        generalFeedbackElement.classList.add('error-feedback');
                    }
                }
            }
            // –ï—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏, –Ω–æ –Ω–µ –¥–ª—è –≤—Å–µ—Ö –Ω–∞—à–ª–∏—Å—å –ø–æ–ª—è, –∏–ª–∏ –±—ã–ª–∏ —Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ
            if (generalFeedbackElement && !hasFieldSpecificErrors && Object.keys(errors).length > 0 && !generalFeedbackElement.textContent) {
                showFeedback(generalFeedbackElement, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ.", true);
            }
        }
        if (firstInvalidFieldElement) firstInvalidFieldElement.focus(); // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–º –ø–æ–ª–µ —Å –æ—à–∏–±–∫–æ–π
    }

    /** –û—á–∏—â–∞–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–µ –∏ —É–±–∏—Ä–∞–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–ª–µ–π. */
    function clearFormValidationErrors(formFeedbackElementId = 'form-feedback', fieldErrorSuffix = '-error') {
        const generalFeedbackElement = document.getElementById(formFeedbackElementId);
        if (generalFeedbackElement) showFeedback(generalFeedbackElement, ''); // –û—á–∏—â–∞–µ–º –æ–±—â–∏–π —Ñ–∏–¥–±–µ–∫
        // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
        document.querySelectorAll(`#${apiKeyForm.id} .error-feedback`).forEach(el => el.textContent = '');
        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å 'invalid' —Å –ø–æ–ª–µ–π
        document.querySelectorAll(`#${apiKeyForm.id} input.invalid, #${apiKeyForm.id} select.invalid`)
                .forEach(el => el.classList.remove('invalid'));
    }

    /** –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ (–¥–ª—è —Ñ–∏–¥–±–µ–∫–∞ –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º –∏–ª–∏ –≤ —Ñ–æ—Ä–º–µ). */
    function showFeedback(element, message, isError = false) {
         if (!element) return;
         element.textContent = message;
         element.className = 'feedback-area'; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª–∞—Å—Å—ã
         if (message) { // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–ª–∞—Å—Å
             element.classList.add(isError ? 'error-feedback' : 'success-feedback');
         }
    }
    /** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º –∫–ª—é—á–µ–π. */
    function showListFeedbackMessage(message, isError = false) { showFeedback(listFeedbackElement, message, isError); }
    /** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥ —Ñ–æ—Ä–º–æ–π —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞. */
    function showFormFeedbackMessage(message, isError = false) { showFeedback(formFeedbackElement, message, isError); }

    /**
     * –ö–æ–ø–∏—Ä—É–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @param {string} textToCopy - –¢–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.
     */
    function copyTextToClipboard(textToCopy) {
        if (!navigator.clipboard) { // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ (–º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            textArea.style.position = "fixed"; // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try {
                document.execCommand('copy');
                showFormFeedbackMessage('–ö–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', false);
            } catch (err) {
                console.error('Fallback: –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä:', err);
                showFormFeedbackMessage('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.', true);
            }
            document.body.removeChild(textArea);
            return;
        }
        navigator.clipboard.writeText(textToCopy).then(function() {
            showFormFeedbackMessage('–ö–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', false);
        }, function(err) {
            console.error('Async: –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä:', err);
            showFormFeedbackMessage('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.', true);
        });
    }

    /**
     * –ó–∞–ø–æ–ª–Ω—è–µ—Ç HTMLSelectElement –æ–ø—Ü–∏—è–º–∏ –∏–∑ –º–∞—Å—Å–∏–≤–∞ –¥–∞–Ω–Ω—ã—Ö.
     * @param {HTMLSelectElement} selectEl - –¶–µ–ª–µ–≤–æ–π select-—ç–ª–µ–º–µ–Ω—Ç.
     * @param {Array<Object>} dataItems - –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø—Ü–∏–π.
     * @param {string} valueKey - –ò–º—è –ø–æ–ª—è –≤ –æ–±—ä–µ–∫—Ç–µ dataItems –¥–ª—è `option.value`.
     * @param {string} textKey - –ò–º—è –ø–æ–ª—è –≤ –æ–±—ä–µ–∫—Ç–µ dataItems –¥–ª—è `option.textContent`.
     * @param {string} placeholderText - –¢–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–≤–æ–π (–ø—É—Å—Ç–æ–π) –æ–ø—Ü–∏–∏.
     * @param {boolean} [useHierarchy=false] - –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, –Ω—É–∂–Ω–æ –ª–∏ —Å—Ç—Ä–æ–∏—Ç—å –∏–µ—Ä–∞—Ä—Ö–∏—é (–¥–ª—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π).
     *                                          –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç –Ω–∞–ª–∏—á–∏–µ `parent_id` –∏ `priority` –≤ –æ–±—ä–µ–∫—Ç–∞—Ö `dataItems`.
     * @param {number|null} [excludeItemId=null] - ID —ç–ª–µ–º–µ–Ω—Ç–∞ (–ø–æ `valueKey`), –∫–æ—Ç–æ—Ä—ã–π –∏ –≤—Å–µ—Ö –µ–≥–æ –ø–æ—Ç–æ–º–∫–æ–≤ –Ω—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å (–¥–ª—è –∏–µ—Ä–∞—Ä—Ö–∏–∏).
     */
    function populateSelectWithOptions(selectEl, dataItems, valueKey, textKey, placeholderText, useHierarchy = false, excludeItemId = null) {
        const currentSelectedVal = selectEl.value; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        selectEl.innerHTML = `<option value="">${placeholderText}</option>`; // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä

        if (!dataItems || dataItems.length === 0) {
            console.warn(`populateSelectWithOptions –¥–ª—è ${selectEl.id}: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.`);
            return;
        }

        if (useHierarchy) { // –õ–æ–≥–∏–∫–∞ –¥–ª—è –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–≥–æ —Å–ø–∏—Å–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è)
            const itemMap = {}; const rootItems = []; const excludedDescendantIds = new Set();
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è ID –≤—Å–µ—Ö –ø–æ—Ç–æ–º–∫–æ–≤ –∏—Å–∫–ª—é—á–∞–µ–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            function findDescendants(itemId) {
                if (!itemMap[itemId] || !itemMap[itemId].rawChildren) return;
                itemMap[itemId].rawChildren.forEach(childId => {
                    if (!excludedDescendantIds.has(childId)) { // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
                        excludedDescendantIds.add(childId);
                        findDescendants(childId);
                    }
                });
            }
            // –°—Ç—Ä–æ–∏–º –∫–∞—Ä—Ç—É —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –ø–µ—Ä–≤–∏—á–Ω—ã–µ —Å–≤—è–∑–∏ —Ä–æ–¥–∏—Ç–µ–ª—å-—Ä–µ–±–µ–Ω–æ–∫
            dataItems.forEach(item => { itemMap[item[valueKey]] = { ...item, rawChildren: [] }; });
            dataItems.forEach(item => {
                if (item.parent_id !== null && itemMap[item.parent_id]) {
                    itemMap[item.parent_id].rawChildren.push(item[valueKey]);
                }
            });

            // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç –∏ –µ–≥–æ –ø–æ—Ç–æ–º–∫–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏, —á—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å —Å–µ–±—è –∏–ª–∏ —Å–≤–æ–µ–≥–æ –ø–æ—Ç–æ–º–∫–∞ –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–æ–¥–∏—Ç–µ–ª—è)
            if (excludeItemId !== null) {
                excludedDescendantIds.add(excludeItemId); // –î–æ–±–∞–≤–ª—è–µ–º —Å–∞–º –∏—Å–∫–ª—é—á–∞–µ–º—ã–π —ç–ª–µ–º–µ–Ω—Ç
                findDescendants(excludeItemId);          // –ò –≤—Å–µ—Ö –µ–≥–æ –ø–æ—Ç–æ–º–∫–æ–≤
            }

            // –°—Ç—Ä–æ–∏–º –¥–µ—Ä–µ–≤–æ –¥–ª—è select'–∞, –∏—Å–∫–ª—é—á–∞—è –Ω–µ–Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            const selectTreeItemMap = {};
            dataItems.forEach(item => {
                const currentItemId = item[valueKey];
                if (!excludedDescendantIds.has(currentItemId)) { // –î–æ–±–∞–≤–ª—è–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –≤ —Å–ø–∏—Å–∫–µ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö
                    selectTreeItemMap[currentItemId] = { ...item, children: [] }; // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –¥–µ—Ç–µ–π
                    if (item.parent_id === null || !selectTreeItemMap[item.parent_id]) { // –ï—Å–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—è –Ω–µ—Ç –∏–ª–∏ –æ–Ω —Å–∞–º –∏—Å–∫–ª—é—á–µ–Ω
                         if (!rootItems.includes(currentItemId)) rootItems.push(currentItemId); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ—Ä–µ–Ω—å
                    } else if (selectTreeItemMap[item.parent_id]) { // –ï—Å–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—å –µ—Å—Ç—å –≤ –Ω–∞—à–µ–º –¥–µ—Ä–µ–≤–µ
                         selectTreeItemMap[item.parent_id].children.push(currentItemId); // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ —Ä–µ–±–µ–Ω–∫–∞
                    }
                }
            });

            // –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–π –≤ select
            function addOptionRecursive(itemId, indentLevel) {
                const itemData = selectTreeItemMap[itemId]; if (!itemData) return;
                const option = document.createElement('option');
                option.value = itemData[valueKey];
                const displayName = itemData.short_name || itemData[textKey]; // –ò—Å–ø–æ–ª—å–∑—É–µ–º short_name –¥–ª—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–µ—Ä–∞—Ä—Ö–∏–∏
                option.textContent = '\u00A0'.repeat(indentLevel * 3) + displayName +
                                     ` (ID: ${itemData.id}, OID: ${itemData.object_id || 'N/A'})`;
                selectEl.appendChild(option);
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É, –∑–∞—Ç–µ–º –ø–æ –∏–º–µ–Ω–∏) –∏ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
                itemData.children
                    .map(id => selectTreeItemMap[id]).filter(child => child) // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º null
                    .sort((a, b) => (a.priority || 999) - (b.priority || 999) || (a.short_name || a[textKey]).localeCompare(b.short_name || b[textKey]))
                    .forEach(child => addOptionRecursive(child.id, indentLevel + 1));
            }
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ—Ä–Ω–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
            rootItems
                .map(id => selectTreeItemMap[id]).filter(root => root)
                .sort((a, b) => (a.priority || 999) - (b.priority || 999) || (a.short_name || a[textKey]).localeCompare(b.short_name || b[textKey]))
                .forEach(root => addOptionRecursive(root.id, 0));
        } else { // –ü–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ (–¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ Object ID)
            dataItems
                .filter(item => item[valueKey] !== null && item[valueKey] !== undefined) // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
                .sort((a, b) => (a[textKey] || '').localeCompare(b[textKey] || '')) // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ç–µ–∫—Å—Ç—É
                .forEach(item => {
                    const option = document.createElement('option');
                    option.value = item[valueKey]; // –ó–¥–µ—Å—å valueKey –±—É–¥–µ—Ç 'object_id' –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
                    option.textContent = `${item[textKey]} (OID: ${item.object_id})`; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –∏ ObjectID
                    selectEl.appendChild(option);
                });
        }
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–Ω–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –≤—Å–µ –µ—â–µ –≤–∞–ª–∏–¥–Ω–æ
        if (currentSelectedVal && selectEl.querySelector(`option[value="${currentSelectedVal}"]`)) {
            selectEl.value = currentSelectedVal;
        } else {
            selectEl.value = ""; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä, –µ—Å–ª–∏ —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ
        }
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç–∞–±–ª–∏—Ü—ã –∏ UI ---

    /** –†–µ–Ω–¥–µ—Ä–∏—Ç —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ API-–∫–ª—é—á–µ–π. */
    function renderApiKeyTable(keys) {
         // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
         if (!Array.isArray(keys)) {
             keyListTableBody.innerHTML = `<tr><td colspan="8" class="error-message">–û—à–∏–±–∫–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–ª—é—á–µ–π.</td></tr>`;
             console.error("renderApiKeyTable: –û–∂–∏–¥–∞–ª—Å—è –º–∞—Å—Å–∏–≤, –ø–æ–ª—É—á–µ–Ω:", keys);
             return;
         }
         keyListTableBody.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ

         if (keys.length === 0) { // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –∫–ª—é—á–µ–π –ø—É—Å—Ç
             const filtersAreActive = filterRoleSelectElement.value || filterObjectIdSelectElement.value || filterIsActiveSelectElement.value;
             keyListTableBody.innerHTML = `<tr><td colspan="8" style="text-align: center;">API-–∫–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã${filtersAreActive ? ' (—Å —É—á–µ—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤)' : ''}.</td></tr>`;
             return;
         }

         keys.forEach(key => {
             const createdDateStr = formatDateTime(key.created_at);
             const lastUsedDateStr = formatDateTime(key.last_used_at);
             const isActiveCheckedAttr = key.is_active ? 'checked' : '';
             const objectIdDisplay = key.object_id !== null ? key.object_id : '---'; // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º --- –µ—Å–ª–∏ null

             // HTML –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
             const activeToggleHtml = `
                 <label class="active-switch" title="${key.is_active ? '–ö–ª—é—á –∞–∫—Ç–∏–≤–µ–Ω' : '–ö–ª—é—á –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω'}">
                     <input type="checkbox" class="active-toggle" data-id="${key.id}" ${isActiveCheckedAttr}>
                     <span class="slider"></span>
                 </label>
             `;

             const tableRow = keyListTableBody.insertRow(); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É
             tableRow.dataset.keyId = key.id; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∫–ª—é—á–∞ –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ —Å—Ç—Ä–æ–∫–∏
             // –ó–∞–ø–æ–ª–Ω—è–µ–º —è—á–µ–π–∫–∏ —Å—Ç—Ä–æ–∫–∏
             tableRow.innerHTML = `
                 <td>${key.id}</td>
                 <td>${key.description || '---'}</td>
                 <td>${key.role}</td>
                 <td>${objectIdDisplay}</td>
                 <td>${activeToggleHtml}</td>
                 <td title="${key.created_at || ''}">${createdDateStr}</td>
                 <td title="${key.last_used_at || ''}">${lastUsedDateStr}</td>
                 <td class="actions">
                      <button class="edit-btn" data-id="${key.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á ID ${key.id}">‚úèÔ∏è</button>
                      <button class="delete-btn" data-id="${key.id}" data-description="${key.description || `–∫–ª—é—á ID ${key.id}`}" title="–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á ID ${key.id}">üóëÔ∏è</button>
                 </td>
             `;
         });
    }

    /** –û–±–Ω–æ–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (–∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"/"–í–ø–µ—Ä–µ–¥", –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ). */
    function renderTablePagination() {
         if (!paginationControlsElement || !pageInfoSpanElement || !prevPageButton || !nextPageButton) {
             console.error("–≠–ª–µ–º–µ–Ω—Ç—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.");
             return;
         }
         const totalPages = Math.ceil(listTotalKeys / listItemsPerPage);
         pageInfoSpanElement.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${listCurrentPage} –∏–∑ ${totalPages} (–í—Å–µ–≥–æ: ${listTotalKeys})`;
         prevPageButton.disabled = listCurrentPage <= 1; // –ë–ª–æ–∫–∏—Ä—É–µ–º "–ù–∞–∑–∞–¥" –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
         nextPageButton.disabled = listCurrentPage >= totalPages; // –ë–ª–æ–∫–∏—Ä—É–µ–º "–í–ø–µ—Ä–µ–¥" –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π
         // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü –±–æ–ª—å—à–µ –æ–¥–Ω–æ–π
         paginationControlsElement.style.display = listTotalKeys > 0 && totalPages > 1 ? 'block' : 'none';
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ API-–∫–ª—é—á–µ–π —Å —Å–µ—Ä–≤–µ—Ä–∞ (—Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏)
     * –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Ö —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤ —Ç–∞–±–ª–∏—Ü–µ.
     * @param {number} [page=1] - –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.
     */
    async function loadAndRenderApiKeys(page = 1) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ó–∞–≥—Ä—É–∑–∫–∞..." –≤ –¢–ê–ë–õ–ò–¶–ï, –∞ –Ω–µ –≤ –æ–±—â–µ–º —Ñ–∏–¥–±–µ–∫–µ –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º
        keyListTableBody.innerHTML = `<tr><td colspan="8" class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ API-–∫–ª—é—á–µ–π...</td></tr>`;
        showListFeedbackMessage(''); // –û—á–∏—â–∞–µ–º –æ–±—â–∏–π —Ñ–∏–¥–±–µ–∫ –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º
        listCurrentPage = page; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        const offset = (listCurrentPage - 1) * listItemsPerPage; // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ

        // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è API-–∑–∞–ø—Ä–æ—Å–∞ –∏–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        const queryParams = new URLSearchParams();
        queryParams.append('limit', listItemsPerPage);
        queryParams.append('offset', offset);
        if (filterRoleSelectElement.value) queryParams.append('role', filterRoleSelectElement.value);
        if (filterObjectIdSelectElement.value) queryParams.append('object_id', filterObjectIdSelectElement.value);
        if (filterIsActiveSelectElement.value) queryParams.append('is_active', filterIsActiveSelectElement.value);

        try {
            const apiUrlWithParams = `${API_URL_KEYS_CRUD}?${queryParams.toString()}`;
            // fetchDataApi —Å–∞–º–∞ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–∫–∞–∑ "–ó–∞–≥—Ä—É–∑–∫–∞..." –∏ –µ–≥–æ –æ—á–∏—Å—Ç–∫—É –¥–ª—è GET-–∑–∞–ø—Ä–æ—Å–æ–≤
            const resultData = await fetchDataApi(apiUrlWithParams);

            currentApiKeysCache = (resultData && resultData.items) ? resultData.items : [];
            listTotalKeys = (resultData && resultData.total_count !== undefined) ? resultData.total_count : currentApiKeysCache.length;

            renderApiKeyTable(currentApiKeysCache); // –†–µ–Ω–¥–µ—Ä–∏–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É
            renderTablePagination(); // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        } catch (error) {
            // –û—à–∏–±–∫–∞ —É–∂–µ –±—ã–ª–∞ –ø–æ–∫–∞–∑–∞–Ω–∞ –≤ fetchDataApi –≤ listFeedbackElement
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ API-–∫–ª—é—á–µ–π:", error);
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø—Ä—è–º–æ –≤ —Ç–∞–±–ª–∏—Ü–µ
            keyListTableBody.innerHTML = `<tr><td colspan="8" class="error-message">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ API-–∫–ª—é—á–µ–π.</td></tr>`;
            renderTablePagination(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ 0 –∑–∞–ø–∏—Å–µ–π
        }
    }

    /** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ–∫—Ü–∏—é —Å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º API-–∫–ª—é—á–æ–º. */
    function displayGeneratedApiKey(newApiKey) {
        generatedApiKeyDisplayElement.textContent = newApiKey; // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–∞–º –∫–ª—é—á
        generatedKeySectionElement.style.display = 'block';  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é
        // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Å–µ–∫—Ü–∏–∏ —Å –∫–ª—é—á–æ–º
        generatedKeySectionElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º–æ–π ---
    /** –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞). */
    function resetApiKeyForm() {
        apiKeyForm.reset(); // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–±—Ä–æ—Å –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
        hiddenEditKeyIdInput.value = ''; // –û—á–∏—â–∞–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –∫–ª—é—á–∞
        currentEditingKeyId = null;    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        formTitleElement.textContent = '–°–æ–∑–¥–∞—Ç—å –ù–æ–≤—ã–π API –ö–ª—é—á'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º—ã
        submitButton.textContent = '–°–æ–∑–¥–∞—Ç—å –ö–ª—é—á'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
        submitButton.disabled = false; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        cancelButton.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ–Ω–∞"
        isActiveGroupElement.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—É —Å —á–µ–∫–±–æ–∫—Å–æ–º "–ê–∫—Ç–∏–≤–µ–Ω"
        // objectIdSelectElement.disabled = false; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π (–µ—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏)
        clearFormValidationErrors('form-feedback', 'api-key-form-'); // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        showFormFeedbackMessage(''); // –û—á–∏—â–∞–µ–º –æ–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
        generatedKeySectionElement.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞
    }

    /**
     * –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ API-–∫–ª—é—á–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
     * @param {object} apiKeyDataObject - –û–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞ (–∏–∑ API –∏–ª–∏ –∫—ç—à–∞).
     */
    function fillFormForEditing(apiKeyDataObject) {
        if (!apiKeyDataObject) {
            console.error("fillFormForEditing: –ü–µ—Ä–µ–¥–∞–Ω –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –∫–ª—é—á–∞.");
            showFormFeedbackMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.", true);
            return;
        }
        resetApiKeyForm(); // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

        currentEditingKeyId = apiKeyDataObject.id; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –∫–ª—é—á–∞
        hiddenEditKeyIdInput.value = apiKeyDataObject.id; // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
        formTitleElement.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å API –ö–ª—é—á ID: ${apiKeyDataObject.id}`;
        submitButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
        cancelButton.style.display = 'inline-block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ–Ω–∞"
        isActiveGroupElement.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—É —Å —á–µ–∫–±–æ–∫—Å–æ–º "–ê–∫—Ç–∏–≤–µ–Ω"

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞
        descriptionInputElement.value = apiKeyDataObject.description || '';
        roleSelectElement.value = apiKeyDataObject.role || '';
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞ object_id. –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞, –µ—Å–ª–∏ object_id is null.
        objectIdSelectElement.value = apiKeyDataObject.object_id !== null ? String(apiKeyDataObject.object_id) : '';
        isActiveCheckboxElement.checked = apiKeyDataObject.is_active === true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞

        // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–æ–∂–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª–µ–π, –µ—Å–ª–∏ —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π
        // –ù–∞–ø—Ä–∏–º–µ—Ä, —Ä–æ–ª—å –∏–ª–∏ object_id –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–Ω—è—Ç—å –Ω–µ–ª—å–∑—è:
        // roleSelectElement.disabled = true;
        // objectIdSelectElement.disabled = true;

        generatedKeySectionElement.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å –∫–ª—é—á–æ–º (–æ–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö)
        apiKeyForm.scrollIntoView({ behavior: 'smooth', block: 'start' }); // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫ —Ñ–æ—Ä–º–µ
    }

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---

    /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã (—Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ API-–∫–ª—é—á–∞). */
    async function handleApiKeyFormSubmit(event) {
        event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
        clearFormValidationErrors('form-feedback', 'api-key-form-'); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        showFormFeedbackMessage(''); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
        generatedKeySectionElement.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å –∫–ª—é—á–æ–º –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
        submitButton.disabled = true;
        submitButton.textContent = currentEditingKeyId ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ–∑–¥–∞–Ω–∏–µ...';

        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
        const formDataPayload = {
            description: descriptionInputElement.value.trim(),
            role: roleSelectElement.value, // –†–æ–ª—å –±–µ—Ä–µ—Ç—Å—è –∏–∑ —Å–µ–ª–µ–∫—Ç–∞
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ objectIdSelect –≤ —á–∏—Å–ª–æ –∏–ª–∏ null
            object_id: objectIdSelectElement.value ? parseInt(objectIdSelectElement.value, 10) : null
        };

        // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ is_active
        if (currentEditingKeyId) {
            formDataPayload.is_active = isActiveCheckboxElement.checked;
        }

        // –ü—Ä–æ—Å—Ç–∞—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –±–æ–ª–µ–µ –ø–æ–ª–Ω–∞—è)
        let clientSideErrors = {};
        if (!formDataPayload.description) clientSideErrors.description = '–û–ø–∏—Å–∞–Ω–∏–µ –∫–ª—é—á–∞ —è–≤–ª—è–µ—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º.';
        if (!currentEditingKeyId && !formDataPayload.role) clientSideErrors.role = '–†–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞.';
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ object_id –Ω–µ —Ç–∞–∫ –∫—Ä–∏—Ç–∏—á–Ω–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ, –µ—Å–ª–∏ —Å–µ–ª–µ–∫—Ç –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞.
        // –°–µ—Ä–≤–µ—Ä –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è.

        if (Object.keys(clientSideErrors).length > 0) {
            displayFormValidationErrors(clientSideErrors, 'form-feedback', ''); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç–æ–π –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –ø–æ–ª–µ–π
            submitButton.disabled = false;
            submitButton.textContent = currentEditingKeyId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–°–æ–∑–¥–∞—Ç—å –ö–ª—é—á';
            return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL –∏ HTTP-–º–µ—Ç–æ–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
        const apiUrl = currentEditingKeyId ? API_URL_KEY_DETAIL_TEMPLATE.replace('/0', `/${currentEditingKeyId}`) : API_URL_KEYS_CRUD;
        const httpMethod = currentEditingKeyId ? 'PUT' : 'POST';

        // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏, –µ—Å–ª–∏ —Ä–æ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞), –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–µ, —á—Ç–æ–±—ã –Ω–µ —Å–±—Ä–æ—Å–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        if (currentEditingKeyId && !formDataPayload.role) {
            delete formDataPayload.role;
        }

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const resultData = await fetchDataApi(apiUrl, {
                method: httpMethod,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formDataPayload)
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
            if (httpMethod === 'POST' && resultData && resultData.api_key) { // –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞
                 displayGeneratedApiKey(resultData.api_key); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á
                 apiKeyForm.reset(); // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
                 showListFeedbackMessage('API-–∫–ª—é—á —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ.', false);
                 await loadAndRenderApiKeys(1); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∫–ª—é—á–µ–π (–ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É)
            } else if (httpMethod === 'PUT' && resultData) { // –£—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª—é—á–∞
                 showListFeedbackMessage(`API-–∫–ª—é—á ID ${currentEditingKeyId} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω.`, false);
                 resetApiKeyForm(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É (–≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
                 await loadAndRenderApiKeys(listCurrentPage); // –û–±–Ω–æ–≤–ª—è–µ–º –¢–ï–ö–£–©–£–Æ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–ø–∏—Å–∫–∞
            } else if (httpMethod === 'POST') { // –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è (API –Ω–µ –≤–µ—Ä–Ω—É–ª –∫–ª—é—á, —Ö–æ—Ç—è —Å—Ç–∞—Ç—É—Å –±—ã–ª OK - –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ)
                 throw new Error("API-—Å–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è.");
            }
        } catch (error) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç fetchDataApi (—Å–µ—Ç—å, HTTP, –ø–∞—Ä—Å–∏–Ω–≥ JSON)
            console.error(`–û—à–∏–±–∫–∞ ${httpMethod} –¥–ª—è API-–∫–ª—é—á–∞:`, error);
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ –æ–±—â—É—é –æ—à–∏–±–∫—É –≤ —Ñ–æ—Ä–º–µ
            displayFormValidationErrors(error.details || error.message, 'form-feedback', '');
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é –æ—à–∏–±–∫—É –≤ —Ñ–∏–¥–±–µ–∫–µ —Ñ–æ—Ä–º—ã
            showFormFeedbackMessage(`–û—à–∏–±–∫–∞: ${error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é.'}`, true);
        } finally { // –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–µ —Ç–µ–∫—Å—Ç
            submitButton.disabled = false;
            submitButton.textContent = currentEditingKeyId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–°–æ–∑–¥–∞—Ç—å –ö–ª—é—á';
        }
    }

    /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞/–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è "–ê–∫—Ç–∏–≤–µ–Ω" –≤ —Ç–∞–±–ª–∏—Ü–µ. */
    async function handleToggleActiveStatus(keyId, newIsActiveStatus) {
        showListFeedbackMessage(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–ª—é—á–∞ ID ${keyId}...`);
        const apiUrlUpdate = API_URL_KEY_DETAIL_TEMPLATE.replace('/0', `/${keyId}`);
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ 'is_active'
            await fetchDataApi(apiUrlUpdate, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_active: newIsActiveStatus })
            });
            showListFeedbackMessage(`–°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–ª—é—á–∞ ID ${keyId} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ '${newIsActiveStatus ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}'.`, false);
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –¥–∞–Ω–Ω—ã—Ö –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ö–æ—Ä–æ—à–æ –¥–ª—è UX)
            const keyInLocalCache = currentApiKeysCache.find(k => k.id === keyId);
            if (keyInLocalCache) keyInLocalCache.is_active = newIsActiveStatus;
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞, –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç –∫–ª–∞—Å—Å –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —á—Ç–æ-—Ç–æ –µ—â–µ –∫—Ä–æ–º–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–ª—é—á–∞:", error);
            // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –±—ã–ª–æ –ø–æ–∫–∞–∑–∞–Ω–æ –≤ fetchDataApi –≤ listFeedbackElement
            // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞/–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –æ–±—Ä–∞—Ç–Ω–æ –≤ UI
            const checkboxElement = keyListTableBody.querySelector(`.active-toggle[data-id="${keyId}"]`);
            if (checkboxElement) checkboxElement.checked = !newIsActiveStatus; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        }
    }

    /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —É–¥–∞–ª–µ–Ω–∏—è API-–∫–ª—é—á–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ. */
    async function handleDeleteButtonClick(keyId, keyDescription) {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å API-–∫–ª—é—á "${keyDescription}" (ID: ${keyId})? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) {
            return; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª —É–¥–∞–ª–µ–Ω–∏–µ
        }
        showListFeedbackMessage(`–£–¥–∞–ª–µ–Ω–∏–µ API-–∫–ª—é—á–∞ ID ${keyId}...`);
        const apiUrlDelete = API_URL_KEY_DETAIL_TEMPLATE.replace('/0', `/${keyId}`);
        try {
            await fetchDataApi(apiUrlDelete, { method: 'DELETE' }); // –û–∂–∏–¥–∞–µ–º 204 No Content
            showListFeedbackMessage(`API-–∫–ª—é—á ID ${keyId} ("${keyDescription}") —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.`, false);
            // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º—ã–π –∫–ª—é—á –±—ã–ª –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            if (currentEditingKeyId === keyId) {
                resetApiKeyForm();
            }
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¢–ï–ö–£–©–£–Æ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–ø–∏—Å–∫–∞.
            // –ï—Å–ª–∏ –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è,
            // –≤–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é (–µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–∞—è).
            // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â—É—é.
            await loadAndRenderApiKeys(listCurrentPage);
        } catch (error) {
            // –û—à–∏–±–∫–∞ —É–∂–µ –±—ã–ª–∞ –ø–æ–∫–∞–∑–∞–Ω–∞ –≤ fetchDataApi –≤ listFeedbackElement
            console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è API-–∫–ª—é—á–∞:", error);
            // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω" –∏–ª–∏ "–æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞") —É–∂–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ.
        }
    }

     /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ. */
     function handleEditButtonClick(keyId) {
         const apiKeyDataToEdit = currentApiKeysCache.find(k => k.id === keyId); // –ò—â–µ–º –∫–ª—é—á –≤ –∫—ç—à–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
         if (apiKeyDataToEdit) {
             fillFormForEditing(apiKeyDataToEdit); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞
         } else {
             // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ –∫—ç—à–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏/–ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∏–ª–∏ –µ—Å–ª–∏ –∫—ç—à —É—Å—Ç–∞—Ä–µ–ª),
             // –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∏—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ ID.
             // –ù–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –∫—ç—à–µ.
             console.error(`–î–∞–Ω–Ω—ã–µ –¥–ª—è API-–∫–ª—é—á–∞ —Å ID ${keyId} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫—ç—à–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.`);
             showListFeedbackMessage(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞ ID ${keyId}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫.`, true);
         }
     }

    /** –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–µ–ª–µ–∫—Ç–∞—Ö (–≤ —Ñ–æ—Ä–º–µ –∏ —Ñ–∏–ª—å—Ç—Ä–µ). */
    async function loadSubdivisionsForSelects() {
        showListFeedbackMessage("–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤...");
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –∏—Ö –Ω–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞)
            const subdivisionsResponse = await fetchDataApi(API_URL_SUBDIVISIONS_LIST + '?limit=10000'); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç
            allSubdivisionsCache = (subdivisionsResponse && subdivisionsResponse.items) ? subdivisionsResponse.items : [];

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫–ª—é—á–∞ –∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é –≤ —Ñ–æ—Ä–º–µ (–∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π)
            populateSelectWithOptions(objectIdSelectElement, allSubdivisionsCache, 'object_id', 'short_name', '-- –ù–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å --', true);
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é (–ø–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫, –∑–Ω–∞—á–µ–Ω–∏–µ - object_id)
            populateSelectWithOptions(filterObjectIdSelectElement, allSubdivisionsCache, 'object_id', 'short_name', '–í—Å–µ –æ–±—ä–µ–∫—Ç—ã');

            showListFeedbackMessage(""); // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ, –µ—Å–ª–∏ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ
        } catch (error) {
             console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤:", error);
             // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ –≤ fetchDataApi –≤ listFeedbackElement
             // –ú–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑–∞—Ç—å, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
             objectIdSelectElement.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π</option>';
             filterObjectIdSelectElement.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π</option>';
        }
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É: –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤)
     * –∏ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–ø–∏—Å–∫–∞ API-–∫–ª—é—á–µ–π.
     */
    async function initializeManageApiKeysPage() {
         // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ –≤ —Ç–∞–±–ª–∏—Ü–µ
         keyListTableBody.innerHTML = `<tr><td colspan="8" class="loading-message">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã...</td></tr>`;
         try {
             await loadSubdivisionsForSelects(); // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤
             await loadAndRenderApiKeys(1);    // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É API-–∫–ª—é—á–µ–π
         } catch(e) {
              // –û—à–∏–±–∫–∏ —É–∂–µ –±—ã–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏ –≤—ã–≤–µ–¥–µ–Ω—ã –≤ listFeedbackElement —Ñ—É–Ω–∫—Ü–∏—è–º–∏ loadSubdivisionsForSelects –∏ loadAndRenderApiKeys
              console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è API-–∫–ª—é—á–∞–º–∏:", e);
              // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤ —Ç–∞–±–ª–∏—Ü–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –∞ –Ω–µ "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è..."
              if (!keyListTableBody.querySelector('.error-message')) {
                   keyListTableBody.innerHTML = `<tr><td colspan="8" class="error-message">–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</td></tr>`;
              }
         }
    }

    // --- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π ---
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    apiKeyForm.addEventListener('submit', handleApiKeyFormSubmit);
    // –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞
    copyKeyButton.addEventListener('click', () => copyTextToClipboard(generatedApiKeyDisplayElement.textContent));
    // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–µ–∫—Ü–∏–∏ —Å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–ª—é—á–æ–º
    closeGeneratedKeyButton.addEventListener('click', () => { generatedKeySectionElement.style.display = 'none'; showFormFeedbackMessage(''); });
    // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã"
    applyFiltersButton.addEventListener('click', () => loadAndRenderApiKeys(1)); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    // –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∞" –≤ —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    cancelButton.addEventListener('click', resetApiKeyForm);

    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –∫–ª—é—á–µ–π (–¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π)
    keyListTableBody.addEventListener('change', (event) => { // –î–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤/–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π
        if (event.target.classList.contains('active-toggle')) {
            const keyId = parseInt(event.target.dataset.id, 10);
            const newIsActive = event.target.checked;
            handleToggleActiveStatus(keyId, newIsActive);
        }
    });
    keyListTableBody.addEventListener('click', (event) => { // –î–ª—è –∫–Ω–æ–ø–æ–∫
        const deleteButtonTarget = event.target.closest('.delete-btn');
        const editButtonTarget = event.target.closest('.edit-btn');
        if (deleteButtonTarget) {
            handleDeleteButtonClick(parseInt(deleteButtonTarget.dataset.id, 10), deleteButtonTarget.dataset.description);
        } else if (editButtonTarget) {
             handleEditButtonClick(parseInt(editButtonTarget.dataset.id, 10));
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    prevPageButton.addEventListener('click', () => { if (listCurrentPage > 1) loadAndRenderApiKeys(listCurrentPage - 1); });
    nextPageButton.addEventListener('click', () => { if (listCurrentPage * listItemsPerPage < listTotalKeys) loadAndRenderApiKeys(listCurrentPage + 1); });

    // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ DOM
    document.addEventListener('DOMContentLoaded', initializeManageApiKeysPage);

</script>
{% endblock %}