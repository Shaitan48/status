<!-- status/app/templates/manage_types.html -->
{% extends "base.html" %} <!-- –ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ -->
{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¢–∏–ø–∞–º–∏ –£–∑–ª–æ–≤ - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ü–¢–ö{% endblock %} <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->

{% block head_extra %}
<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<style>
    /* --- –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã --- */
    .manage-container {
        display: grid;
        grid-template-columns: minmax(380px, 1.2fr) 2fr; /* –ö–æ–ª–æ–Ω–∫–∞ –¥–ª—è —Ñ–æ—Ä–º—ã —á—É—Ç—å —à–∏—Ä–µ */
        gap: 2rem;
        align-items: start; /* –§–æ—Ä–º–∞ –∏ —Å–ø–∏—Å–æ–∫ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞—é—Ç—Å—è –ø–æ –≤–µ—Ä—Ö—É */
        margin-top: 1rem;
    }
    .form-section { /* –°–µ–∫—Ü–∏—è —Å —Ñ–æ—Ä–º–æ–π –¥–ª—è —Ç–∏–ø–∞ —É–∑–ª–∞ –∏ –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤ */
        background-color: var(--card-bg);
        padding: 1.5rem;
        border-radius: 5px;
        box-shadow: var(--card-shadow);
        position: sticky; /* –î–µ–ª–∞–µ–º —Ñ–æ—Ä–º—É "–ª–∏–ø–∫–æ–π" –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ */
        top: 80px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –≤–µ—Ä—Ö–Ω–µ–≥–æ –∫—Ä–∞—è, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∞—Å—å –Ω–∞–≤–±–∞—Ä–æ–º */
        align-self: start; /* –ß—Ç–æ–±—ã –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–∞—Å—å –ø–æ –≤—ã—Å–æ—Ç–µ —Å–ø–∏—Å–∫–∞ */
    }
    .form-section h3, .form-section h4, .list-section h3 { /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–µ–∫—Ü–∏–π */
        margin-top: 0;
        border-bottom: 1px solid #eee;
        padding-bottom: 0.8rem;
        margin-bottom: 1rem;
        font-weight: 500;
    }
    .list-section { /* –°–µ–∫—Ü–∏—è —Å–æ —Å–ø–∏—Å–∫–æ–º —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤ */
        background-color: var(--card-bg);
        padding: 1.5rem;
        border-radius: 5px;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--border-color);
    }

    /* --- –°—Ç–∏–ª–∏ —Ñ–æ—Ä–º—ã –¥–ª—è –¢–∏–ø–∞ –£–∑–ª–∞ --- */
    .form-grid-type { /* –°–µ—Ç–∫–∞ –¥–ª—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã —Ç–∏–ø–∞ —É–∑–ª–∞ */
        display: grid;
        grid-template-columns: 1fr 1fr; /* –î–≤–µ —Ä–∞–≤–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ */
        gap: 1rem 1.5rem; /* –û—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É —è—á–µ–π–∫–∞–º–∏ */
    }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.95em; }
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
        width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px;
        box-sizing: border-box; font-size: 1em;
    }
    .form-group textarea#type-description { /* –û–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–∞ —É–∑–ª–∞ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
        min-height: 60px; resize: vertical; grid-column: 1 / -1;
    }
    .form-actions { /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–æ—Ä–º—ã —Ç–∏–ø–∞ */
        margin-top: 1.5rem; text-align: right; display: flex;
        justify-content: flex-end; gap: 0.5rem; grid-column: 1 / -1; /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —Å–µ—Ç–∫–∏ */
    }
    #cancel-edit-btn { background-color: var(--secondary-color); } /* –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∞" */
    #cancel-edit-btn:hover { background-color: #5a6268; }

    /* --- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏ –≤ —Ñ–æ—Ä–º–µ —Ç–∏–ø–∞ —É–∑–ª–∞ --- */
    #icon-preview-section { margin-top: 1rem; grid-column: 1 / -1; /* –ù–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —Å–µ—Ç–∫–∏ */ }
    #icon-preview-section h5 { margin-bottom: 0.5rem; font-size: 0.95em; color: #555; font-weight: 500; }
    .icon-preview-container {
        display: flex; align-items: center; gap: 10px; padding: 8px;
        background-color: #f8f9fa; border: 1px solid #eee; border-radius: 4px;
    }
    .icon-preview-element { /* –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∞–º–æ–π –∏–∫–æ–Ω–∫–∏ */
        display: inline-block; width: 32px; height: 32px;
        background-color: grey; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –±—É–¥–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω JavaScript */
        -webkit-mask-size: contain; mask-size: contain;
        -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
        -webkit-mask-position: center; mask-position: center;
        border: 1px solid #ccc; flex-shrink: 0; border-radius: 3px;
    }
    .icon-preview-info { font-size: 0.9em; color: #555; } /* –¢–µ–∫—Å—Ç–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–∫–æ–Ω–∫–µ */

    /* --- –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å–ø–∏—Å–∫–∞ –¢–∏–ø–æ–≤ –£–∑–ª–æ–≤ --- */
    .types-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .types-table th, .types-table td {
        border: 1px solid var(--border-color); padding: 8px 12px;
        text-align: left; vertical-align: middle;
    }
    .types-table th { background-color: var(--light-grey); font-weight: 600; white-space: nowrap; }
    .types-table .actions { text-align: center; white-space: nowrap; width: 90px; } /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    .types-table .actions button {
        padding: 4px 8px; font-size: 0.9em; margin-right: 5px; cursor: pointer;
        border: none; border-radius: 3px; color: white;
    }
    .types-table .edit-btn { background-color: var(--warning-color); color: #333; }
    .types-table .delete-btn { background-color: var(--danger-color); }
    .types-table tr.selected { background-color: #e2f3ff; } /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ */
    .types-table tr:not(.selected):hover { background-color: #f8f9fa; cursor: pointer;} /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    .types-table .icon-cell { text-align: center; width: 60px; } /* –Ø—á–µ–π–∫–∞ –¥–ª—è –∏–∫–æ–Ω–∫–∏ */
    .types-table .icon-cell img { max-width: 20px; max-height: 20px; vertical-align: middle; }
    /* –ò–µ—Ä–∞—Ä—Ö–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ —Ç–∏–ø–æ–≤ */
    .types-table .level-0 { font-weight: bold; } /* –ö–æ—Ä–Ω–µ–≤—ã–µ —Ç–∏–ø—ã - –∂–∏—Ä–Ω—ã–º */
    .types-table .level-1 td:first-child { padding-left: 30px !important; } /* –û—Ç—Å—Ç—É–ø –¥–ª—è 1-–≥–æ —É—Ä–æ–≤–Ω—è */
    .types-table .level-2 td:first-child { padding-left: 50px !important; } /* –û—Ç—Å—Ç—É–ø –¥–ª—è 2-–≥–æ —É—Ä–æ–≤–Ω—è */
    .types-table .level-3 td:first-child { padding-left: 70px !important; } /* –û—Ç—Å—Ç—É–ø –¥–ª—è 3-–≥–æ —É—Ä–æ–≤–Ω—è */

    /* --- –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–∫—Ü–∏–∏ –°–≤–æ–π—Å—Ç–≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ --- */
    #properties-section { /* –°–µ–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞–º–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ */
        margin-top: 2rem; padding-top: 1.5rem;
        border-top: 2px solid var(--primary-color); /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è */
    }
    #properties-section h4 { margin-top: 0; margin-bottom: 1rem; font-weight: 500;}
    .properties-list { /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ç–µ–∫—É—â–∏—Ö —Å–≤–æ–π—Å—Ç–≤ */
        margin-bottom: 1.5rem; max-height: 300px; overflow-y: auto;
        border: 1px solid #eee; padding: 0.8rem; border-radius: 4px; background-color: #fff;
    }
    .property-item { /* –û–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç (—Å–≤–æ–π—Å—Ç–≤–æ) –≤ —Å–ø–∏—Å–∫–µ */
        display: flex; align-items: center; gap: 10px; margin-bottom: 0.8rem;
        padding-bottom: 0.8rem; border-bottom: 1px dashed #eee;
    }
    .property-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .property-item label { /* –õ–µ–π–±–ª (–∏–º—è —Å–≤–æ–π—Å—Ç–≤–∞) */
        flex-basis: 180px; flex-shrink: 0; font-size: 0.9em;
        color: #333; text-align: right;
    }
    .property-item input[type="text"] { flex-grow: 1; } /* –ü–æ–ª–µ –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞ */
    .property-item button { /* –ö–Ω–æ–ø–∫–∏ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/–£–¥–∞–ª–∏—Ç—å" —Å–≤–æ–π—Å—Ç–≤–æ */
        padding: 3px 7px; font-size: 0.85em; flex-shrink: 0;
    }
    .property-item .delete-prop-btn { background-color: var(--danger-color); } /* –ö—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */

    #add-property-form { /* –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞ */
        display: flex; gap: 10px; align-items: flex-end; /* –≠–ª–µ–º–µ–Ω—Ç—ã –≤ —Å—Ç—Ä–æ–∫—É, –≤—ã—Ä–æ–≤–Ω–µ–Ω—ã –ø–æ –Ω–∏–∑—É */
    }
    #add-property-form select#property-type-select { flex-basis: 200px; } /* –°–µ–ª–µ–∫—Ç —Ç–∏–ø–∞ —Å–≤–æ–π—Å—Ç–≤–∞ */
    #add-property-form input#property-value-input { flex-grow: 1; }    /* –ü–æ–ª–µ –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏—è */
    #add-property-form button[type="submit"] { flex-shrink: 0; }     /* –ö–Ω–æ–ø–∫–∞ "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" */

    /* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π (feedback) –∏ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ --- */
    .feedback-area { /* ... (–∫–∞–∫ –≤ manage_api_keys.html) ... */ }
    .error-feedback { /* ... (–∫–∞–∫ –≤ manage_api_keys.html) ... */ }
    .loading-message { /* ... (–∫–∞–∫ –≤ manage_api_keys.html) ... */ }
    .error-message { /* ... (–∫–∞–∫ –≤ manage_api_keys.html) ... */ }
    /* ID –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Ñ–∏–¥–±–µ–∫–æ–≤ */
    #form-feedback { /* –û–±—â–∏–µ –æ—à–∏–±–∫–∏/—Å–æ–æ–±—â–µ–Ω–∏—è —Ñ–æ—Ä–º—ã —Ç–∏–ø–∞ —É–∑–ª–∞ */ }
    #list-feedback { /* –°–æ–æ–±—â–µ–Ω–∏—è –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º —Ç–∏–ø–æ–≤ */ }
    #prop-feedback { /* –°–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–µ–∫—Ü–∏–∏ —Å–≤–æ–π—Å—Ç–≤ */ }
    .validation-message { /* –°–æ–æ–±—â–µ–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–¥ –ø–æ–ª—è–º–∏ JSON –≤ –ø–∞–Ω–µ–ª–∏ —Å–≤–æ–π—Å—Ç–≤ */
        font-size: 0.85em; margin-top: 5px; display: block;
    }
    .validation-message.valid { color: var(--success-color); }
    .validation-message.invalid { color: var(--danger-color); }
</style>
{% endblock %}

{% block content %}
<h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¢–∏–ø–∞–º–∏ –£–∑–ª–æ–≤ –∏ –∏—Ö –°–≤–æ–π—Å—Ç–≤–∞–º–∏</h2>

<!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è –æ–±—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞ CRUD —Ç–∏–ø–∞) -->
<div id="list-feedback" class="feedback-area"></div>

<div class="manage-container">

    <!-- –°–µ–∫—Ü–∏—è —Å —Ñ–æ—Ä–º–æ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¢–ò–ü–ê –£–ó–õ–ê -->
    <section class="form-section">
        <h3 id="form-title">–î–æ–±–∞–≤–∏—Ç—å –ù–æ–≤—ã–π –¢–∏–ø –£–∑–ª–∞</h3>
        <form id="type-form">
            <input type="hidden" id="type-id"> <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è ID —Ç–∏–ø–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ -->

            <div class="form-grid-type"> <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ç–∫—É –¥–ª—è –ø–æ–ª–µ–π -->
                <div class="form-group">
                    <label for="type-name">–ò–º—è —Ç–∏–ø–∞ *</label>
                    <input type="text" id="type-name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –°–µ—Ä–≤–µ—Ä Windows">
                    <div class="error-feedback" id="type-name-error"></div>
                </div>
                 <div class="form-group">
                    <label for="type-parent">–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —Ç–∏–ø</label>
                    <select id="type-parent">
                        <option value="">-- –ù–µ—Ç (–ö–æ—Ä–Ω–µ–≤–æ–π —Ç–∏–ø) --</option>
                        <!-- –û–ø—Ü–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ–ª–µ–∫—Ç–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ JavaScript'–æ–º -->
                    </select>
                    <div class="error-feedback" id="type-parent-error"></div>
                </div>
                 <div class="form-group">
                    <label for="type-priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏)</label>
                    <input type="number" id="type-priority" value="10" min="0">
                    <div class="error-feedback" id="type-priority-error"></div>
                </div>
                <div class="form-group">
                    <label for="type-icon-filename">–ò–º—è —Ñ–∞–π–ª–∞ –∏–∫–æ–Ω–∫–∏ (–∏–∑ /static/icons/)</label>
                    <input type="text" id="type-icon-filename" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, server.svg –∏–ª–∏ chip.png">
                    <div class="error-feedback" id="type-icon-filename-error"></div>
                </div>

                <!-- –û–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–∞ —É–∑–ª–∞ (–Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —Å–µ—Ç–∫–∏) -->
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="type-description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="type-description" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —É–∑–ª–æ–≤..."></textarea>
                </div>

                <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∫–æ–Ω–∫–∏ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤–≤–æ–¥–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞) -->
                <div id="icon-preview-section" style="display: none; grid-column: 1 / -1;">
                     <h5>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏:</h5>
                     <div class="icon-preview-container">
                         <span class="icon-preview-element" id="icon-preview"></span>
                         <span class="icon-preview-info" id="icon-preview-info">(–ò–º—è —Ñ–∞–π–ª–∞ –∏ —Ü–≤–µ—Ç –±—É–¥—É—Ç –∑–¥–µ—Å—å)</span>
                     </div>
                 </div>

                <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã —Ç–∏–ø–∞ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± —É—Å–ø–µ—Ö–µ -->
                <div id="form-feedback" class="feedback-area" style="grid-column: 1 / -1;"></div>
                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Ñ–æ—Ä–º—ã —Ç–∏–ø–∞ —É–∑–ª–∞ -->
                <div class="form-actions" style="grid-column: 1 / -1;">
                    <button type="button" id="cancel-edit-btn" style="display: none;">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" id="submit-btn">–î–æ–±–∞–≤–∏—Ç—å –¢–∏–ø</button>
                </div>
            </div> <!-- –ö–æ–Ω–µ—Ü .form-grid-type -->
        </form>

        <!-- –°–µ–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞–º–∏ –í–´–ë–†–ê–ù–ù–û–ì–û —Ç–∏–ø–∞ —É–∑–ª–∞ -->
        <div id="properties-section" style="display: none;"> <!-- –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞ -->
            <h4 id="properties-title">–°–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è —Ç–∏–ø–∞: <span style="font-style:italic;">(–≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏–∑ —Å–ø–∏—Å–∫–∞)</span></h4>
            <!-- –§–∏–¥–±–µ–∫ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å–æ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏ -->
            <div id="prop-feedback" class="feedback-area"></div>

            <h5>–¢–µ–∫—É—â–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞:</h5>
            <div class="properties-list" id="properties-list-container">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É–∑–ª–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ø—Ä–∞–≤–∞, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞.</p>
            </div>

            <h5>–î–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–æ:</h5>
            <form id="add-property-form">
                <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                    <div style="flex-grow: 1;">
                        <label for="property-type-select">–¢–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ *</label>
                        <select id="property-type-select" required>
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ --</option>
                            <!-- –û–ø—Ü–∏–∏ (—Ç–∏–ø—ã —Å–≤–æ–π—Å—Ç–≤ –∏–∑ node_property_types) –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è JS -->
                        </select>
                    </div>
                    <div style="flex-grow: 2;">
                        <label for="property-value-input">–ó–Ω–∞—á–µ–Ω–∏–µ *</label>
                        <input type="text" id="property-value-input" required placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞">
                    </div>
                    <button type="submit" style="flex-shrink: 0;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div class="error-feedback" id="add-property-form-error"></div> <!-- –î–ª—è –æ—à–∏–±–æ–∫ —ç—Ç–æ–π –º–∏–Ω–∏-—Ñ–æ—Ä–º—ã -->
            </form>
        </div>
    </section>

    <!-- –°–µ–∫—Ü–∏—è —Å–æ —Å–ø–∏—Å–∫–æ–º –¢–ò–ü–û–í –£–ó–õ–û–í -->
    <section class="list-section">
        <h3>–°–ø–∏—Å–æ–∫ –¢–∏–ø–æ–≤ –£–∑–ª–æ–≤</h3>
        <p style="font-size:0.9em; color:#555;">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–æ–∫—É —Ç–∏–ø–∞, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏ –≤ —Ñ–æ—Ä–º–µ —Å–ª–µ–≤–∞.</p>
        <table class="types-table">
            <thead>
                <tr>
                    <th>–ò–º—è –¢–∏–ø–∞</th>
                    <th>–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —Ç–∏–ø</th>
                    <th>–ò–∫–æ–Ω–∫–∞</th>
                    <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="type-list-table-body"> <!-- –ò–∑–º–µ–Ω–µ–Ω ID –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ -->
                <!-- –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ -->
                <tr><td colspan="5" class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤...</td></tr>
            </tbody>
        </table>
        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤ –∑–¥–µ—Å—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å—ë –¥–µ—Ä–µ–≤–æ -->
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã ---
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¢–∏–ø–æ–º –£–∑–ª–∞
    const typeFormElement = document.getElementById('type-form');
    const typeFormTitleElement = document.getElementById('form-title');
    const typeSubmitButton = document.getElementById('submit-btn');
    const typeCancelButton = document.getElementById('cancel-edit-btn');
    const typeListTableBody = document.getElementById('type-list-table-body'); // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π ID
    const typeParentSelectElement = document.getElementById('type-parent');
    const typeFormFeedbackElement = document.getElementById('form-feedback'); // –î–ª—è –æ—à–∏–±–æ–∫/—É—Å–ø–µ—Ö–∞ —Ñ–æ—Ä–º—ã —Ç–∏–ø–∞
    const listFeedbackElement = document.getElementById('list-feedback');   // –î–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º —Ç–∏–ø–æ–≤

    // –ü–æ–ª—è —Ñ–æ—Ä–º—ã —Ç–∏–ø–∞ —É–∑–ª–∞
    const typeIdInputElement = document.getElementById('type-id'); // –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è ID
    const typeNameInputElement = document.getElementById('type-name');
    const typePriorityInputElement = document.getElementById('type-priority');
    const typeIconFilenameInputElement = document.getElementById('type-icon-filename');
    const typeDescriptionTextareaElement = document.getElementById('type-description');

    // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∫–æ–Ω–∫–∏
    const iconPreviewSectionElement = document.getElementById('icon-preview-section');
    const iconPreviewSpanElement = document.getElementById('icon-preview'); // –°–∞–º span –¥–ª—è –∏–∫–æ–Ω–∫–∏
    const iconPreviewInfoElement = document.getElementById('icon-preview-info'); // –¢–µ–∫—Å—Ç –ø–æ–¥ –∏–∫–æ–Ω–∫–æ–π

    // –≠–ª–µ–º–µ–Ω—Ç—ã —Å–µ–∫—Ü–∏–∏ –∏ —Ñ–æ—Ä–º—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –°–≤–æ–π—Å—Ç–≤–∞–º–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¢–∏–ø–∞ –£–∑–ª–∞
    const propertiesSectionElement = document.getElementById('properties-section');
    const propertiesTitleElement = document.getElementById('properties-title');
    const propertiesListContainerElement = document.getElementById('properties-list-container'); // div –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å–≤–æ–π—Å—Ç–≤
    const addPropertyFormElement = document.getElementById('add-property-form');
    const propertyTypeSelectElement = document.getElementById('property-type-select'); // select –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Å–≤–æ–π—Å—Ç–≤–∞
    const propertyValueInputElement = document.getElementById('property-value-input');   // input –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞
    const propertyFormFeedbackElement = document.getElementById('prop-feedback'); // –§–∏–¥–±–µ–∫ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å–æ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏

    // --- API URL-–∞–¥—Ä–µ—Å–∞ (–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è Flask) ---
    const API_URL_NODE_TYPES_CRUD = "{{ url_for('node_types.api_get_all_node_types') }}"; // –î–ª—è GET (—Å–ø–∏—Å–æ–∫) –∏ POST (—Å–æ–∑–¥–∞–Ω–∏–µ)
    const API_URL_NODE_TYPE_DETAIL_TEMPLATE = "{{ url_for('node_types.api_get_node_type_by_id_route', type_id=0) }}"; // –®–∞–±–ª–æ–Ω –¥–ª—è GET/PUT/DELETE –ø–æ ID
    const API_URL_NODE_PROPERTY_TYPES_LIST = "{{ url_for('node_properties.api_get_all_node_property_types') }}"; // –î–ª—è —Å–ø–∏—Å–∫–∞ —Ç–∏–ø–æ–≤ –°–í–û–ô–°–¢–í
    const API_URL_NODE_TYPE_PROPERTIES_TEMPLATE = "{{ url_for('node_properties.api_get_properties_for_node_type', node_type_id=0) }}"; // GET, PUT –¥–ª—è —Å–≤–æ–π—Å—Ç–≤ –ö–û–ù–ö–†–ï–¢–ù–û–ì–û —Ç–∏–ø–∞ —É–∑–ª–∞
    const API_URL_NODE_TYPE_PROPERTY_DELETE_TEMPLATE = "{{ url_for('node_properties.api_delete_single_node_property', node_type_id=0, property_type_id=0) }}"; // DELETE –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞ —É —Ç–∏–ø–∞

    const ICONS_BASE_STATIC_URL = "{{ url_for('static', filename='icons/') }}"; // –ë–∞–∑–æ–≤—ã–π –ø—É—Ç—å –∫ –∏–∫–æ–Ω–∫–∞–º –¥–ª—è JS

    // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
    let allNodeTypesDataCache = [];     // –ö—ç—à –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤ (–¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –∏ —Å–µ–ª–µ–∫—Ç–∞ —Ä–æ–¥–∏—Ç–µ–ª–µ–π)
    let allPropertyTypesDataCache = []; // –ö—ç—à –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∏–ø–æ–≤ –°–í–û–ô–°–¢–í (–¥–ª—è —Å–µ–ª–µ–∫—Ç–∞ –≤ —Ñ–æ—Ä–º–µ —Å–≤–æ–π—Å—Ç–≤)
    let currentEditingNodeTypeId = null; // ID —Ç–∏–ø–∞ —É–∑–ª–∞, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è (null –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ)
    let selectedNodeTypeIdForPropsEditing = null; // ID —Ç–∏–ø–∞ —É–∑–ª–∞, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è —Å–≤–æ–π—Å—Ç–≤–∞

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (fetchData, displayValidationErrors, clearValidationErrors, showFeedback) ---
    // –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ manage_api_keys.html –∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ –ø–æ–¥–æ–±–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞,
    // —Ç–∞–∫ –∫–∞–∫ –∏—Ö –ª–æ–≥–∏–∫–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ ID —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π.
    function showTypeListFeedback(message, isError = false) { showFeedback(listFeedbackElement, message, isError); }
    function showTypeFormFeedback(message, isError = false) { showFeedback(typeFormFeedbackElement, message, isError); }
    function showPropertyFeedback(message, isError = false) { showFeedback(propertyFormFeedbackElement, message, isError); }
    // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ö–µ–ª–ø–µ—Ä—ã fetchData, displayValidationErrors, clearValidationErrors —Ç–∞–∫–∂–µ –Ω—É–∂–Ω—ã)
    async function fetchData(url, options = {}) { /* ... (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ manage_api_keys.html) ... */ }
    function displayValidationErrors(errors, feedbackElementId = 'form-feedback', fieldPrefix = '') { /* ... (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ manage_api_keys.html, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å ID) ... */ }
    function clearValidationErrors(feedbackElementId = 'form-feedback', formId = 'type-form') { /* ... (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ manage_api_keys.html, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å ID) ... */ }
    function showFeedback(element, message, isError = false) { /* ... (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ manage_api_keys.html) ... */ }
    function populateSelect(selectElement, items, valueField, textField, placeholder, addHierarchy = false, excludeId = null) { /* ... (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ manage_subdivisions.html) ... */ }

    /** –û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–≤–æ–π—Å—Ç–≤. */
    function updateIconPreview() {
        const filename = typeIconFilenameInputElement.value.trim() || 'other.svg'; // –ò–º—è —Ñ–∞–π–ª–∞ –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
        const colorPropertyType = allPropertyTypesDataCache.find(p => p.name === 'icon_color'); // –ò—â–µ–º —Ç–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ 'icon_color'
        let iconColor = '#808080'; // –¶–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–µ—Ä—ã–π)

        // –ï—Å–ª–∏ —Ç–∏–ø —É–∑–ª–∞ –≤—ã–±—Ä–∞–Ω –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤ –∏ —Ç–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ 'icon_color' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (selectedNodeTypeIdForPropsEditing !== null && colorPropertyType) {
            const currentPropertiesItems = propertiesListContainerElement.querySelectorAll('.property-item');
            // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–≤–æ–π—Å—Ç–≤–∞ 'icon_color' –≤ —Å–ø–∏—Å–∫–µ —Ç–µ–∫—É—â–∏—Ö —Å–≤–æ–π—Å—Ç–≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
            const colorPropertyElement = Array.from(currentPropertiesItems).find(item =>
                item.dataset.propertyTypeId == colorPropertyType.id // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ ID —Ç–∏–ø–æ–≤ —Å–≤–æ–π—Å—Ç–≤
            );
            if (colorPropertyElement) {
                const colorInputElement = colorPropertyElement.querySelector('input[type="text"]');
                if (colorInputElement) {
                    iconColor = colorInputElement.value.trim() || iconColor; // –ë–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
                }
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        if (iconPreviewSpanElement) {
            const iconFullUrl = `${ICONS_BASE_STATIC_URL}${encodeURIComponent(filename)}`;
            iconPreviewSpanElement.style.backgroundColor = iconColor; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞
            iconPreviewSpanElement.style.webkitMaskImage = `url("${iconFullUrl}")`; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º SVG –º–∞—Å–∫—É
            iconPreviewSpanElement.style.maskImage = `url("${iconFullUrl}")`;
            iconPreviewSpanElement.title = `–§–∞–π–ª: ${filename}\n–¶–≤–µ—Ç: ${iconColor}`;
        }
        if (iconPreviewInfoElement) { // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            iconPreviewInfoElement.textContent = `–§–∞–π–ª: ${filename || '(–Ω–µ —É–∫–∞–∑–∞–Ω)'}, –¶–≤–µ—Ç: ${iconColor || '(–Ω–µ —É–∫–∞–∑–∞–Ω)'}`;
        }
        if (iconPreviewSectionElement) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            iconPreviewSectionElement.style.display = 'block';
        }
    }

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¢–∏–ø–æ–≤ –£–∑–ª–æ–≤ ---
    /** –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —Ç–∏–ø—ã —É–∑–ª–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Ö —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤ —Ç–∞–±–ª–∏—Ü–µ –∏ —Å–µ–ª–µ–∫—Ç–µ —Ä–æ–¥–∏—Ç–µ–ª–µ–π. */
    async function loadAndRenderAllNodeTypes() {
        typeListTableBody.innerHTML = `<tr><td colspan="5" class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤...</td></tr>`;
        typeParentSelectElement.innerHTML = '<option value="">-- –ù–µ—Ç (–ö–æ—Ä–Ω–µ–≤–æ–π —Ç–∏–ø) --</option>'; // –û—á–∏—â–∞–µ–º —Å–µ–ª–µ–∫—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π
        showTypeListFeedback(''); // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º

        try {
            const responseData = await fetchData(API_URL_NODE_TYPES_CRUD + "?limit=10000"); // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ç–∏–ø—ã

            if (responseData && Array.isArray(responseData.items)) {
                allNodeTypesDataCache = responseData.items; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
            } else {
                console.error("API –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤ –Ω–µ –≤–µ—Ä–Ω—É–ª –æ–∂–∏–¥–∞–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É {items: [...]}:", responseData);
                allNodeTypesDataCache = [];
                throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤.");
            }

            renderNodeTypeTable(allNodeTypesDataCache); // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π, –∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —Ç–∏–ø –∏ –µ–≥–æ –ø–æ—Ç–æ–º–∫–æ–≤ (–µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º)
            populateSelect(typeParentSelectElement, allNodeTypesDataCache, 'id', 'name', '-- –ù–µ—Ç (–ö–æ—Ä–Ω–µ–≤–æ–π —Ç–∏–ø) --', true, currentEditingNodeTypeId);

            // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –¥–ª—è —Å–≤–æ–π—Å—Ç–≤, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
            selectedNodeTypeIdForPropsEditing = null;
            propertiesSectionElement.style.display = 'none';
            propertiesTitleElement.textContent = `–°–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è —Ç–∏–ø–∞: (–≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏–∑ —Å–ø–∏—Å–∫–∞)`;
            propertiesListContainerElement.innerHTML = '<p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É–∑–ª–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏.</p>';

        } catch (error) {
            console.error("loadAndRenderAllNodeTypes: –û—à–∏–±–∫–∞:", error);
            typeListTableBody.innerHTML = `<tr><td colspan="5" class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤.</td></tr>`;
            // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ –≤ listFeedbackElement —á–µ—Ä–µ–∑ fetchData
        }
    }

    /** –†–µ–Ω–¥–µ—Ä–∏—Ç —Ç–∞–±–ª–∏—Ü—É —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤ —Å —É—á–µ—Ç–æ–º –∏–µ—Ä–∞—Ä—Ö–∏–∏ –∏ –∏–∫–æ–Ω–æ–∫. */
    function renderNodeTypeTable(nodeTypesToRender) {
        if (!Array.isArray(nodeTypesToRender)) {
            typeListTableBody.innerHTML = `<tr><td colspan="5" class="error-message">–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–∏–ø–æ–≤.</td></tr>`;
            return;
        }
        const itemMap = {}; const rootItems = [];
        // –°—Ç—Ä–æ–∏–º –∫–∞—Ä—Ç—É –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        nodeTypesToRender.forEach(type => { itemMap[type.id] = { ...type, children: [] }; });
        nodeTypesToRender.forEach(type => {
            if (type.parent_type_id === null) { // –ö–æ—Ä–Ω–µ–≤–æ–π —Ç–∏–ø
                if (!rootItems.includes(type.id)) rootItems.push(type.id);
            } else if (itemMap[type.parent_type_id]) {
                itemMap[type.parent_type_id].children.push(type.id);
            } else { // –û—Å–∏—Ä–æ—Ç–µ–≤—à–∏–π —Ç–∏–ø (—Ä–æ–¥–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω) - –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞–∫ –∫–æ—Ä–Ω–µ–≤–æ–π
                console.warn(`–¢–∏–ø —É–∑–ª–∞ ID ${type.id} ('${type.name}') –∏–º–µ–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è ID ${type.parent_type_id}, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –Ω–∞–π–¥–µ–Ω. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞–∫ –∫–æ—Ä–Ω–µ–≤–æ–π.`);
                if (!rootItems.includes(type.id)) rootItems.push(type.id);
            }
        });

        let tableHtmlContent = '';
        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å—Ç—Ä–æ–∫–∏ –∏ –µ–µ –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        function renderRowRecursive(typeId, currentLevel) {
            const typeData = itemMap[typeId];
            if (!typeData) return;

            const parentDisplayName = typeData.parent_type_id !== null ? (itemMap[typeData.parent_type_id]?.name || `ID: ${typeData.parent_type_id}`) : '---';
            const isSelectedClass = selectedNodeTypeIdForPropsEditing === typeData.id ? 'selected' : ''; // –ö–ª–∞—Å—Å –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
            // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –∏–∫–æ–Ω–∫–∏ —Ç–∏–ø–∞ (–µ—Å–ª–∏ –∏–º—è —Ñ–∞–π–ª–∞ —É–∫–∞–∑–∞–Ω–æ)
            const iconHtmlElement = typeData.icon_filename
                ? `<img src="${ICONS_BASE_STATIC_URL}${encodeURIComponent(typeData.icon_filename)}" alt="–ò–∫–æ–Ω–∫–∞ ${typeData.name}" title="–§–∞–π–ª: ${typeData.icon_filename}">`
                : '---';
            // –°–æ–±–∏—Ä–∞–µ–º HTML –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
            tableHtmlContent += `
                <tr class="level-${currentLevel} ${isSelectedClass}" data-id="${typeData.id}" data-type-name="${typeData.name || ''}">
                    <td style="padding-left: ${10 + currentLevel * 20}px;" title="${typeData.description || ''}">${typeData.name || 'N/A'}</td>
                    <td>${parentDisplayName}</td>
                    <td class="icon-cell">${iconHtmlElement}</td>
                    <td>${typeData.priority !== null ? typeData.priority : 'N/A'}</td>
                    <td class="actions">
                        <button class="edit-btn" data-id="${typeData.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø ID ${typeData.id}">‚úèÔ∏è</button>
                        <button class="delete-btn" data-id="${typeData.id}" data-name="${typeData.name || 'N/A'}" title="–£–¥–∞–ª–∏—Ç—å —Ç–∏–ø ID ${typeData.id}">üóëÔ∏è</button>
                    </td>
                </tr>`;
            // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏–º –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–≤ –∏—Ö
            typeData.children
              .map(childId => itemMap[childId]).filter(child => child)
              .sort((a, b) => (a.priority ?? 9999) - (b.priority ?? 9999) || (a.name || '').localeCompare(b.name || ''))
              .forEach(child => renderRowRecursive(child.id, currentLevel + 1));
        }

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º, –Ω–∞—á–∏–Ω–∞—è —Å –∫–æ—Ä–Ω–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        rootItems
            .map(rootId => itemMap[rootId]).filter(root => root)
            .sort((a, b) => (a.priority ?? 9999) - (b.priority ?? 9999) || (a.name || '').localeCompare(b.name || ''))
            .forEach(root => renderRowRecursive(root.id, 0));

        typeListTableBody.innerHTML = tableHtmlContent || `<tr><td colspan="5" style="text-align: center;">–¢–∏–ø—ã —É–∑–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</td></tr>`;
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –∏ CRUD –æ–ø–µ—Ä–∞—Ü–∏–π —Å –¢–∏–ø–∞–º–∏ –£–∑–ª–æ–≤ ---
    /** –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É —Ç–∏–ø–∞ —É–∑–ª–∞ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ). */
    function resetNodeTypeForm() {
        typeFormElement.reset();
        typeIdInputElement.value = '';
        currentEditingNodeTypeId = null;
        typeFormTitleElement.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ù–æ–≤—ã–π –¢–∏–ø –£–∑–ª–∞';
        typeSubmitButton.textContent = '–î–æ–±–∞–≤–∏—Ç—å –¢–∏–ø';
        typeSubmitButton.disabled = false;
        typeCancelButton.style.display = 'none';
        clearValidationErrors('type-form-feedback', 'type-');
        showTypeFormFeedback('');
        // –ü–µ—Ä–µ–∑–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∏–ø–∞
        populateSelect(typeParentSelectElement, allNodeTypesDataCache, 'id', 'name', '-- –ù–µ—Ç (–ö–æ—Ä–Ω–µ–≤–æ–π —Ç–∏–ø) --', true, null);
        iconPreviewSectionElement.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å–≤–æ–π—Å—Ç–≤, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞
        selectedNodeTypeIdForPropsEditing = null;
        propertiesSectionElement.style.display = 'none';
        propertiesTitleElement.textContent = `–°–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è —Ç–∏–ø–∞: (–≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏–∑ —Å–ø–∏—Å–∫–∞)`;
        propertiesListContainerElement.innerHTML = '<p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É–∑–ª–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏.</p>';
        // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
        document.querySelectorAll('#type-list-table-body tr.selected').forEach(tr => tr.classList.remove('selected'));
    }

    /**
     * –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ —Ç–∏–ø–∞ —É–∑–ª–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
     * @param {object} nodeTypeData - –û–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ —Ç–∏–ø–∞ —É–∑–ª–∞.
     */
    function fillNodeTypeFormForEditing(nodeTypeData) {
        if (!nodeTypeData) {
            console.error("fillNodeTypeFormForEditing: –ü–µ—Ä–µ–¥–∞–Ω –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö —Ç–∏–ø–∞ —É–∑–ª–∞.");
            showTypeFormFeedback("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–∏–ø–∞ —É–∑–ª–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.", true);
            return;
        }
        resetNodeTypeForm(); // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        currentEditingNodeTypeId = nodeTypeData.id;
        typeIdInputElement.value = nodeTypeData.id;

        typeNameInputElement.value = nodeTypeData.name || '';
        typePriorityInputElement.value = nodeTypeData.priority !== null ? nodeTypeData.priority : 10;
        typeIconFilenameInputElement.value = nodeTypeData.icon_filename || '';
        typeDescriptionTextareaElement.value = nodeTypeData.description || '';

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π, –∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —Ç–∏–ø –∏ –µ–≥–æ –ø–æ—Ç–æ–º–∫–æ–≤
        populateSelect(typeParentSelectElement, allNodeTypesDataCache, 'id', 'name', '-- –ù–µ—Ç (–ö–æ—Ä–Ω–µ–≤–æ–π —Ç–∏–ø) --', true, currentEditingNodeTypeId);
        typeParentSelectElement.value = nodeTypeData.parent_type_id !== null ? String(nodeTypeData.parent_type_id) : '';

        typeFormTitleElement.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¢–∏–ø –£–∑–ª–∞ ID: ${nodeTypeData.id}`;
        typeSubmitButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
        typeCancelButton.style.display = 'inline-block';
        updateIconPreview(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏

        // –ü–ª–∞–≤–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
        typeFormElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        typeNameInputElement.focus(); // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –∏–º–µ–Ω–∏
    }

    /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã (—Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–∏–ø–∞ —É–∑–ª–∞). */
    async function handleNodeTypeFormSubmit(event) {
        event.preventDefault();
        clearValidationErrors('type-form-feedback', 'type-');
        showTypeFormFeedback('');
        typeSubmitButton.disabled = true;
        typeSubmitButton.textContent = currentEditingNodeTypeId ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';

        const formDataPayload = {
            name: typeNameInputElement.value.trim(),
            parent_type_id: typeParentSelectElement.value ? parseInt(typeParentSelectElement.value, 10) : null,
            priority: typePriorityInputElement.value ? parseInt(typePriorityInputElement.value, 10) : 10,
            icon_filename: typeIconFilenameInputElement.value.trim() || null,
            description: typeDescriptionTextareaElement.value.trim() || null
        };

        // --- –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è ---
        let clientSideErrors = {};
        if (!formDataPayload.name) clientSideErrors.name = '–ò–º—è —Ç–∏–ø–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.';
        if (formDataPayload.icon_filename && formDataPayload.icon_filename.length > 100) clientSideErrors['icon-filename'] = '–ò–º—è —Ñ–∞–π–ª–∞ –∏–∫–æ–Ω–∫–∏ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 100 —Å–∏–º–≤–æ–ª–æ–≤.';
        if (isNaN(formDataPayload.priority) || formDataPayload.priority < 0) clientSideErrors.priority = '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.';
        if (currentEditingNodeTypeId !== null && formDataPayload.parent_type_id === currentEditingNodeTypeId) {
            clientSideErrors['parent-type-id'] = '–¢–∏–ø —É–∑–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–æ–¥–∏—Ç–µ–ª–µ–º –¥–ª—è —Å–∞–º–æ–≥–æ —Å–µ–±—è.';
        }
        if (Object.keys(clientSideErrors).length > 0) {
            displayValidationErrors(clientSideErrors, 'type-form-feedback', 'type-');
            typeSubmitButton.disabled = false;
            typeSubmitButton.textContent = currentEditingNodeTypeId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–î–æ–±–∞–≤–∏—Ç—å –¢–∏–ø';
            return;
        }
        // --- –ö–æ–Ω–µ—Ü –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ---

        const apiUrl = currentEditingNodeTypeId ? API_URL_NODE_TYPE_DETAIL_TEMPLATE.replace('/0', `/${currentEditingNodeTypeId}`) : API_URL_NODE_TYPES_CRUD;
        const httpMethod = currentEditingNodeTypeId ? 'PUT' : 'POST';

        try {
            await fetchData(apiUrl, {
                method: httpMethod,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formDataPayload)
            });
            showTypeListFeedback(`–¢–∏–ø —É–∑–ª–∞ —É—Å–ø–µ—à–Ω–æ ${currentEditingNodeTypeId ? '–æ–±–Ω–æ–≤–ª–µ–Ω' : '–¥–æ–±–∞–≤–ª–µ–Ω'}!`, false);
            resetNodeTypeForm(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            await loadAndRenderAllNodeTypes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∏ —Å–µ–ª–µ–∫—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ ${httpMethod} –¥–ª—è —Ç–∏–ø–∞ —É–∑–ª–∞:`, error);
            displayValidationErrors(error.details || error.message, 'type-form-feedback', 'type-');
            if (!error.details) showTypeFormFeedback(`–û—à–∏–±–∫–∞: ${error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é.'}`, true);
            showTypeListFeedback(`–û—à–∏–±–∫–∞ ${currentEditingNodeTypeId ? '–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è' : '—Å–æ–∑–¥–∞–Ω–∏—è'} —Ç–∏–ø–∞ —É–∑–ª–∞.`, true);
        } finally {
            typeSubmitButton.disabled = false;
            typeSubmitButton.textContent = currentEditingNodeTypeId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–î–æ–±–∞–≤–∏—Ç—å –¢–∏–ø';
        }
    }

    /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" –≤ —Ç–∞–±–ª–∏—Ü–µ —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤. */
    async function handleEditNodeTypeClick(typeId) {
        showTypeListFeedback(`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–∏–ø–∞ ID ${typeId} –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...`);
        const apiUrlGetType = API_URL_NODE_TYPE_DETAIL_TEMPLATE.replace('/0', `/${typeId}`);
        try {
            const nodeTypeToEdit = await fetchData(apiUrlGetType);
            if (nodeTypeToEdit) {
                fillNodeTypeFormForEditing(nodeTypeToEdit);
                showTypeListFeedback(''); // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º —ç—Ç–æ—Ç —Ç–∏–ø –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤
                selectNodeTypeForPropertiesEditing(typeId, nodeTypeToEdit.name);
            }
            // –ï—Å–ª–∏ —Ç–∏–ø –Ω–µ –Ω–∞–π–¥–µ–Ω, fetchData –≤—ã–±—Ä–æ—Å–∏—Ç –æ—à–∏–±–∫—É 404, –∫–æ—Ç–æ—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è –≤ catch
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–∞ —É–∑–ª–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", error);
            if (currentEditingNodeTypeId === typeId) resetNodeTypeForm(); // –°–±—Ä–æ—Å, –µ—Å–ª–∏ –ø—ã—Ç–∞–ª–∏—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –∂–µ
        }
    }

    /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É "–£–¥–∞–ª–∏—Ç—å" –≤ —Ç–∞–±–ª–∏—Ü–µ —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤. */
    async function handleDeleteNodeTypeClick(typeId, typeName) {
        if (typeId === 0) { // –ó–∞—â–∏—Ç–∞ –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ —Ç–∏–ø–∞ ID=0
            alert("–ë–∞–∑–æ–≤—ã–π —Ç–∏–ø —É–∑–ª–∞ (ID=0) –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω.");
            return;
        }
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–∏–ø —É–∑–ª–∞ "${typeName}" (ID: ${typeId})? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –º–æ–∂–µ—Ç –∑–∞—Ç—Ä–æ–Ω—É—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ —É–∑–ª—ã (–∏—Ö —Ç–∏–ø —Å–±—Ä–æ—Å–∏—Ç—Å—è –Ω–∞ –±–∞–∑–æ–≤—ã–π) –∏ –¥–æ—á–µ—Ä–Ω–∏–µ —Ç–∏–ø—ã (—Å—Ç–∞–Ω—É—Ç –∫–æ—Ä–Ω–µ–≤—ã–º–∏ –∏–ª–∏ –∏—Ö —É–¥–∞–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ë–î).`)) {
            return;
        }
        showTypeListFeedback(`–£–¥–∞–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —É–∑–ª–∞ ID ${typeId} ("${typeName}")...`);
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–∏
        document.querySelectorAll('.types-table .actions button, #submit-btn').forEach(btn => btn.disabled = true);

        const apiUrlDeleteType = API_URL_NODE_TYPE_DETAIL_TEMPLATE.replace('/0', `/${typeId}`);
        try {
            await fetchData(apiUrlDeleteType, { method: 'DELETE' });
            showTypeListFeedback(`–¢–∏–ø —É–∑–ª–∞ "${typeName}" (ID: ${typeId}) —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.`, false);
            if (currentEditingNodeTypeId === typeId) resetNodeTypeForm(); // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π
            if (selectedNodeTypeIdForPropsEditing === typeId) { // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ç–∏–ø, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å —Å–≤–æ–π—Å—Ç–≤–∞
                selectedNodeTypeIdForPropsEditing = null;
                propertiesSectionElement.style.display = 'none';
            }
            await loadAndRenderAllNodeTypes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∏ —Å–µ–ª–µ–∫—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∏–ø–∞ —É–∑–ª–∞:", error);
            let displayMsg = `–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${error.message}`;
            if (error.code === 'CONFLICT' || error.status === 409) {
                displayMsg = `–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ç–∏–ø "${typeName}": ${error.details || '–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤ –∏–ª–∏ –¥–æ—á–µ—Ä–Ω–∏—Ö —Ç–∏–ø–æ–≤.'}`;
            }
            showTypeListFeedback(displayMsg, true);
        } finally {
            document.querySelectorAll('.types-table .actions button, #submit-btn').forEach(btn => btn.disabled = false);
        }
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –°–≤–æ–π—Å—Ç–≤–∞–º–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¢–∏–ø–∞ –£–∑–ª–∞ ---

    /** –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã –°–í–û–ô–°–¢–í (–∏–∑ node_property_types) –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞. */
    async function loadAllPropertyTypesForSelect() {
        try {
            allPropertyTypesDataCache = await fetchData(API_URL_NODE_PROPERTY_TYPES_LIST) || [];
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç –≤ —Ñ–æ—Ä–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞
            populateSelect(propertyTypeSelectElement, allPropertyTypesDataCache, 'id', 'name', '-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ --');
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ç–∏–ø–æ–≤ —Å–≤–æ–π—Å—Ç–≤:", error);
            showPropertyFeedback(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ —Å–≤–æ–π—Å—Ç–≤: ${error.message}`, true);
            propertyTypeSelectElement.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
        }
    }

    /** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Ç—Ä–æ–∫—É —Ç–∏–ø–∞ —É–∑–ª–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ. –í—ã–±–∏—Ä–∞–µ—Ç —Ç–∏–ø –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤. */
    function selectNodeTypeForPropertiesEditing(typeId, typeName) {
        selectedNodeTypeIdForPropsEditing = typeId;
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ —Ç–∏–ø–æ–≤
        document.querySelectorAll('#type-list-table-body tr').forEach(tr => tr.classList.remove('selected'));
        const selectedRowInTable = document.querySelector(`#type-list-table-body tr[data-id="${typeId}"]`);
        if (selectedRowInTable) selectedRowInTable.classList.add('selected');

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü–∏–∏ —Å–≤–æ–π—Å—Ç–≤ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –µ–µ
        propertiesTitleElement.innerHTML = `–°–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è —Ç–∏–ø–∞: <strong>${typeName || `ID ${typeId}`}</strong>`;
        propertiesSectionElement.style.display = 'block';
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
        loadAndRenderPropertiesForSelectedType(typeId);
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞
        addPropertyFormElement.reset();
        propertyTypeSelectElement.disabled = false; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç —Ç–∏–ø–∞ —Å–≤–æ–π—Å—Ç–≤–∞
        clearValidationErrors('prop-feedback', 'add-property-'); // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º—ã —Å–≤–æ–π—Å—Ç–≤
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏ (—Ç.–∫. —Ü–≤–µ—Ç –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç —Å–≤–æ–π—Å—Ç–≤–∞)
        updateIconPreview(); // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω–∞ –∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–≤–æ–π—Å—Ç–≤
    }

    /** –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–µ–∫—É—â–∏—Ö —Å–≤–æ–π—Å—Ç–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —É–∑–ª–∞. */
    async function loadAndRenderPropertiesForSelectedType(nodeTypeId) {
        propertiesListContainerElement.innerHTML = `<p class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–π—Å—Ç–≤ –¥–ª—è —Ç–∏–ø–∞ ID ${nodeTypeId}...</p>`;
        showPropertyFeedback(''); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        if (nodeTypeId === null) { // –ï—Å–ª–∏ —Ç–∏–ø –Ω–µ –≤—ã–±—Ä–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã)
            propertiesListContainerElement.innerHTML = '<p>–¢–∏–ø —É–∑–ª–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤.</p>';
            return;
        }

        const apiUrlGetProperties = API_URL_NODE_TYPE_PROPERTIES_TEMPLATE.replace('/0', `/${nodeTypeId}`);
        try {
            const currentProperties = await fetchData(apiUrlGetProperties) || []; // –û–∂–∏–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–≤–æ–π—Å—Ç–≤
            renderCurrentPropertiesList(currentProperties); // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–æ–≤ —Å–≤–æ–π—Å—Ç–≤ (–∏—Å–∫–ª—é—á–∞—è —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —ç—Ç–æ–º—É —Ç–∏–ø—É)
            const existingPropertyTypeIds = new Set(currentProperties.map(p => p.property_type_id));
            const availablePropTypesForSelect = allPropertyTypesDataCache.filter(pt => !existingPropertyTypeIds.has(pt.id));
            populateSelect(propertyTypeSelectElement, availablePropTypesForSelect, 'id', 'name', '-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ --');
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏ (—Ü–≤–µ—Ç –º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è)
            updateIconPreview();
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–π—Å—Ç–≤ –¥–ª—è —Ç–∏–ø–∞ —É–∑–ª–∞ ID ${nodeTypeId}:`, error);
            propertiesListContainerElement.innerHTML = `<p class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–π—Å—Ç–≤.</p>`;
            showPropertyFeedback(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–π—Å—Ç–≤: ${error.message}`, true);
        }
    }

    /** –†–µ–Ω–¥–µ—Ä–∏—Ç —Å–ø–∏—Å–æ–∫ —Ç–µ–∫—É—â–∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–≤–æ–π—Å—Ç–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —É–∑–ª–∞. */
    function renderCurrentPropertiesList(properties) {
        if (!Array.isArray(properties)) {
            propertiesListContainerElement.innerHTML = '<p class="error-message">–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö: —Å–ø–∏—Å–æ–∫ —Å–≤–æ–π—Å—Ç–≤ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.</p>';
            return;
        }
        if (properties.length === 0) {
            propertiesListContainerElement.innerHTML = '<p>–î–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —É–∑–ª–æ–≤ —Å–≤–æ–π—Å—Ç–≤–∞ –µ—â–µ –Ω–µ –∑–∞–¥–∞–Ω—ã.</p>';
            return;
        }
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞
        propertiesListContainerElement.innerHTML = properties.map(prop => `
            <div class="property-item" data-property-type-id="${prop.property_type_id}" data-node-property-id="${prop.id}">
                <label title="${prop.property_description || prop.property_name}">${prop.property_name}:</label>
                <input type="text" value="${prop.property_value || ''}" readonly 
                       data-original-value="${prop.property_value || ''}" 
                       aria-label="–ó–Ω–∞—á–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ ${prop.property_name}">
                <button class="edit-prop-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞">‚úèÔ∏è</button>
                <button class="delete-prop-btn" title="–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–≤–æ–π—Å—Ç–≤–æ —É –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —É–∑–ª–∞">üóëÔ∏è</button>
            </div>
        `).join('');
    }

    /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —É–∑–ª–∞. */
    async function handleAddOrUpdatePropertyFormSubmit(event) {
         event.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
         clearValidationErrors('prop-feedback', 'add-property-'); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ—à–∏–±–∫–∏
         showPropertyFeedback('');

         const isMockEvent = !event.target.elements; // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≤—ã–∑–≤–∞–Ω–æ –ª–∏ –∏–∑ —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ —Ñ–æ—Ä–º—ã
         const propertyTypeIdToAddOrUpdate = isMockEvent ? event.propertyTypeId : propertyTypeSelectElement.value;
         const propertyValueToSet = isMockEvent ? event.value : propertyValueInputElement.value.trim();
         const formSubmitButtonElement = isMockEvent ? null : addPropertyFormElement.querySelector('button[type="submit"]');

         if (selectedNodeTypeIdForPropsEditing === null) {
             showPropertyFeedback("–û—à–∏–±–∫–∞: –¢–∏–ø —É–∑–ª–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞.", true);
             return;
         }
         // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ –≤—ã–±—Ä–∞–Ω –∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–≤–µ–¥–µ–Ω–æ
         if (!propertyTypeIdToAddOrUpdate || propertyValueToSet === '') {
              displayValidationErrors({ value: "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ –∏ –≤–≤–µ—Å—Ç–∏ –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ." }, 'prop-feedback', 'add-property-');
              if(propertyValueInputElement && !isMockEvent) propertyValueInputElement.focus(); // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –∑–Ω–∞—á–µ–Ω–∏—è
             return;
         }

         if(formSubmitButtonElement) { formSubmitButtonElement.disabled = true; formSubmitButtonElement.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...'; }
         showPropertyFeedback("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞...");

         // –ò—Å–ø–æ–ª—å–∑—É–µ–º PUT /api/v1/node_types/{type_id}/properties —Å —Ç–µ–ª–æ–º {"property_type_id": "value"}
         const apiUrlSetProperty = API_URL_NODE_TYPE_PROPERTIES_TEMPLATE.replace('/0', `/${selectedNodeTypeIdForPropsEditing}`);
         const payload = { [propertyTypeIdToAddOrUpdate]: propertyValueToSet }; // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç { "ID_—Ç–∏–ø–∞_—Å–≤–æ–π—Å—Ç–≤–∞": "–∑–Ω–∞—á–µ–Ω–∏–µ" }

         try {
             await fetchData(apiUrlSetProperty, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
              });
             showPropertyFeedback("–°–≤–æ–π—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!", false);
             if(!isMockEvent) addPropertyFormElement.reset(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –æ–Ω–∞)
             // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–≤–æ–π—Å—Ç–≤, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏
             await loadAndRenderPropertiesForSelectedType(selectedNodeTypeIdForPropsEditing);
         } catch(error) {
              console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞:", error);
              displayValidationErrors(error.details || error.message, 'prop-feedback', 'add-property-');
              showPropertyFeedback(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞: ${error.message}`, true);
         } finally {
              if(formSubmitButtonElement) { formSubmitButtonElement.disabled = false; formSubmitButtonElement.textContent = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å'; }
         }
    }

    /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞ —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —É–∑–ª–∞. */
    async function handleDeleteSinglePropertyClick(propertyTypeIdToDelete) {
         if (selectedNodeTypeIdForPropsEditing === null) return; // –ï—Å–ª–∏ —Ç–∏–ø —É–∑–ª–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω
         const propertyTypeInfo = allPropertyTypesDataCache.find(pt => pt.id == propertyTypeIdToDelete);
         const propertyNameForConfirm = propertyTypeInfo ? propertyTypeInfo.name : `ID ${propertyTypeIdToDelete}`;
         if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–æ "${propertyNameForConfirm}" —É —Ç–µ–∫—É—â–µ–≥–æ —Ç–∏–ø–∞ —É–∑–ª–∞?`)) return;

         // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è DELETE /api/v1/node_types/{node_type_id}/properties/{property_type_id}
         const apiUrlDeleteProperty = API_URL_NODE_TYPE_PROPERTY_DELETE_TEMPLATE
                                     .replace('/0/', `/${selectedNodeTypeIdForPropsEditing}/`) // –ó–∞–º–µ–Ω—è–µ–º ID —Ç–∏–ø–∞ —É–∑–ª–∞
                                     .replace('/properties/0', `/properties/${propertyTypeIdToDelete}`); // –ó–∞–º–µ–Ω—è–µ–º ID —Ç–∏–ø–∞ —Å–≤–æ–π—Å—Ç–≤–∞
         showPropertyFeedback(`–£–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ "${propertyNameForConfirm}"...`);
         try {
            await fetchData(apiUrlDeleteProperty, { method: 'DELETE' }); // –û–∂–∏–¥–∞–µ–º 204 No Content
            showPropertyFeedback(`–°–≤–æ–π—Å—Ç–≤–æ "${propertyNameForConfirm}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ.`, false);
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–≤–æ–π—Å—Ç–≤ –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏
            await loadAndRenderPropertiesForSelectedType(selectedNodeTypeIdForPropsEditing);
         } catch (error) {
              console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞:", error);
              showPropertyFeedback(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞: ${error.message}`, true);
         }
    }

    /**
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞.
     * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–µ input –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è.
     */
    function handleEditPropertyValueClick(editButtonElement) {
         const propertyItemDiv = editButtonElement.closest('.property-item');
         const valueInputElement = propertyItemDiv.querySelector('input[type="text"]');
         if (!valueInputElement) return;

         if (valueInputElement.readOnly) { // –ï—Å–ª–∏ –ø–æ–ª–µ –±—ã–ª–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
             valueInputElement.readOnly = false;
             valueInputElement.dataset.originalValue = valueInputElement.value; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
             valueInputElement.focus();
             valueInputElement.select(); // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
             editButtonElement.textContent = 'üíæ'; // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
             editButtonElement.title = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ';
             // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è Enter –∏ Blur
             valueInputElement.addEventListener('keypress', handlePropertyInputKeyPress);
             valueInputElement.addEventListener('blur', handlePropertyInputBlur);
         } else { // –ï—Å–ª–∏ –±—ã–ª–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –ø—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
             const newValue = valueInputElement.value.trim();
             // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–µ –≤ —Ä–µ–∂–∏–º —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
             valueInputElement.readOnly = true;
             editButtonElement.textContent = '‚úèÔ∏è';
             editButtonElement.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞';
             // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
             valueInputElement.removeEventListener('keypress', handlePropertyInputKeyPress);
             valueInputElement.removeEventListener('blur', handlePropertyInputBlur);

             // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
             if (newValue !== valueInputElement.dataset.originalValue) {
                 const propertyTypeIdToUpdate = propertyItemDiv.dataset.propertyTypeId;
                 // –í—ã–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –ø–µ—Ä–µ–¥–∞–≤–∞—è –µ–π ID —Ç–∏–ø–∞ —Å–≤–æ–π—Å—Ç–≤–∞ –∏ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                 // –ò–º–∏—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                 const mockSubmitEvent = { propertyTypeId: propertyTypeIdToUpdate, value: newValue };
                 handleAddOrUpdatePropertyFormSubmit(mockSubmitEvent); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
             } else {
                 showPropertyFeedback("–ó–Ω–∞—á–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ.", false);
             }
         }
    }
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ –∑–Ω–∞—á–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞
    function handlePropertyInputKeyPress(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ –µ—Å—Ç—å)
            const editButton = event.target.closest('.property-item').querySelector('.edit-prop-btn');
            if (editButton) handleEditPropertyValueClick(editButton); // –ò–º–∏—Ç–∏—Ä—É–µ–º –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
        }
    }
     // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ –∑–Ω–∞—á–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞ (–æ—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
     function handlePropertyInputBlur(event) {
         setTimeout(() => { // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —É—Å–ø–µ–ª —Å—Ä–∞–±–æ—Ç–∞—Ç—å –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
              const inputField = event.target;
              const propertyItem = inputField.closest('.property-item');
              const saveButton = propertyItem?.querySelector('.edit-prop-btn');
              // –ï—Å–ª–∏ –ø–æ–ª–µ –≤—Å–µ –µ—â–µ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ñ–æ–∫—É—Å —É—à–µ–ª –ù–ï –Ω–∞ –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
              if (!inputField.readOnly && document.activeElement !== saveButton) {
                 inputField.readOnly = true;
                 inputField.value = inputField.dataset.originalValue; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                 if(saveButton) { saveButton.textContent = '‚úèÔ∏è'; saveButton.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞'; }
                 inputField.removeEventListener('keypress', handlePropertyInputKeyPress);
                 inputField.removeEventListener('blur', handlePropertyInputBlur);
                 showPropertyFeedback("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ.", false);
              }
         }, 150); // 150 –º—Å –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
     }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
    /** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É: –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —Ç–∏–ø—ã —Å–≤–æ–π—Å—Ç–≤ –∏ –≤—Å–µ —Ç–∏–ø—ã —É–∑–ª–æ–≤. */
    async function initializeManageTypesPage() {
         showTypeListFeedback("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞–º–∏...");
         try {
             await loadAllPropertyTypesForSelect(); // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∏–ø—ã –°–í–û–ô–°–¢–í (–¥–ª—è —Å–µ–ª–µ–∫—Ç–∞)
             await loadAndRenderAllNodeTypes();     // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–∏–ø—ã –£–ó–õ–û–í
             showTypeListFeedback(""); // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
         } catch(e) {
              console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞–º–∏:", e);
              showTypeListFeedback(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${e.message}`, true);
              // –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –≤ –¥—Ä—É–≥–∏—Ö —Ñ–∏–¥–±–µ–∫–∞—Ö, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
              typeListTableBody.innerHTML = `<tr><td colspan="5" class="error-message">–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.</td></tr>`;
              propertiesListContainerElement.innerHTML = '<p class="error-message">–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.</p>';
         }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã (–¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¢–ò–ü–ê –£–ó–õ–ê)
    typeFormElement.addEventListener('submit', handleNodeTypeFormSubmit);
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ç–º–µ–Ω–∞" –≤ —Ñ–æ—Ä–º–µ —Ç–∏–ø–∞ —É–∑–ª–∞
    typeCancelButton.addEventListener('click', resetNodeTypeForm);
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è –°–í–û–ô–°–¢–í–ê –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
    addPropertyFormElement.addEventListener('submit', handleAddOrUpdatePropertyFormSubmit);
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∫–æ–Ω–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞ —Ü–≤–µ—Ç–∞
    typeIconFilenameInputElement.addEventListener('input', updateIconPreview);
    propertiesListContainerElement.addEventListener('input', (event) => { // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∏–Ω–ø—É—Ç–æ–≤ —Å–≤–æ–π—Å—Ç–≤
        const targetInput = event.target.closest('.property-item input[type="text"]');
        if (targetInput) {
            const propItem = targetInput.closest('.property-item');
            const colorPropType = allPropertyTypesDataCache.find(p => p.name === 'icon_color');
            if (propItem && colorPropType && propItem.dataset.propertyTypeId == colorPropType.id) {
                 updateIconPreview(); // –û–±–Ω–æ–≤–ª—è–µ–º, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è —Ü–≤–µ—Ç
            }
        }
    });

    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å–ø–∏—Å–∫–∞ –¢–ò–ü–û–í –£–ó–õ–û–í
    typeListTableBody.addEventListener('click', (event) => {
        const editButton = event.target.closest('.edit-btn');
        const deleteButton = event.target.closest('.delete-btn');
        const tableRow = event.target.closest('tr[data-id]'); // –ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ

        if (editButton) { // –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
            event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–±–æ—Ä —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤–Ω—É—Ç—Ä–∏ –Ω–µ–µ
            handleEditNodeTypeClick(parseInt(editButton.dataset.id, 10));
        } else if (deleteButton) { // –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–£–¥–∞–ª–∏—Ç—å"
            event.stopPropagation();
            handleDeleteNodeTypeClick(parseInt(deleteButton.dataset.id, 10), deleteButton.dataset.name);
        } else if (tableRow) { // –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ —Å–∞–º–æ–π —Å—Ç—Ä–æ–∫–µ (–Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ –≤–Ω—É—Ç—Ä–∏)
            // –í—ã–±–∏—Ä–∞–µ–º —ç—Ç–æ—Ç —Ç–∏–ø –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤
            selectNodeTypeForPropertiesEditing(parseInt(tableRow.dataset.id, 10), tableRow.dataset.typeName);
        }
    });

    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/–£–¥–∞–ª–∏—Ç—å" –≤ —Å–ø–∏—Å–∫–µ –°–í–û–ô–°–¢–í
    propertiesListContainerElement.addEventListener('click', (event) => {
         const deletePropButton = event.target.closest('.delete-prop-btn');
         const editPropButton = event.target.closest('.edit-prop-btn');
         if (deletePropButton) {
             const propTypeId = deletePropButton.closest('.property-item')?.dataset.propertyTypeId;
             if (propTypeId) handleDeleteSinglePropertyClick(parseInt(propTypeId, 10));
         } else if (editPropButton) {
             handleEditPropertyValueClick(editPropButton);
         }
    });

    // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ DOM
    document.addEventListener('DOMContentLoaded', initializeManageTypesPage);
</script>
{% endblock %}