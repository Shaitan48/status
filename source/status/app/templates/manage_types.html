<!-- status/app/templates/manage_types.html -->
{% extends "base.html" %}
{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¢–∏–ø–∞–º–∏ –£–∑–ª–æ–≤ - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ü–¢–ö{% endblock %}

{% block head_extra %}
<style>
    /* --- –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã --- */
    .manage-container { display: grid; grid-template-columns: minmax(350px, 1fr) 2fr; gap: 2rem; align-items: start; margin-top: 1rem; }
    .form-section { background-color: var(--card-bg); padding: 1.5rem; border-radius: 5px; box-shadow: var(--card-shadow); position: sticky; top: 80px; /* –õ–∏–ø–∫–∞—è —Ñ–æ—Ä–º–∞ */ }
    .form-section h3, .list-section h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 0.8rem; margin-bottom: 1rem; }
    .list-section { background-color: var(--card-bg); padding: 1.5rem; border-radius: 5px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); }

    /* --- –°—Ç–∏–ª–∏ —Ñ–æ—Ä–º—ã –¢–∏–ø–∞ –£–∑–ª–∞ --- */
    .form-grid-type { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem 1.5rem; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.95em; }
    .form-group input[type="text"], .form-group input[type="number"], .form-group select, .form-group textarea {
        width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em;
    }
    .form-group textarea { min-height: 60px; resize: vertical; grid-column: 1 / -1; } /* –û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
    .form-actions { margin-top: 1.5rem; text-align: right; display: flex; justify-content: flex-end; gap: 0.5rem; grid-column: 1 / -1; }
    #cancel-edit-btn { background-color: var(--secondary-color); }
    #cancel-edit-btn:hover { background-color: #5a6268; }

    /* --- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏ –≤ —Ñ–æ—Ä–º–µ --- */
    #icon-preview-section { margin-top: 1rem; grid-column: 1 / -1; }
    #icon-preview-section h5 { margin-bottom: 0.5rem; font-size: 0.95em; color: #555; }
    .icon-preview-container { display: flex; align-items: center; gap: 10px; padding: 8px; background-color: #f8f9fa; border: 1px solid #eee; border-radius: 4px;}
    .icon-preview-element { /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∞–º–æ–≥–æ –±–ª–æ–∫–∞ –∏–∫–æ–Ω–∫–∏ */
        display: inline-block; width: 32px; height: 32px; background-color: grey; /* –¶–≤–µ—Ç –±—É–¥–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω JS */
        -webkit-mask-size: contain; mask-size: contain; -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
        -webkit-mask-position: center; mask-position: center; border: 1px solid #ccc; flex-shrink: 0; border-radius: 3px;
    }
    .icon-preview-info { font-size: 0.9em; color: #555; }

    /* --- –°—Ç–∏–ª–∏ —Å–ø–∏—Å–∫–∞ –¢–∏–ø–æ–≤ --- */
    .types-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .types-table th, .types-table td { border: 1px solid var(--border-color); padding: 8px 12px; text-align: left; vertical-align: middle; }
    .types-table th { background-color: var(--light-grey); font-weight: 600; white-space: nowrap; }
    .types-table .actions { text-align: center; white-space: nowrap; width: 90px; } /* –§–∏–∫—Å. —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
    .types-table .actions button { padding: 4px 8px; font-size: 0.9em; margin-right: 5px; cursor: pointer; border: none; border-radius: 3px; color: white; }
    .types-table .edit-btn { background-color: var(--warning-color); color: #333; }
    .types-table .delete-btn { background-color: var(--danger-color); }
    .types-table tr.selected { background-color: #e2f3ff; }
    .types-table tr:not(.selected):hover { background-color: #f8f9fa; cursor: pointer;}
    .types-table .icon-cell { text-align: center; width: 60px; } /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∏–∫–æ–Ω–∫—É */
    .types-table .icon-cell img { max-width: 20px; max-height: 20px; vertical-align: middle; }
    /* –ò–µ—Ä–∞—Ä—Ö–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ */
    .types-table .level-0 { font-weight: bold; }
    .types-table .level-1 td:first-child { padding-left: 30px !important; }
    .types-table .level-2 td:first-child { padding-left: 50px !important; }
    .types-table .level-3 td:first-child { padding-left: 70px !important; }

    /* --- –°—Ç–∏–ª–∏ —Å–µ–∫—Ü–∏–∏ –°–≤–æ–π—Å—Ç–≤ (–ø–æ—á—Ç–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
    #properties-section { margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid var(--primary-color); }
    #properties-section h4 { margin-top: 0; margin-bottom: 1rem; }
    .properties-list { margin-bottom: 1.5rem; max-height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 0.5rem; border-radius: 4px;}
    .property-item { display: flex; align-items: center; gap: 10px; margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px dashed #eee; }
    .property-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .property-item label { flex-basis: 180px; flex-shrink: 0; font-size: 0.9em; color: #333; text-align: right; }
    .property-item input { flex-grow: 1; }
    .property-item button { padding: 3px 7px; font-size: 0.85em; flex-shrink: 0; background-color: var(--danger-color);}
    #add-property-form { display: flex; gap: 10px; align-items: flex-end; }
    #add-property-form select { flex-basis: 200px; }
    #add-property-form input { flex-grow: 1; }
    #add-property-form button { flex-shrink: 0; }

    /* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–¥–±–µ–∫–∞ --- */
    .error-feedback { color: var(--danger-color); font-size: 0.9em; margin-top: 5px; }
    .success-feedback { color: var(--success-color); font-size: 0.9em; margin-top: 5px; }
    .feedback-area { min-height: 1.5em; margin-top: 1rem; font-weight: 500; text-align: center; padding: 5px; border-radius: 3px; }
    .feedback-area.error-feedback { color: var(--danger-color); background-color: #f8d7da; border: 1px solid #f5c6cb; }
    .feedback-area.success-feedback { color: var(--success-color); background-color: #d4edda; border: 1px solid #c3e6cb;}
    #form-feedback, #list-feedback, #prop-feedback { min-height: 1.5em; margin-top: 1rem; font-weight: 500; text-align: center; }
</style>
{% endblock %}

{% block content %}
<h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¢–∏–ø–∞–º–∏ –£–∑–ª–æ–≤ –∏ –∏—Ö –°–≤–æ–π—Å—Ç–≤–∞–º–∏</h2>

<div id="list-feedback"></div> <!-- –§–∏–¥–±–µ–∫ –¥–ª—è —Å–ø–∏—Å–∫–∞ -->

<div class="manage-container">

    <!-- –°–µ–∫—Ü–∏—è —Å —Ñ–æ—Ä–º–æ–π –¥–ª—è –¢–ò–ü–ê –£–ó–õ–ê -->
    <section class="form-section">
        <h3 id="form-title">–î–æ–±–∞–≤–∏—Ç—å –¢–∏–ø –£–∑–ª–∞</h3>
        <form id="type-form">
            <input type="hidden" id="type-id"> <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è ID –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ -->

            <div class="form-grid-type">
                <!-- –ò–º—è —Ç–∏–ø–∞ -->
                <div class="form-group">
                    <label for="type-name">–ò–º—è —Ç–∏–ø–∞ *</label>
                    <input type="text" id="type-name" required>
                     <div class="error-feedback" id="type-name-error"></div> <!-- –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ -->
                </div>
                <!-- –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —Ç–∏–ø -->
                 <div class="form-group">
                    <label for="type-parent">–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —Ç–∏–ø</label>
                    <select id="type-parent">
                        <option value="">-- –ù–µ—Ç (–ö–æ—Ä–Ω–µ–≤–æ–π) --</option>
                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ -->
                    </select>
                     <div class="error-feedback" id="type-parent-error"></div>
                </div>
                <!-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç -->
                 <div class="form-group">
                    <label for="type-priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                    <input type="number" id="type-priority" value="10" min="0">
                </div>
                <!-- –ò–º—è —Ñ–∞–π–ª–∞ –∏–∫–æ–Ω–∫–∏ -->
                <div class="form-group">
                    <label for="type-icon-filename">–ò–º—è —Ñ–∞–π–ª–∞ –∏–∫–æ–Ω–∫–∏ (–≤ /static/icons/)</label>
                    <input type="text" id="type-icon-filename" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, server.svg">
                     <div class="error-feedback" id="type-icon-filename-error"></div>
                </div>

                <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                <div class="form-group">
                    <label for="type-description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="type-description"></textarea>
                </div>

                <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏ -->
                <div id="icon-preview-section" style="display: none;">
                     <h5>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏:</h5>
                     <div class="icon-preview-container">
                         <span class="icon-preview-element" id="icon-preview"></span>
                         <span class="icon-preview-info" id="icon-preview-info"></span>
                     </div>
                 </div>

                <!-- –§–∏–¥–±–µ–∫ —Ñ–æ—Ä–º—ã –∏ –∫–Ω–æ–ø–∫–∏ -->
                <div id="form-feedback" class="feedback-area error-feedback"></div> <!-- –û–±—â–∏–µ –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º—ã -->
                <div class="form-actions">
                    <button type="button" id="cancel-edit-btn" style="display: none;">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" id="submit-btn">–î–æ–±–∞–≤–∏—Ç—å –¢–∏–ø</button>
                </div>
            </div> <!-- –ö–æ–Ω–µ—Ü form-grid-type -->
        </form>

        <!-- –°–µ–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞–º–∏ –í–´–ë–†–ê–ù–ù–û–ì–û —Ç–∏–ø–∞ -->
        <div id="properties-section" style="display: none;">
            <h4 id="properties-title">–°–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è —Ç–∏–ø–∞: </h4>
            <div id="prop-feedback" class="feedback-area"></div>

            <!-- –¢–µ–∫—É—â–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ -->
            <h5>–¢–µ–∫—É—â–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞:</h5>
            <div class="properties-list" id="properties-list-container">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É–∑–ª–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ø—Ä–∞–≤–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏.</p>
            </div>

            <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞ -->
            <h5>–î–æ–±–∞–≤–∏—Ç—å/–ò–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–æ:</h5>
            <form id="add-property-form">
                <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                    <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ —Å–≤–æ–π—Å—Ç–≤–∞ -->
                    <div style="flex-grow: 1;">
                        <label for="property-type-select">–¢–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ *</label>
                        <select id="property-type-select" required>
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ --</option>
                        </select>
                    </div>
                    <!-- –í–≤–æ–¥ –∑–Ω–∞—á–µ–Ω–∏—è -->
                    <div style="flex-grow: 2;">
                        <label for="property-value-input">–ó–Ω–∞—á–µ–Ω–∏–µ *</label>
                        <input type="text" id="property-value-input" required>
                    </div>
                    <!-- –ö–Ω–æ–ø–∫–∞ -->
                    <button type="submit" style="flex-shrink: 0;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div class="error-feedback" id="add-property-form-error"></div>
            </form>
        </div>
    </section>

    <!-- –°–µ–∫—Ü–∏—è —Å–æ —Å–ø–∏—Å–∫–æ–º –¢–ò–ü–û–í –£–ó–õ–û–í -->
    <section class="list-section">
        <h3>–°–ø–∏—Å–æ–∫ –¢–∏–ø–æ–≤ –£–∑–ª–æ–≤</h3>
        <table class="types-table">
            <thead>
                <tr>
                    <th>–ò–º—è –¢–∏–ø–∞</th>
                    <th>–†–æ–¥–∏—Ç–µ–ª—å</th>
                    <th>–ò–∫–æ–Ω–∫–∞</th> <!-- –ö–æ–ª–æ–Ω–∫–∞ –∏–∫–æ–Ω–∫–∏ -->
                    <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="type-list">
                <tr><td colspan="5" class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–∏–ø–æ–≤...</td></tr>
            </tbody>
        </table>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM ---
    // –§–æ—Ä–º–∞ —Ç–∏–ø–∞ —É–∑–ª–∞
    const typeForm = document.getElementById('type-form');
    const typeFormTitle = document.getElementById('form-title');
    const typeSubmitBtn = document.getElementById('submit-btn');
    const typeCancelBtn = document.getElementById('cancel-edit-btn');
    const typeList = document.getElementById('type-list'); // tbody —Ç–∞–±–ª–∏—Ü—ã
    const typeParentSelect = document.getElementById('type-parent');
    const typeFormFeedback = document.getElementById('form-feedback');
    const listFeedback = document.getElementById('list-feedback'); // –§–∏–¥–±–µ–∫ –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–µ–π
    // –ü–æ–ª—è —Ñ–æ—Ä–º—ã —Ç–∏–ø–∞
    const typeIdInput = document.getElementById('type-id');
    const typeNameInput = document.getElementById('type-name');
    const typePriorityInput = document.getElementById('type-priority');
    const typeIconFilenameInput = document.getElementById('type-icon-filename'); // –ü–æ–ª–µ –¥–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏–∫–æ–Ω–∫–∏
    const typeDescriptionTextarea = document.getElementById('type-description');
    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏
    const iconPreviewSection = document.getElementById('icon-preview-section');
    const iconPreviewElement = document.getElementById('icon-preview');
    const iconPreviewInfo = document.getElementById('icon-preview-info');

    // –°–µ–∫—Ü–∏—è –∏ —Ñ–æ—Ä–º–∞ —Å–≤–æ–π—Å—Ç–≤
    const propsSection = document.getElementById('properties-section');
    const propsTitle = document.getElementById('properties-title');
    const propsListContainer = document.getElementById('properties-list-container');
    const addPropForm = document.getElementById('add-property-form');
    const propTypeSelect = document.getElementById('property-type-select');
    const propValueInput = document.getElementById('property-value-input');
    const propFeedback = document.getElementById('prop-feedback');

    // --- API URL ---
    const API_URL_NODE_TYPES = "{{ url_for('node_types.api_get_node_types') }}"; // GET (list), POST
    const API_URL_NODE_TYPE_DETAIL_TPL = "{{ url_for('node_types.api_get_node_type', type_id=0) }}"; // GET, PUT, DELETE
    const API_URL_NODE_PROPERTY_TYPES = "{{ url_for('node_properties.api_get_node_property_types') }}"; // GET list (–±–µ–∑ icon_filename)
    const API_URL_NODE_TYPE_PROPERTIES_TPL = "{{ url_for('node_properties.api_get_node_properties', type_id=0) }}"; // GET, PUT (props)
    const API_URL_NODE_TYPE_PROPERTY_DELETE_TPL = "{{ url_for('node_properties.api_delete_node_property', type_id=0, property_type_id=0) }}"; // DELETE prop

    // –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è –∏–∫–æ–Ω–æ–∫ (–¥–ª—è JS)
    const ICONS_BASE_URL_JS = "{{ url_for('static', filename='icons/') }}";

    // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è ---
    let nodeTypesData = [];     // –ö—ç—à —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤ (–≤–∫–ª—é—á–∞—è icon_filename)
    let propertyTypesData = []; // –ö—ç—à —Ç–∏–ø–æ–≤ —Å–≤–æ–π—Å—Ç–≤ (–±–µ–∑ icon_filename)
    let currentEditTypeId = null; // ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ —Ç–∏–ø–∞
    let selectedTypeIdForProps = null; // ID —Ç–∏–ø–∞, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Å–≤–æ–π—Å—Ç–≤–∞

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
    async function fetchData(url, options = {}) {
        const response = await fetch(url, options);
        if (!response.ok) {
            let errorText = `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${response.status} ${response.statusText}`;
            let errorDetails = null;
            let errorCode = 'NETWORK_ERROR'; // –ö–æ–¥ –æ—à–∏–±–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

            try {
                 const errorData = await response.json();
                 // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
                 if (errorData && errorData.error) {
                    errorCode = errorData.error.code || 'API_ERROR'; // –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –æ—à–∏–±–∫–∏ API, –µ—Å–ª–∏ –µ—Å—Ç—å
                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    if (errorData.error.message) {
                         errorText += ` - ${errorData.error.message}`;
                    } else if (typeof errorData.error === 'string') { // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∞
                         errorText += ` - ${errorData.error}`;
                    }
                    // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å (–¥–ª—è –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏), –∏–Ω–∞—á–µ –±–µ—Ä–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –≤–µ—Å—å –æ–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏
                    errorDetails = errorData.error.details || errorData.error.message || errorData.error;
                 } else if (errorData && typeof errorData === 'string') { // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç - –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∞
                    errorText += ` - ${errorData}`;
                    errorDetails = errorData;
                 } else {
                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞
                    errorDetails = errorData; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ, —á—Ç–æ –ø—Ä–∏—à–ª–æ
                 }
            } catch (e) {
                console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON –æ—Ç–≤–µ—Ç–∞ —Å –æ—à–∏–±–∫–æ–π:", e);
                // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ –∫–∞–∫ —Ç–µ–∫—Å—Ç
                try {
                    const rawErrorText = await response.text();
                    errorText += ` - ${rawErrorText}`;
                    errorDetails = rawErrorText;
                } catch (e2) { /* –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏ —Ç–µ–∫—Å—Ç */ }
            }

            const error = new Error(errorText);
            error.details = errorDetails; // –î–µ—Ç–∞–ª–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤ UI –∏–ª–∏ –ª–æ–≥–∞—Ö
            error.code = errorCode;       // –ö–æ–¥ –æ—à–∏–±–∫–∏ API
            error.status = response.status; // HTTP —Å—Ç–∞—Ç—É—Å
            throw error; // –ë—Ä–æ—Å–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π –æ–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏
        }
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (2xx)
        if (response.status === 204) return null; // –£—Å–ø–µ—à–Ω–æ, –Ω–æ –Ω–µ—Ç —Ç–µ–ª–∞ (DELETE)
        // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –Ω–æ –≥–æ—Ç–æ–≤—ã –∫ –ø—É—Å—Ç–æ–º—É –æ—Ç–≤–µ—Ç—É –∏–ª–∏ —Ç–µ–∫—Å—Ç—É
        const text = await response.text();
        try {
             return text ? JSON.parse(text) : null;
        } catch (e) {
             console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:", text);
             return { rawText: text }; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –Ω–µ JSON
        }
    }


    // –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è/–æ—á–∏—Å—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –æ—à–∏–±–æ–∫
    function displayValidationErrors(errors, prefix = 'type-') {
         clearValidationErrors(prefix); let firstErrorField = null;
         const feedbackEl = prefix === 'type-' ? typeFormFeedback : propFeedback;
         // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—à–∏–±–∫–∏ –ø–æ –ø–æ–ª—è–º
         if (errors && typeof errors === 'object') {
             for (const field in errors) {
                 // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –ø–æ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, parent_type_id -> type-parent)
                 const fieldId = field.replace(/_id$/, '').replace(/_([a-z])/g, (match, p1) => p1.toUpperCase());
                 const errorElementId = `${prefix}${fieldId}-error`;
                 const fieldElementId = `${prefix}${fieldId}`;
                 const errorElement = document.getElementById(errorElementId);
                 const fieldElement = document.getElementById(fieldElementId);

                 if (errorElement) {
                     errorElement.textContent = errors[field];
                     if (!firstErrorField && fieldElement) firstErrorField = fieldElement;
                     if (fieldElement) fieldElement.classList.add('invalid'); // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–ª—è
                 } else { // –ï—Å–ª–∏ –Ω–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ div'–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –æ–±—â–µ–º —Ñ–∏–¥–±–µ–∫–µ
                    console.warn(`Element with id ${errorElementId} not found for field ${field}. Showing in general feedback.`);
                    feedbackEl.textContent += ` ${field}: ${errors[field]}`; // –î–æ–±–∞–≤–ª—è–µ–º –∫ –æ–±—â–µ–º—É
                 }
             }
             if (!feedbackEl.textContent) { // –ï—Å–ª–∏ –≤—Å–µ –æ—à–∏–±–∫–∏ —É—à–ª–∏ –≤ error-—ç–ª–µ–º–µ–Ω—Ç—ã
                 feedbackEl.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ.";
             }
             feedbackEl.className = 'feedback-area error-feedback';
         } else if (typeof errors === 'string') { // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∞
             feedbackEl.textContent = errors;
             feedbackEl.className = 'feedback-area error-feedback';
         }
         // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–º –ø–æ–ª–µ —Å –æ—à–∏–±–∫–æ–π
         if (firstErrorField) { firstErrorField.focus(); }
     }

    function clearValidationErrors(prefix = 'type-') {
        const feedbackEl = prefix === 'type-' ? typeFormFeedback : propFeedback;
        feedbackEl.textContent = ''; feedbackEl.className = 'feedback-area';
        document.querySelectorAll(`#${prefix}-form .error-feedback`).forEach(el => el.textContent = '');
        document.querySelectorAll(`#${prefix}-form input.invalid, #${prefix}-form select.invalid, #${prefix}-form textarea.invalid`)
                .forEach(el => el.classList.remove('invalid'));
    }

    function showListFeedback(message, isError = false) {
        listFeedback.textContent = message;
        listFeedback.className = message ? (isError ? 'error-feedback' : 'success-feedback') : ''; // –ö–ª–∞—Å—Å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        listFeedback.style.padding = message ? '5px' : '0'; // –£–±–∏—Ä–∞–µ–º padding –µ—Å–ª–∏ –ø—É—Å—Ç–æ
        listFeedback.style.border = message ? `1px solid ${isError ? '#f5c6cb' : '#c3e6cb'}` : 'none';
        listFeedback.style.backgroundColor = message ? (isError ? '#f8d7da' : '#d4edda') : 'transparent';
    }

    function showPropFeedback(message, isError = false) {
        propFeedback.textContent = message;
        propFeedback.className = 'feedback-area ' + (message ? (isError ? 'error-feedback' : 'success-feedback') : '');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∫–æ–Ω–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã –∏ —Å–≤–æ–π—Å—Ç–≤
    function updateIconPreviewFromForm() {
        const filename = typeIconFilenameInput.value.trim() || 'other.svg'; // –ë–µ—Ä–µ–º –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
        const propColorType = propertyTypesData.find(p => p.name === 'icon_color'); // –ù–∞—Ö–æ–¥–∏–º —Ç–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ —Ü–≤–µ—Ç–∞
        let color = '#808080'; // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π —Å–µ—Ä—ã–π —Ü–≤–µ—Ç

        // –ò—â–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ 'icon_color' –¥–ª—è –í–´–ë–†–ê–ù–ù–û–ì–û —Ç–∏–ø–∞
        if (selectedTypeIdForProps !== null && propColorType) { // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å null
             const currentPropsItems = propsListContainer.querySelectorAll('.property-item');
             const colorItem = Array.from(currentPropsItems).find(item => item.dataset.propertyTypeId == propColorType.id);
             if (colorItem) {
                 // –ë–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ input'–∞ —ç—Ç–æ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞
                 color = colorItem.querySelector('input')?.value.trim() || color;
             }
             // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ–ª–ª–±—ç–∫ –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∏–∑ nodeTypesData, –µ—Å–ª–∏ —Å–≤–æ–π—Å—Ç–≤–∞ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã/–æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω—ã
             // else {
             //    const typeData = nodeTypesData.find(t => t.id === selectedTypeIdForProps);
             //    if (typeData && typeData.properties) { /* ... */ }
             // }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        if (iconPreviewElement) {
            const iconUrl = `${ICONS_BASE_URL_JS}${encodeURIComponent(filename)}`; // –ö–æ–¥–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
            iconPreviewElement.style.backgroundColor = color; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º SVG –º–∞—Å–∫—É
            iconPreviewElement.style.webkitMaskImage = `url("${iconUrl}")`;
            iconPreviewElement.style.maskImage = `url("${iconUrl}")`;
            iconPreviewElement.title = `–§–∞–π–ª: ${filename}\n–¶–≤–µ—Ç: ${color}`; // –ü–æ–¥—Å–∫–∞–∑–∫–∞
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        if (iconPreviewInfo) {
            iconPreviewInfo.textContent = `–§–∞–π–ª: ${filename || '(–Ω–µ –∑–∞–¥–∞–Ω)'}, –¶–≤–µ—Ç: ${color || '(–Ω–µ –∑–∞–¥–∞–Ω)'}`;
        }
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        if (iconPreviewSection) {
            iconPreviewSection.style.display = 'block';
        }
    }

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¢–ò–ü–û–í –£–ó–õ–û–í ---
    async function loadAndRenderNodeTypes() {
        typeList.innerHTML = `<tr><td colspan="5" class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–∏–ø–æ–≤...</td></tr>`;
        typeParentSelect.innerHTML = '<option value="">-- –ù–µ—Ç (–ö–æ—Ä–Ω–µ–≤–æ–µ) --</option>';
        showListFeedback(''); // –û—á–∏—â–∞–µ–º —Ñ–∏–¥–±–µ–∫ –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º

        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ (—Ç–µ–ø–µ—Ä—å —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –í–°–ï —Ç–∏–ø—ã –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤ –∏ –¥–µ—Ä–µ–≤–∞ (limit –Ω–µ —Å—Ç–∞–≤–∏–º, API –≤–µ—Ä–Ω–µ—Ç –≤—Å–µ –µ—Å–ª–∏ limit=None)
            const responseData = await fetchData(API_URL_NODE_TYPES);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –º–∞—Å—Å–∏–≤ 'items'
            if (responseData && Array.isArray(responseData.items)) {
                nodeTypesData = responseData.items;
                // const totalNodeTypes = responseData.total_count; // –î–ª—è –±—É–¥—É—â–µ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
                console.debug(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${nodeTypesData.length} —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤.`); // –ò—Å–ø–æ–ª—å–∑—É–µ–º console.debug
            } else {
                 console.error("API /node_types –Ω–µ –≤–µ—Ä–Ω—É–ª –æ–∂–∏–¥–∞–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É {items: [...]}:", responseData);
                 nodeTypesData = []; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                 throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤."); // –í—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
            }

            // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π
            renderTypeTable(nodeTypesData);
            populateSelect(typeParentSelect, nodeTypesData, 'id', 'name', '-- –ù–µ—Ç (–ö–æ—Ä–Ω–µ–≤–æ–µ) --', true, currentEditTypeId);
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤
            selectedTypeIdForProps = null;
            propsSection.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å–≤–æ–π—Å—Ç–≤
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –≤ loadAndRenderNodeTypes:", error); // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω—É—é –æ—à–∏–±–∫—É
            typeList.innerHTML = `<tr><td colspan="5" class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤.</td></tr>`;
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º error.message, –∫–æ—Ç–æ—Ä—ã–π —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π –æ—Ç fetchData
            showListFeedback(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤: ${error.message}`, true);
        }
    }


    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã —Ç–∏–ø–æ–≤ (—Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π –∏ –∏–∫–æ–Ω–∫–æ–π)
    function renderTypeTable(types) {
        // –°—Ç—Ä–æ–∏–º –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
         const map = {}; const roots = [];
         types.forEach(t => { map[t.id] = { ...t, children: [] }; });
         types.forEach(t => {
             if (t.parent_type_id === null) { // –°—Ç—Ä–æ–≥–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å null
                if(!roots.includes(t.id)) roots.push(t.id);
             }
             else if (map[t.parent_type_id]) {
                 map[t.parent_type_id].children.push(t.id);
             }
             else { // –û—Å–∏—Ä–æ—Ç–µ–≤—à–∏–µ - –≤ –∫–æ—Ä–µ–Ω—å
                 console.warn(`–¢–∏–ø ${t.id} (${t.name}) –∏–º–µ–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è ${t.parent_type_id}, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –Ω–∞–π–¥–µ–Ω. –î–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–µ–Ω—å.`);
                 if(!roots.includes(t.id)) roots.push(t.id);
             }
         });

         let tableHtml = '';
         // –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å—Ç—Ä–æ–∫
         function renderRowRecursive(typeId, level) {
              const t = map[typeId]; if (!t) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —Ç–∏–ø –Ω–µ –Ω–∞–π–¥–µ–Ω (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
              const parentName = t.parent_type_id !== null ? (map[t.parent_type_id]?.name || `ID: ${t.parent_type_id}`) : '---';
              const selectedClass = selectedTypeIdForProps === t.id ? 'selected' : ''; // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
              // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –∏–∫–æ–Ω–∫–∏ —Ç–∏–ø–∞
              const iconHtml = t.icon_filename ? `<img src="${ICONS_BASE_URL_JS}${encodeURIComponent(t.icon_filename)}" alt="" title="${t.icon_filename}">` : '---';

              // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã
              tableHtml += `
                  <tr class="level-${level} ${selectedClass}" data-id="${t.id}" data-type-name="${t.name}">
                      <td style="padding-left: ${10 + level * 20}px;">${t.name || 'N/A'}</td>
                      <td>${parentName}</td>
                      <td class="icon-cell">${iconHtml}</td> <!-- –Ø—á–µ–π–∫–∞ —Å –∏–∫–æ–Ω–∫–æ–π -->
                      <td>${t.priority !== null ? t.priority : '?'}</td> <!-- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç -->
                      <td class="actions">
                          <button class="edit-btn" data-id="${t.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                          <button class="delete-btn" data-id="${t.id}" data-name="${t.name}" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                      </td>
                  </tr>
              `;
              // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏–º –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã, —Å–æ—Ä—Ç–∏—Ä—É—è –∏—Ö
              t.children
                .map(id => map[id]) // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –¥–µ—Ç–µ–π
                .filter(child => child) // –£–±–∏—Ä–∞–µ–º –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–µ—Ç–µ–π (–µ—Å–ª–∏ –≤–¥—Ä—É–≥)
                .sort((a, b) => (a.priority - b.priority) || a.name.localeCompare(b.name)) // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É, –∑–∞—Ç–µ–º –ø–æ –∏–º–µ–Ω–∏
                .forEach(child => renderRowRecursive(child.id, level + 1));
         }

         // –†–µ–Ω–¥–µ—Ä–∏–º –Ω–∞—á–∏–Ω–∞—è —Å –∫–æ—Ä–Ω–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤, —Å–æ—Ä—Ç–∏—Ä—É—è –∏—Ö
         roots
            .map(id => map[id]) // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –∫–æ—Ä–Ω–µ–π
            .filter(root => root)
            .sort((a, b) => (a.priority - b.priority) || a.name.localeCompare(b.name)) // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–æ—Ä–Ω–µ–π
            .forEach(root => renderRowRecursive(root.id, 0));

         // –û–±–Ω–æ–≤–ª—è–µ–º tbody —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø—É—Å—Ç–æ
         typeList.innerHTML = tableHtml || `<tr><td colspan="5" style="text-align: center;">–¢–∏–ø—ã —É–∑–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</td></tr>`;
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ–ª–µ–∫—Ç–∞
    function populateSelect(selectElement, items, valueField, textField, placeholder, addHierarchy = false, excludeId = null) {
        const currentSelectedValue = selectElement.value; selectElement.innerHTML = `<option value="">${placeholder}</option>`;
        if (!Array.isArray(items) || items.length === 0) return;

        const map = {}; const roots = []; const descendantIds = new Set();
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è ID –≤—Å–µ—Ö –ø–æ—Ç–æ–º–∫–æ–≤
        function getDescendants(itemId) { if (!map[itemId]?.rawChildren) return; map[itemId].rawChildren.forEach(childId => { if (!descendantIds.has(childId)) { descendantIds.add(childId); getDescendants(childId); } }); }
        // –°—Ç—Ä–æ–∏–º –∫–∞—Ä—Ç—É –∏ –ø–µ—Ä–≤–∏—á–Ω—ã–µ —Å–≤—è–∑–∏ —Ä–æ–¥–∏—Ç–µ–ª—å-—Ä–µ–±–µ–Ω–æ–∫
        items.forEach(item => { map[item[valueField]] = { ...item, rawChildren: [] }; });
        items.forEach(item => {
            const parentFieldKey = valueField === 'id' && item.parent_id !== undefined ? 'parent_id' : (valueField === 'id' && item.parent_type_id !== undefined ? 'parent_type_id' : null);
            const parentId = parentFieldKey ? item[parentFieldKey] : null;
            if (parentId !== null && map[parentId]) { map[parentId].rawChildren.push(item[valueField]); }
        });

        // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç –∏ –µ–≥–æ –ø–æ—Ç–æ–º–∫–æ–≤ (–¥–ª—è —Å–µ–ª–µ–∫—Ç–∞ —Ä–æ–¥–∏—Ç–µ–ª–µ–π –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏)
        if (excludeId !== null && addHierarchy) { descendantIds.add(excludeId); getDescendants(excludeId); }

        // –°—Ç—Ä–æ–∏–º –¥–µ—Ä–µ–≤–æ –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞, –∏—Å–∫–ª—é—á–∞—è –ø–æ—Ç–æ–º–∫–æ–≤ excludeId
        const selectMap = {};
        items.forEach(item => {
            const itemId = item[valueField];
            if (!descendantIds.has(itemId)) { // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ—Ç–æ–º–∫–æ–≤
                selectMap[itemId] = { ...item, children: [] }; // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –¥–µ—Ç–µ–π
                const parentFieldKey = valueField === 'id' && item.parent_id !== undefined ? 'parent_id' : (valueField === 'id' && item.parent_type_id !== undefined ? 'parent_type_id' : null);
                const parentId = parentFieldKey ? item[parentFieldKey] : null;

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫ —Ä–æ–¥–∏—Ç–µ–ª—é
                if (parentId === null || !selectMap[parentId]) { // –ï—Å–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—è –Ω–µ—Ç –∏–ª–∏ –æ–Ω —Å–∞–º –∏—Å–∫–ª—é—á–µ–Ω
                     if (!roots.includes(itemId)) roots.push(itemId); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ—Ä–µ–Ω—å, –µ—Å–ª–∏ –µ—â–µ –Ω–µ —Ç–∞–º
                } else if (selectMap[parentId]) { // –ï—Å–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—å –µ—Å—Ç—å –≤ –Ω–∞—à–µ–º –¥–µ—Ä–µ–≤–µ selectMap
                     selectMap[parentId].children.push(itemId); // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ —Ä–µ–±–µ–Ω–∫–∞
                }
            }
        });

        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–π –≤ —Å–µ–ª–µ–∫—Ç
        function addOption(itemId, level) {
            const item = selectMap[itemId]; if (!item) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            const option = document.createElement('option');
            option.value = item[valueField];
            const name = item.short_name || item[textField]; // –ò—Å–ø–æ–ª—å–∑—É–µ–º short_name –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç
            option.textContent = addHierarchy ? ('\u00A0'.repeat(level * 3) + name) : name; // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –∏–µ—Ä–∞—Ä—Ö–∏–∏
            selectElement.appendChild(option);
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–µ—Ç–µ–π –∏ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
             item.children
                .map(id => selectMap[id]) // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –¥–µ—Ç–µ–π
                .filter(child => child)
                .sort((a, b) => (a.priority || 0) - (b.priority || 0) || (a.short_name || a[textField]).localeCompare(b.short_name || b[textField]))
                .forEach(child => addOption(child.id, level + 1));
        }

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ—Ä–Ω–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ–ø—Ü–∏–π
         roots
            .map(id => selectMap[id]) // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –∫–æ—Ä–Ω–µ–π
            .filter(root => root)
            .sort((a, b) => (a.priority || 0) - (b.priority || 0) || (a.short_name || a[textField]).localeCompare(b.short_name || b[textField]))
            .forEach(root => addOption(root.id, 0));

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∞, –µ—Å–ª–∏ –æ–Ω–æ –≤–∞–ª–∏–¥–Ω–æ
        if (currentSelectedValue && selectElement.querySelector(`option[value="${currentSelectedValue}"]`)) {
            selectElement.value = currentSelectedValue;
        } else {
            selectElement.value = ""; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
        }
    }


    // --- –§–æ—Ä–º–∞ –∏ CRUD –¥–ª—è –¢–ò–ü–û–í –£–ó–õ–û–í ---
    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –≤ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    function resetTypeForm() {
        typeForm.reset(); // –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ –ø–æ–ª—è
        typeIdInput.value = ''; // –û—á–∏—â–∞–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ ID
        currentEditTypeId = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–æ–∫
        typeFormTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å –¢–∏–ø –£–∑–ª–∞';
        typeSubmitBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –¢–∏–ø';
        typeCancelBtn.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ–Ω–∞"
        clearValidationErrors('type-'); // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π (–±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π)
        populateSelect(typeParentSelect, nodeTypesData, 'id', 'name', '-- –ù–µ—Ç (–ö–æ—Ä–Ω–µ–≤–æ–µ) --', true);
        iconPreviewSection.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å–≤–æ–π—Å—Ç–≤
        selectedTypeIdForProps = null;
        propsSection.style.display = 'none';
        // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å—Ç—Ä–æ–∫
        document.querySelectorAll('#type-list tr.selected').forEach(tr => tr.classList.remove('selected'));
    }

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function fillTypeFormForEdit(nodeType) {
        clearValidationErrors('type-'); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ—à–∏–±–∫–∏
        currentEditTypeId = nodeType.id; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ —Ç–∏–ø–∞
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
        typeIdInput.value = nodeType.id;
        typeNameInput.value = nodeType.name || ''; // –î–æ–±–∞–≤–∏–ª || ''
        typePriorityInput.value = nodeType.priority !== null ? nodeType.priority : 10; // –î–æ–±–∞–≤–∏–ª –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ null
        typeIconFilenameInput.value = nodeType.icon_filename || ''; // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∫–æ–Ω–∫–∏
        typeDescriptionTextarea.value = nodeType.description || '';
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π, –∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π —Ç–∏–ø –∏ –µ–≥–æ –ø–æ—Ç–æ–º–∫–æ–≤
        populateSelect(typeParentSelect, nodeTypesData, 'id', 'name', '-- –ù–µ—Ç (–ö–æ—Ä–Ω–µ–≤–æ–µ) --', true, currentEditTypeId);
        typeParentSelect.value = nodeType.parent_type_id !== null ? nodeType.parent_type_id : ''; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è
        // –û–±–Ω–æ–≤–ª—è–µ–º UI —Ñ–æ—Ä–º—ã
        typeFormTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¢–∏–ø –£–∑–ª–∞';
        typeSubmitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        typeCancelBtn.style.display = 'inline-block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ–Ω–∞"
        updateIconPreviewFromForm(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏
        // –ü–ª–∞–≤–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
        window.scrollTo({ top: typeForm.offsetTop - 20, behavior: 'smooth' });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã (—Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
    async function handleTypeFormSubmit(event) {
        event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
        clearValidationErrors('type-'); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
        typeSubmitBtn.disabled = true;
        typeSubmitBtn.textContent = currentEditTypeId ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';

        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
        const formData = {
            name: typeNameInput.value.trim(),
            parent_type_id: typeParentSelect.value ? parseInt(typeParentSelect.value, 10) : null,
            priority: parseInt(typePriorityInput.value, 10) || 10,
            icon_filename: typeIconFilenameInput.value.trim() || null, // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∫–æ–Ω–∫–∏
            description: typeDescriptionTextarea.value.trim() || null
        };

        // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
        let clientErrors = {};
        if (!formData.name) { clientErrors.name = '–ò–º—è —Ç–∏–ø–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.'; }
        if (formData.icon_filename && formData.icon_filename.length > 100) { clientErrors.icon_filename = '–ò–º—è —Ñ–∞–π–ª–∞ –∏–∫–æ–Ω–∫–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å 100).'; }
        if (isNaN(formData.priority) || formData.priority < 0) { clientErrors.priority = '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.'; }
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è (–ø—Ä–æ—Å—Ç–∞—è)
        if (currentEditTypeId !== null && formData.parent_type_id === currentEditTypeId) { clientErrors.parent_type_id = '–ù–µ–ª—å–∑—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è —Å–∞–º–æ–≥–æ –Ω–∞ —Å–µ–±—è.'; }

        if (Object.keys(clientErrors).length > 0) {
            displayValidationErrors(clientErrors, 'type-');
            typeSubmitBtn.disabled = false; typeSubmitBtn.textContent = currentEditTypeId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å –¢–∏–ø';
            return;
        }


        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL –∏ –º–µ—Ç–æ–¥ API
        const url = currentEditTypeId ? API_URL_NODE_TYPE_DETAIL_TPL.replace('/0', `/${currentEditTypeId}`) : API_URL_NODE_TYPES;
        const method = currentEditTypeId ? 'PUT' : 'POST';

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ API
            const resultData = await fetchData(url, {
                 method: method,
                 headers: { 'Content-Type': 'application/json' }, // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è Flask
                 body: JSON.stringify(formData) // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º JSON
             });
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
            showListFeedback(`–¢–∏–ø —É–∑–ª–∞ —É—Å–ø–µ—à–Ω–æ ${currentEditTypeId ? '–æ–±–Ω–æ–≤–ª–µ–Ω' : '–¥–æ–±–∞–≤–ª–µ–Ω'}!`, false);
            resetTypeForm(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            await loadAndRenderNodeTypes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤
        } catch (error) {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –æ—Ç API
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã —Ç–∏–ø–∞:", error);
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç API –∏–ª–∏ –æ–±—â—É—é –æ—à–∏–±–∫—É
            displayValidationErrors(error.details || error.message, 'type-');
            showListFeedback(`–û—à–∏–±–∫–∞: ${error.message}`, true); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é –æ—à–∏–±–∫—É –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º
        } finally {
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
            typeSubmitBtn.disabled = false;
            typeSubmitBtn.textContent = currentEditTypeId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å –¢–∏–ø';
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" –≤ —Ç–∞–±–ª–∏—Ü–µ
    async function handleTypeEditClick(typeId) {
        const url = API_URL_NODE_TYPE_DETAIL_TPL.replace('/0', `/${typeId}`);
        showListFeedback('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–∏–ø–∞...'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
        try {
             const nodeType = await fetchData(url); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–∏–ø–∞
             if (nodeType) {
                 fillTypeFormForEdit(nodeType); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                 showListFeedback(''); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å
                 selectTypeForProps(typeId, nodeType.name); // –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤
             } else {
                 // –¢–∏–ø –Ω–µ –Ω–∞–π–¥–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, –±—ã–ª —É–¥–∞–ª–µ–Ω)
                 showListFeedback(`–û—à–∏–±–∫–∞: –¢–∏–ø —É–∑–ª–∞ ID ${typeId} –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –±—ã–ª —É–¥–∞–ª–µ–Ω.`, true);
                 await loadAndRenderNodeTypes(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
             }
        } catch (error) {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –∑–∞–≥—Ä—É–∑–∫–∏
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", error);
            showListFeedback(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, true);
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É "–£–¥–∞–ª–∏—Ç—å" –≤ —Ç–∞–±–ª–∏—Ü–µ
    async function handleTypeDeleteClick(typeId, typeName) {
        // –ù–µ –ø–æ–∑–≤–æ–ª—è–µ–º —É–¥–∞–ª—è—Ç—å –±–∞–∑–æ–≤—ã–π —Ç–∏–ø
        if (typeId === 0) { alert("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –±–∞–∑–æ–≤—ã–π —Ç–∏–ø (ID=0)!"); return; }
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–∏–ø —É–∑–ª–∞ "${typeName}" (ID: ${typeId})? –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–∑–ª–∞–º–∏ –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ä–æ–¥–∏—Ç–µ–ª–µ–º –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤.`)) return;

        const url = API_URL_NODE_TYPE_DETAIL_TPL.replace('/0', `/${typeId}`);
        showListFeedback(`–£–¥–∞–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ ${typeName}...`);
        typeSubmitBtn.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        document.querySelectorAll('.delete-btn, .edit-btn').forEach(b => b.disabled = true);

        try {
             await fetchData(url, { method: 'DELETE' });
             showListFeedback(`–¢–∏–ø "${typeName}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.`, false);
             if (currentEditTypeId === typeId) { resetTypeForm(); } // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π
             if (selectedTypeIdForProps === typeId) { propsSection.style.display = 'none'; selectedTypeIdForProps = null; }
             await loadAndRenderNodeTypes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        } catch (error) {
             console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∏–ø–∞:", error);
             // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–¥–∞ –∏ –¥–µ—Ç–∞–ª–µ–π –æ—à–∏–±–∫–∏
             let displayMessage = `–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${error.message}`;
             if (error.code === 'CONFLICT' || error.status === 409) {
                 displayMessage = `–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ç–∏–ø "${typeName}": ${error.details || '—Å—É—â–µ—Å—Ç–≤—É—é—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (—É–∑–ª—ã –∏–ª–∏ –¥–æ—á–µ—Ä–Ω–∏–µ —Ç–∏–ø—ã).'}`;
             } else if (error.code === 'VALIDATION_ERROR' && error.details) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ —Ç–∏–ø–∞ —Å –±—ç–∫–µ–Ω–¥–∞
                 displayMessage = `–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ç–∏–ø "${typeName}": ${error.details}`;
             }
             showListFeedback(displayMessage, true);
        } finally {
            typeSubmitBtn.disabled = false;
            document.querySelectorAll('.delete-btn, .edit-btn').forEach(b => b.disabled = false);
        }
    }

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–í–û–ô–°–¢–í–ê–ú–ò –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ ---

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–ø–æ–≤ —Å–≤–æ–π—Å—Ç–≤ –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞ –≤ —Ñ–æ—Ä–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    async function loadPropertyTypes() {
         try {
             propertyTypesData = await fetchData(API_URL_NODE_PROPERTY_TYPES) || [];
             populateSelect(propTypeSelect, propertyTypesData, 'id', 'name', '-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ --');
         } catch (error) {
             console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ —Å–≤–æ–π—Å—Ç–≤:", error);
             showPropFeedback(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ —Å–≤–æ–π—Å—Ç–≤: ${error.message}`, true);
         }
    }

     // –í—ã–±–æ—Ä —Ç–∏–ø–∞ —É–∑–ª–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤
     function selectTypeForProps(typeId, typeName) {
         selectedTypeIdForProps = typeId; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π ID
         // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
         document.querySelectorAll('#type-list tr').forEach(tr => tr.classList.remove('selected'));
         const selectedRow = document.querySelector(`#type-list tr[data-id="${typeId}"]`);
         if (selectedRow) selectedRow.classList.add('selected');

         // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å–≤–æ–π—Å—Ç–≤ –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
         propsTitle.textContent = `–°–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è —Ç–∏–ø–∞: ${typeName} (ID: ${typeId})`;
         propsSection.style.display = 'block';
         loadAndRenderProperties(typeId); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–≤–æ–π—Å—Ç–≤–∞

         // –û—á–∏—â–∞–µ–º –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞
         addPropForm.reset();
         propTypeSelect.disabled = false;
         clearValidationErrors('prop-'); // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º—ã —Å–≤–æ–π—Å—Ç–≤

         // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
         updateIconPreviewFromForm();
     }

     // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —Å–≤–æ–π—Å—Ç–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
    async function loadAndRenderProperties(typeId) {
        propsListContainer.innerHTML = `<p class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–π—Å—Ç–≤...</p>`;
        showPropFeedback(''); // –û—á–∏—â–∞–µ–º —Ñ–∏–¥–±–µ–∫ –¥–ª—è —Å–≤–æ–π—Å—Ç–≤
        if (typeId === null) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ ID –Ω–µ null (0 - –±–∞–∑–æ–≤—ã–π —Ç–∏–ø, –æ–Ω –≤–∞–ª–∏–¥–µ–Ω)
            propsListContainer.innerHTML = '<p>–¢–∏–ø —É–∑–ª–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω.</p>';
            return;
        }

        const url = API_URL_NODE_TYPE_PROPERTIES_TPL.replace('/0', `/${typeId}`);
        try {
            const properties = await fetchData(url) || []; // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–æ–π—Å—Ç–≤–∞
            renderPropertiesList(properties); // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–≤–æ–π—Å—Ç–≤

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–æ–≤ —Å–≤–æ–π—Å—Ç–≤ (–∏—Å–∫–ª—é—á–∞—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ)
            const existingPropTypeIds = new Set(properties.map(p => p.property_type_id));
            const availablePropTypes = propertyTypesData.filter(pt => !existingPropTypeIds.has(pt.id));
            populateSelect(propTypeSelect, availablePropTypes, 'id', 'name', '-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ --');

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏ —Å —É—á–µ—Ç–æ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–≤–æ–π—Å—Ç–≤ (—Ü–≤–µ—Ç–∞)
            updateIconPreviewFromForm();

        } catch (error) {
             console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–π—Å—Ç–≤ –¥–ª—è —Ç–∏–ø–∞ ${typeId}:`, error);
             propsListContainer.innerHTML = `<p class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–π—Å—Ç–≤.</p>`;
             showPropFeedback(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–π—Å—Ç–≤: ${error.message}`, true);
        }
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —Ç–µ–∫—É—â–∏—Ö —Å–≤–æ–π—Å—Ç–≤
    function renderPropertiesList(properties) {
         if (!Array.isArray(properties)) { // –î–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫–∞
             propsListContainer.innerHTML = '<p class="error-message">–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–≤–æ–π—Å—Ç–≤.</p>';
             return;
         }
         if (properties.length === 0) {
             propsListContainer.innerHTML = '<p>–î–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —É–∑–ª–æ–≤ —Å–≤–æ–π—Å—Ç–≤–∞ –Ω–µ –∑–∞–¥–∞–Ω—ã.</p>';
             return;
         }
         // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞
         propsListContainer.innerHTML = properties.map(p => `
             <div class="property-item" data-property-type-id="${p.property_type_id}">
                 <label title="${p.description || p.property_name}">${p.property_name}:</label>
                 <input type="text" value="${p.property_value || ''}" readonly data-original-value="${p.property_value || ''}"> <!-- –ü–æ–ª–µ –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏—è + –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ -->
                 <button class="edit-prop-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ">‚úèÔ∏è</button> <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                 <button class="delete-prop-btn" title="–£–¥–∞–ª–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–æ">üóëÔ∏è</button> <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
             </div>
         `).join('');
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞
    async function handleAddPropertyFormSubmit(event) {
         event.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
         clearValidationErrors('prop-'); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ—à–∏–±–∫–∏
         showPropFeedback('');

         // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ª–∏–±–æ –∏–∑ —Ñ–æ—Ä–º—ã, –ª–∏–±–æ –∏–∑ mockEvent –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑ —Å—Ç—Ä–æ–∫–∏
         const isMockEvent = event.target.elements === undefined;
         const propertyTypeId = isMockEvent ? event.propertyTypeId : propTypeSelect.value;
         const propertyValue = isMockEvent ? event.value : propValueInput.value.trim();
         const formSubmitButton = isMockEvent ? null : addPropForm.querySelector('button[type="submit"]');

         if (selectedTypeIdForProps === null) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∏–ø –≤—ã–±—Ä–∞–Ω (0 - –±–∞–∑–æ–≤—ã–π —Ç–∏–ø)
             showPropFeedback("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É–∑–ª–∞.", true);
             return;
         }

         // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ –≤—ã–±—Ä–∞–Ω –∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–≤–µ–¥–µ–Ω–æ
         if (!propertyTypeId || propertyValue === '') {
              displayValidationErrors({ value: "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞ –∏ –≤–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ." }, 'prop-');
              if(propValueInput && !isMockEvent) propValueInput.focus();
             return;
         }

         // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏
         if(formSubmitButton) { formSubmitButton.disabled = true; formSubmitButton.textContent = '–°–æ—Ö—Ä...'; }
         showPropFeedback("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞..."); // –°—Ç–∞—Ç—É—Å

         // –ò—Å–ø–æ–ª—å–∑—É–µ–º PUT /.../properties —Å —Ç–µ–ª–æ–º {"property_type_id": value}
         const url = API_URL_NODE_TYPE_PROPERTIES_TPL.replace('/0', `/${selectedTypeIdForProps}`);
         const data = { [propertyTypeId]: propertyValue }; // { "5": "some_value" }

         try {
             await fetchData(url, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data)
              });
             showPropFeedback("–°–≤–æ–π—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!", false); // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
             if(!isMockEvent) addPropForm.reset(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è, –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –æ–Ω–∞
             // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–≤–æ–π—Å—Ç–≤ –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏ (—Ç.–∫. –º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è —Ü–≤–µ—Ç)
             await loadAndRenderProperties(selectedTypeIdForProps);
         } catch(error) {
              console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞:", error);
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ —Ñ–∏–¥–±–µ–∫–µ —Ñ–æ—Ä–º—ã —Å–≤–æ–π—Å—Ç–≤
              displayValidationErrors(error.details || error.message, 'prop-');
              showPropFeedback(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`, true);
         } finally {
              if(formSubmitButton) { formSubmitButton.disabled = false; formSubmitButton.textContent = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å'; }
         }
    }


    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞
    async function handleDeletePropertyClick(propertyTypeId) {
         if (selectedTypeIdForProps === null) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
         const propType = propertyTypesData.find(pt => pt.id == propertyTypeId); // –ù–∞—Ö–æ–¥–∏–º –∏–º—è —Ç–∏–ø–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
         if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–æ "${propType?.name || 'ID: '+propertyTypeId}" –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∏–ø–∞ —É–∑–ª–∞?`)) return; // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

         // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞
         const url = API_URL_NODE_TYPE_PROPERTY_DELETE_TPL
                        .replace('/0/', `/${selectedTypeIdForProps}/`)
                        .replace('/properties/0', `/properties/${propertyTypeId}`); // –ó–∞–º–µ–Ω—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
         showPropFeedback(`–£–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ ${propType?.name}...`); // –°—Ç–∞—Ç—É—Å
         try {
            await fetchData(url, { method: 'DELETE' }); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å DELETE
            showPropFeedback("–°–≤–æ–π—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–æ.", false); // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–≤–æ–π—Å—Ç–≤ –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∫–æ–Ω–∫–∏
            await loadAndRenderProperties(selectedTypeIdForProps);
         } catch (error) {
              console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞:", error);
              showPropFeedback(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${error.message}`, true); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
         }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞
    function handleEditPropertyValue(editButton) {
         const item = editButton.closest('.property-item'); // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç —Å–≤–æ–π—Å—Ç–≤–∞
         const input = item.querySelector('input[type="text"]'); // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
         if (!input) return;

         if (input.readOnly) { // –ï—Å–ª–∏ –ø–æ–ª–µ –±—ã–ª–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
             input.readOnly = false;
             input.dataset.originalValue = input.value; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
             input.focus(); // –°—Ç–∞–≤–∏–º —Ñ–æ–∫—É—Å
             editButton.textContent = 'üíæ'; // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
             editButton.title = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ';
             // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
             input.addEventListener('keypress', handlePropertyInputEnter);
             // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã
             input.addEventListener('blur', handlePropertyInputBlur);

         } else { // –ï—Å–ª–∏ –±—ã–ª–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - —Å–æ—Ö—Ä–∞–Ω—è–µ–º
             const newValue = input.value.trim();
             input.readOnly = true; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
             editButton.textContent = '‚úèÔ∏è'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∫–æ–Ω–∫—É "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
             editButton.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ';
             input.removeEventListener('keypress', handlePropertyInputEnter);
             input.removeEventListener('blur', handlePropertyInputBlur);

             // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
             if (newValue !== input.dataset.originalValue) {
                 const propertyTypeId = item.dataset.propertyTypeId; // –ü–æ–ª—É—á–∞–µ–º ID —Ç–∏–ø–∞ —Å–≤–æ–π—Å—Ç–≤–∞
                 // –í—ã–∑—ã–≤–∞–µ–º —Ç—É –∂–µ —Ñ—É–Ω–∫—Ü–∏—é, —á—Ç–æ –∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ (–æ–Ω–∞ –¥–µ–ª–∞–µ—Ç UPSERT)
                 // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é
                 const mockEvent = { propertyTypeId: propertyTypeId, value: newValue };
                 handleAddPropertyFormSubmit(mockEvent);
             } else {
                 showPropFeedback("–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å.", false); // –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π
             }
         }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –¥–ª—è –∏–Ω–ø—É—Ç–∞ —Å–≤–æ–π—Å—Ç–≤–∞
    function handlePropertyInputEnter(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ Enter
            const editButton = event.target.closest('.property-item').querySelector('.edit-prop-btn');
            if (editButton) {
                 handleEditPropertyValue(editButton); // –í—ã–∑—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            }
        }
    }
     // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞ –¥–ª—è –∏–Ω–ø—É—Ç–∞ —Å–≤–æ–π—Å—Ç–≤–∞
     function handlePropertyInputBlur(event) {
         // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —É—Å–ø–µ–ª —Å—Ä–∞–±–æ—Ç–∞—Ç—å –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
         setTimeout(() => {
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –µ—â–µ —ç—Ç–æ—Ç –∏–Ω–ø—É—Ç (–Ω–µ –±—ã–ª –ª–∏ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω/–∑–∞–∫—Ä—ã—Ç)
              const input = event.target;
              const item = input.closest('.property-item');
              const editButton = item?.querySelector('.edit-prop-btn');

              if (!input.readOnly && document.activeElement !== editButton) { // –ï—Å–ª–∏ —Ñ–æ–∫—É—Å —É—à–µ–ª –Ω–µ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                 input.readOnly = true;
                 input.value = input.dataset.originalValue; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                 if(editButton) {
                     editButton.textContent = '‚úèÔ∏è';
                     editButton.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ';
                 }
                 input.removeEventListener('keypress', handlePropertyInputEnter);
                 input.removeEventListener('blur', handlePropertyInputBlur);
                 showPropFeedback("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.", false);
              }
         }, 150); // 150 –º—Å –∑–∞–¥–µ—Ä–∂–∫–∞
     }


    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã: –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–ø–æ–≤ —Å–≤–æ–π—Å—Ç–≤ –∏ —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤
    async function initializePage() {
         await loadPropertyTypes(); // –°–Ω–∞—á–∞–ª–∞ —Ç–∏–ø—ã –°–í–û–ô–°–¢–í
         await loadAndRenderNodeTypes(); // –ó–∞—Ç–µ–º —Ç–∏–ø—ã –£–ó–õ–û–í
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã (—Ç–∏–ø —É–∑–ª–∞)
    typeForm.addEventListener('submit', handleTypeFormSubmit);
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ç–º–µ–Ω–∞"
    typeCancelBtn.addEventListener('click', resetTypeForm);
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞
    addPropForm.addEventListener('submit', handleAddPropertyFormSubmit);
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    typeIconFilenameInput.addEventListener('input', updateIconPreviewFromForm);
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞ —Ü–≤–µ—Ç–∞ (–µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è)
    propsListContainer.addEventListener('input', (event) => {
        if (event.target.closest('.property-item')?.dataset.propertyTypeId == propertyTypesData.find(p => p.name === 'icon_color')?.id) {
             updateIconPreviewFromForm();
        }
    });


    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤
    typeList.addEventListener('click', (event) => {
        const editBtn = event.target.closest('.edit-btn'); // –ö–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å?
        const deleteBtn = event.target.closest('.delete-btn'); // –ö–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É –£–¥–∞–ª–∏—Ç—å?
        const row = event.target.closest('tr[data-id]'); // –ö–ª–∏–∫ –Ω–∞ —Å—Ç—Ä–æ–∫—É?

        if (editBtn) {
            event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–±–æ—Ä —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
            handleTypeEditClick(parseInt(editBtn.dataset.id, 10)); // –í—ã–∑—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        } else if (deleteBtn) {
            event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–±–æ—Ä —Å—Ç—Ä–æ–∫–∏
            handleTypeDeleteClick(parseInt(deleteBtn.dataset.id, 10), deleteBtn.dataset.name); // –í—ã–∑—ã–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
        } else if (row) {
            // –ö–ª–∏–∫ –Ω–∞ —Å—Ç—Ä–æ–∫—É - –≤—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤
            selectTypeForProps(parseInt(row.dataset.id, 10), row.dataset.typeName);
        }
    });

    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É —Å–≤–æ–π—Å—Ç–≤
    propsListContainer.addEventListener('click', (event) => {
         const deleteBtn = event.target.closest('.delete-prop-btn'); // –ö–ª–∏–∫ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞?
         const editBtn = event.target.closest('.edit-prop-btn'); // –ö–ª–∏–∫ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è?
         if (deleteBtn) {
             const propTypeId = deleteBtn.closest('.property-item')?.dataset.propertyTypeId;
             if (propTypeId) handleDeletePropertyClick(parseInt(propTypeId, 10)); // –í—ã–∑—ã–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
         } else if (editBtn) {
             handleEditPropertyValue(editBtn); // –í—ã–∑—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
         }
    });

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    document.addEventListener('DOMContentLoaded', initializePage);

</script>
{% endblock %}
