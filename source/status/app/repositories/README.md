# Status Monitor — Репозитории для работы с базой данных

В этой директории размещены модули-репозитории, реализующие низкоуровневую работу с основными сущностями проекта через PostgreSQL (Psycopg2). Каждый репозиторий отвечает за одну бизнес-сущность.

## Общие принципы

- Каждый файл `<entity>_repository.py` реализует CRUD-функции и бизнес-логику для одной таблицы или группы связанных таблиц.
- Все функции принимают курсор (`cursor`), который должен создаваться на уровне вызова (например, внутри endpoint-а Flask), чтобы поддерживать транзакции.
- Исключения по бизнес-логике (ValueError, psycopg2.Error) выбрасываются наверх — они обрабатываются во Flask или сервис-слое.
- Для всех функций предусмотрено логирование ключевых операций.
- По возможности реализована пагинация и фильтрация (через `limit`, `offset`, `search_text`).

## Описание репозиториев

| Файл | Сущность | Краткое назначение |
|------|----------|-------------------|
| subdivision_repository.py | Подразделения | CRUD для иерархии подразделений (объекты мониторинга) |
| node_repository.py        | Узлы          | CRUD для узлов мониторинга (серверы, АРМы, сети) |
| node_type_repository.py   | Типы узлов    | CRUD для классификации узлов (например, "Сервер", "АРМ") |
| node_property_repository.py| Свойства типов узлов | CRUD для пользовательских свойств типов узлов |
| method_repository.py      | Методы проверок | CRUD для справочника доступных проверок (PING, SERVICE, ... ) |
| assignment_repository.py  | Задания (pipeline) | CRUD для назначений проверок узлам (поддержка конвейера pipeline) |
| check_repository.py       | Проверки (история) | CRUD и выборка истории и деталей результатов проверок |
| event_repository.py       | События системы | CRUD и выборка системных событий (лог ошибок, действия пользователей) |
| api_key_repository.py     | API-ключи      | CRUD и работа с API-ключами, поиск и генерация |
| user.py                   | Пользователи   | CRUD для учетных записей веб-интерфейса |

## Примеры использования

```python
from app.repositories.node_repository import get_node_by_id, create_node

with db.get_conn() as conn:
    with conn.cursor(cursor_factory=psycopg2.extras.RealDictCursor) as cur:
        node = get_node_by_id(cur, node_id=15)
        ...
Примечания
Все функции получают курсор и возвращают словари (dict) с данными.

Проверки связности (например, невозможность удалить используемый тип/подразделение) выполняются на уровне Python-кода.

В случае ошибок — выбрасываются исключения, которые обрабатываются в REST API/сервисах.

Для детальных описаний см. docstring каждой функции.

В тестах и миграциях рекомендуется использовать эти же функции для создания/удаления тестовых данных.

TODO
Описать каждый модуль более подробно, добавить схемы для pipeline (assignments).

Дополнить юнит-тестами.

yaml
Копировать
Редактировать

---

## 3. Итог

- Такой readme пригоден для документации всей структуры репозиториев.
- Для каждого репозитория можно добавить inline docstring для функций, если их недостаточно.

---

**Если нужна отдельная детализация или примеры для какого-то файла из этих — напиши, добавлю подробную секцию или расширю readme!**  
Дальше можно обсудить, какие из репозиториев нуждаются в доработке или актуализации под