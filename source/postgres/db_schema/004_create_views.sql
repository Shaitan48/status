-- =============================================================================
-- Файл: 004_create_views.sql
-- Назначение: Создание представлений (Views) для упрощения часто используемых
--             запросов или предоставления ограниченного набора данных.
-- Версия схемы: ~4.3.0
-- =============================================================================

-- -----------------------------------------------------------------------------
-- Представление: view_recent_errors
-- Назначение: Отображение последних 100 системных событий с уровнем
--             важности ERROR или CRITICAL.
--             Удобно для быстрого обзора проблем в системе.
-- Используемые таблицы: system_events.
-- Примечания: LIMIT 100 - количество можно изменить по необходимости.
-- -----------------------------------------------------------------------------
CREATE OR REPLACE VIEW view_recent_errors AS
SELECT
    id,                 -- ID события
    event_time,         -- Время события
    event_type,         -- Тип события
    severity,           -- Уровень важности (здесь будет ERROR или CRITICAL)
    message,            -- Сообщение об ошибке
    source,             -- Источник события
    object_id,          -- Связанный ID объекта/подразделения
    node_id,            -- Связанный ID узла
    assignment_id,      -- Связанный ID задания
    node_check_id,      -- Связанный ID проверки
    related_entity,     -- Тип связанной сущности
    related_entity_id,  -- ID связанной сущности
    details             -- Детали события (JSONB)
FROM system_events
WHERE severity IN ('ERROR', 'CRITICAL') -- Фильтр по уровню важности
ORDER BY event_time DESC                -- Сортировка по времени (последние сначала)
LIMIT 100;                              -- Ограничение количества записей

-- Комментарий к представлению: Упрощает мониторинг последних критических ошибок в системе без необходимости писать сложный SQL-запрос каждый раз.
COMMENT ON VIEW view_recent_errors IS 'Представление для просмотра последних 100 ошибок и критических событий из system_events.';

-- =============================================================================
-- == КОНЕЦ СОЗДАНИЯ ПРЕДСТАВЛЕНИЙ ==
-- =============================================================================