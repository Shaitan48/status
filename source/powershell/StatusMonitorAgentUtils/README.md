
---

**9. `powershell/StatusMonitorAgentUtils/README.md` (Новый)**

```markdown
# Модуль PowerShell: StatusMonitorAgentUtils

Этот модуль PowerShell (`StatusMonitorAgentUtils.psm1` и папка `Checks/`) предоставляет общую функциональность для агентов мониторинга (online и offline) системы Status Monitor.

## Назначение

*   **Инкапсуляция логики проверок:** Содержит код для выполнения различных типов проверок (PING, статус службы, использование диска и т.д.).
*   **Диспетчеризация:** Предоставляет единую точку входа (`Invoke-StatusMonitorCheck`) для агентов, которая определяет нужный метод проверки и запускает соответствующий скрипт.
*   **Стандартизация результатов:** Обеспечивает возврат результатов проверок в едином формате.
*   **Переиспользование кода:** Содержит общие вспомогательные функции.

## Ключевые компоненты

1.  **`StatusMonitorAgentUtils.psm1`**: Основной файл модуля. Содержит:
    *   **`Invoke-StatusMonitorCheck` (Экспортируемая функция):**
        *   **Роль:** Диспетчер проверок.
        *   **Вход:** Объект задания (`$Assignment`) от агента.
        *   **Логика:**
            *   Определяет имя метода (`$Assignment.method_name`).
            *   Находит соответствующий скрипт `Checks/Check-METHOD_NAME.ps1`.
            *   Проверяет существование скрипта.
            *   Подготавливает параметры (`$checkParams`) для скрипта проверки (извлекая нужные данные из `$Assignment`).
            *   **Запускает скрипт `Checks/Check-*.ps1` ЛОКАЛЬНО** на машине, где работает агент (используя оператор `&`).
            *   Перехватывает ошибки выполнения скрипта проверки.
            *   Возвращает стандартизированный результат, полученный от скрипта проверки (или сформированный при ошибке).
    *   **`New-CheckResultObject` (Экспортируемая функция):**
        *   **Роль:** Вспомогательная функция для создания стандартизированного объекта результата.
        *   **Вход:** Параметры результата (`IsAvailable`, `CheckSuccess`, `Details`, `ErrorMessage`).
        *   **Логика:** Создает хэш-таблицу с обязательными полями (`IsAvailable`, `CheckSuccess`, `Timestamp` (в UTC ISO 8601)) и переданными опциональными данными. Применяет логику для `CheckSuccess` и `ErrorMessage` по умолчанию.
        *   **Выход:** Хэш-таблица стандартного результата.
    *   **`Invoke-RemoteCheck` (Приватная функция, НЕ используется агентами):**
        *   Реализует логику вызова скрипта проверки на **удаленной** машине через `Invoke-Command`. *Эта функция не используется текущими онлайн/оффлайн агентами, так как они выполняют проверки сами.*

2.  **Папка `Checks/`**: Содержит отдельные `.ps1` файлы для **каждого** метода проверки, поддерживаемого системой.
    *   **Именование:** `Check-METHOD_NAME.ps1` (например, `Check-PING.ps1`, `Check-SERVICE_STATUS.ps1`). `METHOD_NAME` должно точно совпадать со значением `method_name` в таблице `check_methods` БД.
    *   **Назначение:** Каждый скрипт отвечает за логику **только своей** проверки.
    *   **Вход:** Принимает параметры через `param()` (например, `$TargetIP`, `$Parameters`, `$SuccessCriteria`, `$NodeName`), которые ему передает диспетчер `Invoke-StatusMonitorCheck`.
    *   **Выход:** **Обязан** возвращать стандартизированный объект-результат (хэш-таблицу), используя `New-CheckResultObject` или создавая его вручную по тому же формату.

## Стандартный Формат Результата Проверки

Каждый скрипт `Checks/Check-*.ps1` и функция `Invoke-StatusMonitorCheck` должны возвращать результат в виде хэш-таблицы следующей структуры:

```powershell
@{
    # --- Обязательные поля ---

    # Удалось ли ВЫПОЛНИТЬ саму проверку?
    # $false если: нет доступа к цели, нет прав, объект не найден,
    #             ошибка в скрипте проверки, ошибка парсинга и т.д.
    # $true если: удалось получить какие-либо данные (даже если они
    #             не соответствуют критериям).
    IsAvailable = [bool]

    # Соответствует ли результат проверки КРИТЕРИЯМ УСПЕХА?
    # Устанавливается ТОЛЬКО если IsAvailable = $true.
    # $true:  Проверка выполнена И результат соответствует критериям (или критериев нет).
    # $false: Проверка выполнена, НО результат НЕ соответствует критериям.
    # $null:  Проверка НЕ была выполнена (IsAvailable = $false) ИЛИ
    #          критерии не применялись или их проверка не удалась.
    CheckSuccess = [nullable[bool]]

    # Время выполнения проверки в формате UTC ISO 8601 (YYYY-MM-DDTHH:mm:ss.fffffffZ)
    Timestamp = [string]

    # --- Опциональные поля ---

    # Детализированная информация о результате проверки.
    # Содержимое зависит от конкретного метода.
    # Например, для DISK_USAGE это будет @{ disks = @(...) }
    # Может содержать доп. информацию об ошибке, если IsAvailable = $false.
    Details = [hashtable] # Или $null

    # Текстовое описание проблемы.
    # Заполняется, если IsAvailable = $false ИЛИ CheckSuccess = $false.
    ErrorMessage = [string] # Или $null
}

Добавление Новых Методов Проверки

    Добавить запись в таблицу check_methods в базе данных (указать уникальный method_name).

    Создать файл Checks/Check-METHOD_NAME.ps1 в папке модуля StatusMonitorAgentUtils.

    Реализовать логику проверки внутри этого скрипта:

        Определить необходимые параметры в блоке param().

        Написать код для выполнения проверки (используя PowerShell командлеты, .NET классы, WMI и т.д.).

        Обработать возможные ошибки.

        Определить значения для IsAvailable и CheckSuccess.

        Сформировать хэш-таблицу $Details с результатами.

        Сформировать $ErrorMessage при необходимости.

        Вернуть стандартизированный результат с помощью New-CheckResultObject или вручную.

    Обновить StatusMonitorAgentUtils.psd1, если нужно экспортировать новые вспомогательные функции (обычно не требуется для добавления только скрипта проверки).

    Протестировать новый скрипт локально, вызвав его через Invoke-StatusMonitorCheck с тестовым объектом $Assignment.

    Создать Задание в веб-интерфейсе Status Monitor, использующее новый метод.

Установка и Использование

Модуль StatusMonitorAgentUtils не нужно устанавливать глобально. Его необходимо скопировать вместе с агентами (online/offline).

    Структура папок:
    <Папка_Агента>/
├── online-agent/
│   └── online-agent.ps1
│   └── config.json
│   └── README.md
├── offline-agent/
│   └── offline-agent.ps1
│   └── config.json
│   └── README.md
└── StatusMonitorAgentUtils/  <-- Модуль должен быть здесь
    ├── Checks/
    │   ├── Check-PING.ps1
    │   ├── Check-SERVICE_STATUS.ps1
    │   └── ... (другие скрипты проверок) ...
    ├── StatusMonitorAgentUtils.psd1
    └── StatusMonitorAgentUtils.psm1
    └── README.md (этот файл)

    Скрипты агентов (online-agent.ps1, offline-agent.ps1) автоматически импортируют модуль из относительного пути ..\StatusMonitorAgentUtils.