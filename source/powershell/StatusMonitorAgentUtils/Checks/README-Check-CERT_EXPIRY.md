
---

**5. `powershell/StatusMonitorAgentUtils/Checks/README-Check-CERT_EXPIRY.md`**

```markdown
# Check-CERT_EXPIRY.ps1

**Назначение:**

Этот скрипт проверяет сроки действия локально установленных сертификатов Windows.

**Принцип работы:**

1.  Получает параметры (`TargetIP`, `Parameters`, `SuccessCriteria`, `NodeName`) от диспетчера. `$TargetIP` используется только для логирования, так как скрипт выполняется локально на целевой машине.
2.  Определяет список стандартных хранилищ для поиска: `Cert:\LocalMachine\My`, `Cert:\LocalMachine\WebHosting`, `Cert:\CurrentUser\My`.
3.  Извлекает параметры **фильтрации** из `$Parameters`: `subject_like`, `issuer_like`, `thumbprint`, `require_private_key`, `eku_oid`.
4.  Извлекает **обязательный** критерий успеха `min_days_left` из `$SuccessCriteria`.
5.  Извлекает опциональный параметр `min_days_warning` из `$Parameters`.
6.  Итерирует по списку хранилищ:
    *   Выполняет `Get-ChildItem` для текущего хранилища (`ErrorAction = SilentlyContinue`).
    *   Добавляет найденные сертификаты в общий список `$allFoundCertificates`.
    *   Если при доступе к хранилищу возникла ошибка, записывает ее в `$storeAccessErrors`.
7.  Если были ошибки доступа к хранилищам, устанавливает `IsAvailable = $true` (т.к. часть работы могла быть выполнена), но запоминает ошибки для `ErrorMessage`.
8.  Применяет фильтры к общему списку `$allFoundCertificates`:
    *   Приоритет отдается фильтру по `thumbprint`.
    *   Если отпечаток не указан, применяются фильтры `subject_like` и `issuer_like`.
    *   Применяются фильтры `require_private_key` и `eku_oid`, если они заданы.
9.  Если после фильтрации сертификатов не осталось, проверка считается успешной (`CheckSuccess = $true`).
10. Для каждого отфильтрованного сертификата:
    *   Рассчитывает количество дней до истечения (`days_left`).
    *   Определяет статус сертификата: `OK`, `Expired` (истек), `Expiring (Fail)` (осталось <= `min_days_left`), `Expiring (Warn)` (осталось <= `min_days_warning`), `Error` (ошибка расчета).
    *   Если статус `Expired` или `Expiring (Fail)`, устанавливает общий флаг `$overallCheckSuccess = $false` и добавляет сообщение в `$errorMessages`.
    *   Собирает информацию о сертификате (включая статус) в хэш-таблицу и добавляет ее в `$resultData.Details.certificates`.
11. Устанавливает итоговый `CheckSuccess` равным `$overallCheckSuccess`.
12. Если были ошибки (по критериям или ошибки доступа к хранилищам), формирует `ErrorMessage`.
13. Возвращает стандартизированный объект результата с помощью `New-CheckResultObject`.

**Параметры скрипта:**

*   `$TargetIP` ([string], Обязательный): IP-адрес или имя хоста (используется диспетчером).
*   `$Parameters` ([hashtable], Обязательный): Хэш-таблица с параметрами фильтрации.
*   `$SuccessCriteria` ([hashtable], Обязательный): Хэш-таблица с критериями успеха.
*   `$NodeName` ([string], Необязательный): Имя узла для логирования.

**Параметры задания (`$Parameters`)**:

*   `subject_like` ([string], Необязательный): Фильтр по имени субъекта (Common Name, CN). Можно использовать wildcard `*`. Пример: `"*.example.com"`.
*   `issuer_like` ([string], Необязательный): Фильтр по имени издателя сертификата. Можно использовать wildcard `*`. Пример: `"*My Internal CA*"`.
*   `thumbprint` ([string], Необязательный): Точный отпечаток (Thumbprint) сертификата для поиска. Если указан, фильтры `subject_like` и `issuer_like` игнорируются.
*   `require_private_key` ([bool], Необязательный, по умолч. `$false`): Искать только сертификаты, у которых есть соответствующий закрытый ключ в хранилище.
*   `eku_oid` ([string[]], Необязательный): Массив строк с идентификаторами объектов (OID) расширенного использования ключа (Extended Key Usage). Сертификат будет отобран, если он содержит *хотя бы один* из указанных OID. Примеры:
    *   `'1.3.6.1.5.5.7.3.1'` - Проверка подлинности сервера (Server Authentication - для SSL/TLS)
    *   `'1.3.6.1.5.5.7.3.2'` - Проверка подлинности клиента (Client Authentication)
    *   `'1.3.6.1.5.5.7.3.8'` - Временная метка (Time Stamping)
*   `min_days_warning` ([int], Необязательный, по умолч. 30): Количество дней до истечения, при котором статус сертификата в `$Details` будет помечен как "Expiring (Warn)". Не влияет на `CheckSuccess`.

**Критерии успеха (`$SuccessCriteria`)**:

*   `min_days_left` ([int], **Обязательный**): Минимальное количество полных дней, которое должно оставаться до истечения срока действия *каждого* найденного по фильтрам сертификата. Если хотя бы у одного сертификата осталось дней меньше или равно этому значению (или он уже истек), `CheckSuccess` будет `$false`.

**Возвращаемый результат:**

*   Стандартный объект (`IsAvailable`, `CheckSuccess`, `Timestamp`, `Details`, `ErrorMessage`).
*   `$Details` содержит:
    *   `certificates` (List<object>): Массив хэш-таблиц для каждого найденного и отфильтрованного сертификата. Каждая содержит:
        *   `thumbprint` (string): Отпечаток.
        *   `subject` (string): Имя субъекта.
        *   `issuer` (string): Имя издателя.
        *   `not_before` (string): Дата начала действия (UTC ISO 8601).
        *   `not_after` (string): Дата окончания действия (UTC ISO 8601).
        *   `days_left` (int): Количество полных оставшихся дней.
        *   `has_private_key` (bool): Наличие закрытого ключа.
        *   `status` (string): Рассчитанный статус (`OK`, `Expired`, `Expiring (Fail)`, `Expiring (Warn)`, `Error`).
        *   `status_details` (string): Пояснение к статусу.
        *   `store_path` (string): Путь к хранилищу, где найден сертификат.
    *   `stores_checked` (string[]): Список путей к хранилищам, в которых производился поиск.
    *   `message` (string): (Опционально) Сообщение, если сертификаты не найдены.
    *   `error` (string): (Опционально) Сообщение об ошибке, если `IsAvailable = $false`.

**Пример конфигурации Задания (Assignment):**

```json
// Пример 1: Проверить все SSL-сертификаты сервера (>30 дней)
{
  "node_id": 50,
  "method_id": 7, // ID для CERT_EXPIRY
  "is_enabled": true,
  "parameters": {
    "eku_oid": ["1.3.6.1.5.5.7.3.1"], // Server Auth
    "require_private_key": true,
    "min_days_warning": 60 // Предупреждать за 60 дней
  },
  "success_criteria": {
    "min_days_left": 30 // Должно оставаться больше 30 дней
  },
  "description": "Проверка SSL сертификатов сервера (>30 дней)"
}

// Пример 2: Проверить конкретный сертификат по отпечатку (>90 дней)
{
  "node_id": 51,
  "method_id": 7,
  "is_enabled": true,
  "parameters": {
    "thumbprint": "ВАШ_ОТПЕЧАТОК_СЕРТИФИКАТА_ЗДЕСЬ"
  },
  "success_criteria": {
    "min_days_left": 90
  },
  "description": "Проверка конкретного сертификата по отпечатку (>90 дней)"
}

Возможные ошибки и замечания:

    Права доступа: Для доступа к хранилищу LocalMachine требуются права администратора. Доступ к CurrentUser обычно есть у пользователя, от имени которого запущен агент.

    Доступность хранилищ: Если какое-то из стандартных хранилищ отсутствует или недоступно, скрипт запишет ошибку, но продолжит проверку остальных.

    Фильтрация: Убедитесь, что параметры фильтрации (subject_like, thumbprint и т.д.) заданы корректно для поиска нужных сертификатов. Если фильтры не заданы, будут проверяться все сертификаты в стандартных хранилищах.

Зависимости:

    Функция New-CheckResultObject из StatusMonitorAgentUtils.psm1.