
---

**4. `powershell/StatusMonitorAgentUtils/Checks/README-Check-PROCESS_LIST.md`**

```markdown
# Check-PROCESS_LIST.ps1

**Назначение:**

Этот скрипт получает список запущенных процессов на локальной машине (или удаленной, если вызван через `Invoke-Command` диспетчером), используя командлет `Get-Process`.

**Принцип работы:**

1.  Получает параметры (`TargetIP`, `Parameters`, `SuccessCriteria`, `NodeName`) от диспетчера. `$TargetIP` используется только для логирования, так как `Get-Process` выполняется в контексте машины, где запущен скрипт.
2.  Формирует параметры для `Get-Process` на основе `$Parameters`:
    *   Если задан `process_names`, использует его для фильтрации по имени (с `ErrorAction = SilentlyContinue`, чтобы не падать, если процесс не найден).
    *   Если `process_names` не задан, получает все процессы (с `ErrorAction = Stop`).
3.  Вызывает `Get-Process`. Если произошла критическая ошибка (например, сам командлет не доступен), устанавливает `IsAvailable = $false`.
4.  Если `Get-Process` вернул пустой результат *при фильтрации по имени*, устанавливает `IsAvailable = $true`, `CheckSuccess = $true` и добавляет сообщение в `Details.message`.
5.  Если `Get-Process` вернул процессы:
    *   Устанавливает `IsAvailable = $true`.
    *   Итерирует по каждому объекту процесса:
        *   Извлекает базовые данные: `id`, `name`, `cpu_seconds`, `memory_ws_mb`.
        *   Опционально (если запрошено `include_username`): Пытается получить имя пользователя через `Get-CimInstance Win32_Process` (более надежный способ). Обрабатывает ошибки доступа.
        *   Опционально (если запрошено `include_path`): Пытается получить путь к исполняемому файлу из свойства `Path` или `MainModule.FileName`. Обрабатывает ошибки доступа.
        *   Опционально: Пытается получить время запуска `start_time`.
        *   Собирает данные в объект `[PSCustomObject]`.
    *   Сортирует полученный список процессов согласно параметрам `sort_by` и `sort_descending` (с поддержкой псевдонимов 'memory', 'cpu'). Обрабатывает некорректные поля сортировки.
    *   Ограничивает список первыми `top_n` элементами, если указано.
    *   Добавляет итоговый список в `$resultData.Details.processes`.
    *   Устанавливает `CheckSuccess = $true` (критерии пока не реализованы).
6.  Возвращает стандартизированный объект результата с помощью `New-CheckResultObject`.

**Параметры скрипта:**

*   `$TargetIP` ([string], Обязательный): IP-адрес или имя хоста (используется диспетчером).
*   `$Parameters` ([hashtable], Необязательный): Хэш-таблица с параметрами.
*   `$SuccessCriteria` ([hashtable], Необязательный): Хэш-таблица с критериями успеха (пока не используется).
*   `$NodeName` ([string], Необязательный): Имя узла для логирования.

**Параметры задания (`$Parameters`)**:

*   `process_names` ([string[]], Необязательный): Массив имен процессов для фильтрации (можно использовать `*`, например, `"sql*"`). Если не указан, выводятся все процессы.
*   `include_username` ([bool], Необязательный, по умолч. `$false`): Включать ли имя пользователя, запустившего процесс. Может требовать повышенных прав.
*   `include_path` ([bool], Необязательный, по умолч. `$false`): Включать ли путь к исполняемому файлу процесса. Может быть медленным и требовать повышенных прав.
*   `sort_by` ([string], Необязательный, по умолч. `'Name'`): Поле для сортировки. Допустимые значения (регистр не важен): `'Name'`, `'Id'`, `'CPU'` (или `'cpu_seconds'`), `'Memory'` (или `'memory_ws_mb'`, `'mem'`, `'ws'`), `'start_time'`.
*   `sort_descending` ([bool], Необязательный, по умолч. `$false`): Сортировать по убыванию?
*   `top_n` ([int], Необязательный): Отобразить только указанное количество процессов после сортировки.

**Критерии успеха (`$SuccessCriteria`)**:

*   **Пока не реализованы.** В текущей версии `CheckSuccess` всегда `$true`, если `IsAvailable = $true`.

**Возвращаемый результат:**

*   Стандартный объект (`IsAvailable`, `CheckSuccess`, `Timestamp`, `Details`, `ErrorMessage`).
*   `$Details` содержит:
    *   `processes` (List<object>): Массив хэш-таблиц, по одной для каждого процесса (или пустой). Каждая хэш-таблица содержит:
        *   `id` (int)
        *   `name` (string)
        *   `cpu_seconds` (double/null): Общее время процессора в секундах.
        *   `memory_ws_mb` (double/null): Рабочий набор памяти в МБ.
        *   `username` (string/null): Имя пользователя (если запрошено и доступно).
        *   `path` (string/null): Путь к файлу (если запрошено и доступно).
        *   `start_time` (string/null): Время запуска в UTC ISO 8601 (если доступно).
    *   `message` (string): (Опционально) Сообщение, если процессы по фильтру не найдены.
    *   `error` (string): (Опционально) Сообщение об ошибке, если `IsAvailable = $false`.

**Пример конфигурации Задания (Assignment):**

```json
// Пример 1: Топ 3 процесса по использованию памяти
{
  "node_id": 40,
  "method_id": 2, // ID для PROCESS_LIST
  "is_enabled": true,
  "parameters": {
    "sort_by": "Memory",
    "sort_descending": true,
    "top_n": 3,
    "include_username": false,
    "include_path": true // Получим путь
  },
  "success_criteria": null,
  "description": "Топ 3 процесса по памяти (с путем)"
}

// Пример 2: Проверить наличие процесса explorer.exe
{
  "node_id": 41,
  "method_id": 2, // ID для PROCESS_LIST
  "is_enabled": true,
  "parameters": {
    "process_names": ["explorer.exe"], // Ищем конкретный процесс
    "include_username": true // Получим пользователя
  },
  "success_criteria": null, // Пока не можем проверить, найден ли он
  "description": "Проверка наличия explorer.exe"
}


Возможные ошибки и замечания:

    Права доступа: Для получения username и path для всех процессов (особенно системных или запущенных другими пользователями) могут потребоваться права администратора. При недостатке прав соответствующие поля будут содержать [Ошибка доступа] или [Недоступен].

    Производительность: Получение path и username (особенно через WMI) может быть ресурсоемким, особенно при проверке большого количества процессов или на слабых машинах. Используйте include_username = $true и include_path = $true с осторожностью.

    Сортировка: Используются базовые свойства для сортировки. Сортировка по CPU может быть не всегда точной из-за того, как Get-Process его измеряет.

    Критерии: Реализация критериев успеха (например, проверка существования/отсутствия процесса, пороговые значения CPU/памяти) потребует доработки скрипта.

Зависимости:

    Функция New-CheckResultObject из StatusMonitorAgentUtils.psm1.