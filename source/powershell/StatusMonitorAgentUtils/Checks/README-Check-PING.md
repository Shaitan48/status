# Check-PING.ps1 (v2.3.2+)

**Назначение:**

Этот скрипт выполняет проверку доступности сетевого узла с помощью ICMP эхо-запросов (пинг), используя класс `System.Net.NetworkInformation.Ping`.

**Принцип работы:**

1.  Получает целевой IP-адрес или имя хоста (`TargetIP`) и опциональные параметры (`Parameters`, `SuccessCriteria`) от диспетчера `Invoke-StatusMonitorCheck`.
2.  Извлекает параметры пинга из `$Parameters`:
    *   `count` (количество запросов, по умолчанию 1).
    *   `timeout_ms` (таймаут для каждого запроса в мс, по умолчанию 1000).
    *   `buffer_size` (размер буфера, по умолчанию 32).
    *   `ttl` (Time-To-Live, по умолчанию 128).
3.  Отправляет указанное количество ICMP-запросов к `$TargetIP` с помощью `System.Net.NetworkInformation.Ping.Send()`.
4.  Анализирует ответы:
    *   Подсчитывает количество успешных ответов (`packets_received`).
    *   Рассчитывает процент потерь (`packet_loss_percent`).
    *   Рассчитывает среднее время ответа (`rtt_ms`) для успешных запросов.
    *   Фиксирует IP-адрес ответившего хоста (`ip_address`) из первого успешного ответа.
    *   Записывает статус первого ответа или общее сообщение об ошибке (`status_string`, `error`).
5.  Устанавливает `IsAvailable = $true`, если был получен **хотя бы один** успешный ответ (`Status = Success`). Иначе `IsAvailable = $false`.
6.  Заполняет хэш-таблицу `$Details` собранными метриками.
7.  Если `$SuccessCriteria` предоставлены и `$isAvailable` равен `$true`, вызывает `Test-SuccessCriteria -DetailsObject $details -CriteriaObject $SuccessCriteria` для оценки критериев.
    *   Критерии обычно применяются к полям `rtt_ms` и `packet_loss_percent`.
8.  Устанавливает `CheckSuccess` в `$true`, `$false` или `$null` (если критерии не заданы, выполнены, не выполнены или была ошибка их оценки).
9.  Формирует `ErrorMessage`, если `$isAvailable` или `$checkSuccess` равны `$false`, или если `$checkSuccess` равен `$null` при `$isAvailable = $true`.
10. Возвращает стандартизированный объект результата с помощью `New-CheckResultObject`.

**Параметры скрипта:**

*   `$TargetIP` ([string], Обязательный): IP-адрес или имя хоста для пинга.
*   `$Parameters` ([hashtable], Необязательный): Хэш-таблица с параметрами пинга.
*   `$SuccessCriteria` ([hashtable], Необязательный): Хэш-таблица с критериями успеха.
*   `$NodeName` ([string], Необязательный): Имя узла для логирования.

**Параметры задания (`$Parameters`)**:

*   `count` ([int], Необязательный, по умолч. 1): Количество ICMP-запросов для отправки.
*   `timeout_ms` ([int], Необязательный, по умолч. 1000): Таймаут ожидания ответа на **каждый** ICMP-запрос в миллисекундах.
*   `buffer_size` ([int], Необязательный, по умолч. 32): Размер буфера ICMP в байтах (макс. 65500).
*   `ttl` ([int], Необязательный, по умолч. 128): Максимальное количество переходов (hops) для пакета.

**Критерии успеха (`$SuccessCriteria`)**:

*   Применяются к объекту `$details`. Чаще всего используются для проверки:
    *   `rtt_ms` ([int]): Среднее время ответа в мс. Пример: `@{ rtt_ms = @{ '<=' = 100 } }`
    *   `packet_loss_percent` ([double]): Процент потерянных пакетов. Пример: `@{ packet_loss_percent = @{ '==' = 0 } }`
*   Можно комбинировать несколько критериев: `@{ rtt_ms = @{ '<' = 50 }; packet_loss_percent = @{ '<' = 10 } }`

**Возвращаемый результат (`$Details`)**:

*   `target_ip` (string): IP-адрес или имя хоста, которое пинговали.
*   `packets_sent` (int): Количество отправленных пакетов.
*   `packets_received` (int): Количество полученных успешных ответов.
*   `packet_loss_percent` (double): Процент потерянных пакетов.
*   `rtt_ms` (int/null): Среднее время ответа в мс для успешных пакетов (null, если не было успешных).
*   `ip_address` (string/null): Фактический IP-адрес, ответивший на пинг (из первого успешного ответа, null если не было успешных).
*   `status_string` (string): Строковое представление статуса первой попытки пинга (например, 'Success', 'TimedOut', 'DestinationHostUnreachable') или общее сообщение об ошибке.
*   `error` (string, опционально): Сообщение об основной ошибке, если пинг не удался.
*   `individual_ping_errors` (string[], опционально): Список ошибок для отдельных попыток пинга (если `count > 1` и были неудачные попытки, но хотя бы одна удалась).
*   `ErrorRecord` (string, опционально): Полная информация об исключении PowerShell, если произошла критическая ошибка.

**Пример конфигурации Задания (Assignment):**

```json
// Пинг шлюза 4 раза, RTT < 50мс, потери < 10%
{
  "node_id": 25,
  "method_id": 1, // ID для PING
  "is_enabled": true,
  "parameters": {
    "count": 4,
    "timeout_ms": 500
  },
  "success_criteria": {
    "rtt_ms": { "<": 50 },
    "packet_loss_percent": { "<": 10 }
  },
  "description": "Пинг шлюза (4x, <50ms, <10% loss)"
}

IGNORE_WHEN_COPYING_END

Возможные ошибки и замечания:

    Брандмауэр: ICMP Echo Request/Reply (Тип 8/Тип 0) должны быть разрешены.

    Разрешение имен: Если используется имя хоста, оно должно разрешаться в IP.

    Права: Обычно не требуются повышенные права.

Зависимости:

    Функции New-CheckResultObject, Test-SuccessCriteria из модуля StatusMonitorAgentUtils.psm1.

    .NET Framework (для System.Net.NetworkInformation.Ping).