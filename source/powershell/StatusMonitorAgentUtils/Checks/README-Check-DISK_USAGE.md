
---

**3. `powershell/StatusMonitorAgentUtils/Checks/README-Check-DISK_USAGE.md`**

```markdown
# Check-DISK_USAGE.ps1

**Назначение:**

Этот скрипт проверяет использование дискового пространства на локальных дисках, используя командлет `Get-Volume`.

**Принцип работы:**

1.  Получает параметры (`TargetIP`, `Parameters`, `SuccessCriteria`, `NodeName`) от диспетчера. `$TargetIP` напрямую не используется, так как скрипт выполняется локально на целевой машине (через `Invoke-Command`, если нужно).
2.  Вызывает `Get-Volume` для получения информации обо всех томах. Если команда не выполняется, устанавливает `IsAvailable = $false`.
3.  Фильтрует полученные тома:
    *   Оставляет только диски с `DriveType = 'Fixed'`.
    *   Оставляет только диски, имеющие букву (`DriveLetter`).
    *   Если в `$Parameters.drives` передан массив букв, оставляет только диски из этого списка (регистр не важен).
4.  Если после фильтрации дисков не осталось, проверка считается успешной (`CheckSuccess = $true`), в `$Details` добавляется соответствующее сообщение.
5.  Для каждого отфильтрованного диска:
    *   Рассчитывает общий размер, свободное/занятое место в байтах и ГБ, процент свободного/занятого места.
    *   Ищет применимый критерий успеха в `$SuccessCriteria`: сначала по букве диска (в верхнем регистре), затем по ключу `_default_`.
    *   Если найден критерий `min_percent_free`:
        *   Сравнивает рассчитанный процент свободного места с критерием.
        *   Устанавливает `criteria_passed = $true/$false` и `criteria_failed_reason`.
        *   Если критерий не пройден, устанавливает общий флаг `$overallCheckSuccess = $false` и добавляет сообщение в `$errorMessages`.
        *   Если значение `min_percent_free` некорректно, также считает критерий не пройденным.
    *   Добавляет собранную информацию о диске (включая результаты проверки критерия) в массив `$resultData.Details.disks`.
6.  Устанавливает итоговый `CheckSuccess` равным `$overallCheckSuccess`.
7.  Если были ошибки по критериям, объединяет сообщения из `$errorMessages` и записывает в `ErrorMessage`.
8.  Возвращает стандартизированный объект результата с помощью `New-CheckResultObject`.

**Параметры скрипта:**

*   `$TargetIP` ([string], Обязательный): IP-адрес или имя хоста (используется диспетчером).
*   `$Parameters` ([hashtable], Необязательный): Хэш-таблица с параметрами.
*   `$SuccessCriteria` ([hashtable], Необязательный): Хэш-таблица с критериями успеха.
*   `$NodeName` ([string], Необязательный): Имя узла для логирования.

**Параметры задания (`$Parameters`)**:

*   `drives` ([string[]], Необязательный): Массив строк с буквами дисков, которые нужно проверить (например, `@('C', 'D')`). Регистр не важен. Если не указан или пуст, проверяются все локальные диски типа 'Fixed'.

**Критерии успеха (`$SuccessCriteria`)**:

*   Ожидается хэш-таблица, где ключи - **большие** буквы дисков ('C', 'D', ...) или специальный ключ `_default_`.
*   Значения - хэш-таблицы, содержащие критерии.
*   Поддерживаемый критерий:
    *   `min_percent_free` ([int], Необязательный): Минимально допустимый процент свободного места на диске. Если фактический процент меньше этого значения, `CheckSuccess` будет `$false`.

**Возвращаемый результат:**

*   Стандартный объект (`IsAvailable`, `CheckSuccess`, `Timestamp`, `Details`, `ErrorMessage`).
*   `$Details` содержит:
    *   `disks` (List<object>): Массив хэш-таблиц, по одной для каждого проверенного диска. Каждая хэш-таблица содержит:
        *   `drive_letter` (string)
        *   `label` (string)
        *   `filesystem` (string)
        *   `size_bytes` (long), `free_bytes` (long), `used_bytes` (long)
        *   `size_gb` (double), `free_gb` (double), `used_gb` (double)
        *   `percent_free` (double), `percent_used` (double)
        *   `criteria_applied` (hashtable/null): Примененный критерий.
        *   `criteria_passed` (bool/null): Результат проверки критерия.
        *   `criteria_failed_reason` (string/null): Причина провала критерия.
    *   `message` (string): (Опционально) Сообщение, если диски не найдены.
    *   `error` (string): (Опционально) Сообщение об ошибке, если `IsAvailable = $false`.

**Пример конфигурации Задания (Assignment):**

```json
// Пример 1: Проверить все локальные Fixed диски, нужно > 10% свободно на каждом
{
  "node_id": 10,
  "method_id": 5, // ID для DISK_USAGE
  "is_enabled": true,
  "parameters": null, // Проверяем все диски
  "success_criteria": {
    "_default_": { "min_percent_free": 10 }
  },
  "description": "Проверка свободного места (>10%) на всех дисках"
}

// Пример 2: Проверить диск C (>15%) и диск D (>20%)
{
  "node_id": 10,
  "method_id": 5, // ID для DISK_USAGE
  "is_enabled": true,
  "parameters": {
    "drives": ["C", "D"] // Проверяем только C и D
  },
  "success_criteria": {
    "C": { "min_percent_free": 15 },
    "D": { "min_percent_free": 20 }
  },
  "description": "Проверка места: C>15%, D>20%"
}

GNORE_WHEN_COPYING_END

Возможные ошибки и замечания:

    Версия ОС: Командлет Get-Volume доступен начиная с Windows 8 / Windows Server 2012. На более старых системах проверка не сработает.

    Права доступа: Обычно не требует повышенных прав для локального выполнения.

    Сетевые/Съемные диски: Скрипт по умолчанию проверяет только диски с DriveType = 'Fixed'. Другие типы (Network, Removable, CD-ROM) игнорируются.

Зависимости:

    Функция New-CheckResultObject из StatusMonitorAgentUtils.psm1.

    ОС Windows 8 / Server 2012 или новее.