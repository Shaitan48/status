
---

**6. `powershell/StatusMonitorAgentUtils/Checks/README-Check-SQL_XML_QUERY.md`**

```markdown
# Check-SQL_XML_QUERY.ps1

**Назначение:**

Этот скрипт выполняет SQL-запрос к Microsoft SQL Server, извлекает XML-данные из указанного столбца первой строки результата, парсит этот XML и извлекает значения по заданному списку ключей (имен элементов).

**Принцип работы:**

1.  Получает параметры (`TargetIP`, `Parameters`, `SuccessCriteria`, `NodeName`) от диспетчера. `$TargetIP` используется как имя SQL Server instance.
2.  Извлекает и валидирует обязательные параметры из `$Parameters`: `sql_database`, `sql_query`, `xml_column_name`, `keys_to_extract`.
3.  Извлекает опциональные параметры для SQL-аутентификации (`sql_username`, `sql_password`) и таймаут запроса (`query_timeout_sec`).
4.  Проверяет наличие модуля `SqlServer` на машине выполнения. Если модуль отсутствует, генерирует ошибку (`IsAvailable = $false`).
5.  Формирует параметры для `Invoke-Sqlcmd`, включая учетные данные (Windows Auth по умолчанию или SQL Auth, если переданы `sql_username`/`sql_password`).
6.  Выполняет SQL-запрос с помощью `Invoke-Sqlcmd`. Если произошла ошибка подключения или выполнения запроса, устанавливает `IsAvailable = $false` и записывает ошибку.
7.  Если запрос выполнен успешно:
    *   Устанавливает `IsAvailable = $true`.
    *   Проверяет результат:
        *   Если результат пустой (0 строк), устанавливает `CheckSuccess = $true` и добавляет сообщение в `Details.message`.
        *   Если строки есть, берет первую строку.
        *   Проверяет наличие столбца `$xml_column_name` в первой строке. Если столбца нет или он `NULL`, устанавливает `CheckSuccess = $false` и записывает `ErrorMessage`.
        *   Если столбец найден и содержит данные, пытается преобразовать его содержимое в XML (`[xml]$xmlString`).
        *   Если парсинг XML неудачен, устанавливает `CheckSuccess = $false` и записывает `ErrorMessage` с деталями ошибки и примером XML.
        *   Если XML распарсен успешно:
            *   Итерирует по списку `$keys_to_extract`.
            *   Для каждого ключа пытается найти соответствующий дочерний элемент у корневого элемента XML.
            *   Извлекает текстовое содержимое найденного элемента (или `$null`, если элемент не найден).
            *   Записывает найденные пары ключ-значение в `$resultData.Details.extracted_data`.
            *   Устанавливает `CheckSuccess = $true` (пока нет реализованных критериев для данных).
8.  Возвращает стандартизированный объект результата с помощью `New-CheckResultObject`.

**Параметры скрипта:**

*   `$TargetIP` ([string], Обязательный): Имя или IP-адрес SQL Server instance (например, `SERVER\SQLEXPRESS` или `192.168.1.100`).
*   `$Parameters` ([hashtable], Обязательный): Хэш-таблица с параметрами.
*   `$SuccessCriteria` ([hashtable], Необязательный): Хэш-таблица с критериями успеха (пока не используется).
*   `$NodeName` ([string], Необязательный): Имя узла для логирования.

**Параметры задания (`$Parameters`)**:

*   `sql_database` ([string], **Обязательный**): Имя базы данных для подключения.
*   `sql_query` ([string], **Обязательный**): SQL-запрос, который необходимо выполнить. Запрос должен возвращать как минимум одну строку со столбцом, указанным в `xml_column_name`.
*   `xml_column_name` ([string], **Обязательный**): Имя столбца в результате запроса, который содержит XML-данные для парсинга.
*   `keys_to_extract` ([string[]], **Обязательный**): Массив строк, содержащий имена XML-элементов (ключей), значения которых нужно извлечь. Предполагается, что эти элементы являются прямыми потомками корневого элемента XML.
*   `sql_username` ([string], Необязательный): Имя пользователя для SQL Server аутентификации. Если не указано, используется Windows-аутентификация учетной записи, от имени которой запущен скрипт.
*   `sql_password` ([string], Необязательный): Пароль для SQL Server аутентификации. **Использовать с большой осторожностью! Хранение паролей в параметрах небезопасно.** Рекомендуется использовать Windows-аутентификацию.
*   `query_timeout_sec` ([int], Необязательный, по умолч. 30): Таймаут ожидания выполнения SQL-запроса в секундах.

**Критерии успеха (`$SuccessCriteria`)**:

*   **Пока не реализованы.** Можно будет добавить проверку значений извлеченных ключей (например, `$SuccessCriteria = @{ expected_VersionStat = '20230101' }`).

**Возвращаемый результат:**

*   Стандартный объект (`IsAvailable`, `CheckSuccess`, `Timestamp`, `Details`, `ErrorMessage`).
*   `$Details` содержит:
    *   `server_instance` (string): Имя SQL Server instance.
    *   `database_name` (string): Имя базы данных.
    *   `query_executed` (string): Выполненный SQL-запрос.
    *   `xml_source_column` (string): Имя столбца, из которого брался XML.
    *   `rows_returned` (int): Количество строк, возвращенных запросом.
    *   `extracted_data` (hashtable): Хэш-таблица с извлеченными данными (ключ - имя элемента, значение - его текстовое содержимое или `$null`, если не найден).
    *   `message` (string): (Опционально) Сообщение, если запрос не вернул строк.
    *   `error` (string): (Опционально) Сообщение об ошибке, если `IsAvailable = $false` или `CheckSuccess = $false`.
    *   `xml_content_sample` (string): (Опционально) Начало XML-строки, если произошла ошибка парсинга.

**Пример конфигурации Задания (Assignment):**

```json
// Пример: Получить VersionStat и TS_Version из столбца Revise
{
  "node_id": 60, // ID узла, представляющего SQL сервер или приложение
  "method_id": 8, // ID для SQL_XML_QUERY
  "is_enabled": true,
  "parameters": {
    "sql_database": "ApplicationDB",
    "sql_query": "SELECT TOP 1 Revise FROM Reports ORDER BY CreationDate DESC",
    "xml_column_name": "Revise",
    "keys_to_extract": ["VersionStat", "TS_Version"],
    "query_timeout_sec": 15
    // Используется Windows аутентификация
  },
  "success_criteria": null, // Критериев пока нет
  "description": "Получение версии ТС и статуса из последнего отчета SQL"
}

Возможные ошибки и замечания:

    Модуль SqlServer: Необходимо установить модуль SqlServer на машине, где выполняется скрипт (Install-Module SqlServer).

    Права доступа к SQL: Учетная запись, от имени которой запускается скрипт (или указанный SQL-пользователь), должна иметь права на подключение к SQL Server, доступ к указанной базе данных и права на выполнение переданного sql_query.

    Безопасность пароля: КАТЕГОРИЧЕСКИ НЕ РЕКОМЕНДУЕТСЯ хранить пароли SQL в параметрах задания. Используйте Windows-аутентификацию или другие безопасные методы управления учетными данными.

    Структура XML: Скрипт предполагает, что искомые ключи (keys_to_extract) являются прямыми дочерними элементами корневого элемента XML. Для более сложных XML-структур потребуется доработка логики извлечения.

    Производительность: Сложные SQL-запросы или запросы, возвращающие большие XML, могут выполняться долго. Настройте query_timeout_sec соответственно.

    Обработка результата: Скрипт обрабатывает только первую строку результата SQL-запроса.

Зависимости:

    Функция New-CheckResultObject из StatusMonitorAgentUtils.psm1.
    Модуль PowerShell SqlServer.
    Доступ к MS SQL Server.