
---

### 3. README для Конфигуратора Оффлайн Агентов

**Файл:** `powershell/configurator/README.md` (Обновленный)

```markdown
# PowerShell Конфигуратор Оффлайн Агентов (configurator) v4.1

Этот скрипт (`generate_and_deliver_config.ps1`) предназначен для автоматической генерации и (опционально) **атомарной** доставки файлов конфигурации с заданиями для **Гибридного Агента** в **Offline режиме**.

## Назначение

*   Подключаться к центральному API системы мониторинга.
*   Запрашивать актуальную конфигурацию заданий для одного или нескольких подразделений (объектов), идентифицируемых по их `ObjectId`.
*   **Атомарно** сохранять полученную конфигурацию (включая метаданные и список заданий) в JSON файлы специального формата (`{version_tag}_assignments.json.status.{transport_code}`).
*   Опционально **атомарно** доставлять (копировать) сгенерированные файлы в указанные папки.

## Принцип Работы

1.  Скрипт запускается (вручную или по расписанию).
2.  Читает параметры из файла `config.json`.
3.  Определяет список `ObjectId` для обработки (из конфига или через API).
4.  Для каждого `ObjectId`:
    *   Выполняет GET-запрос к `/api/v1/objects/{ObjectId}/offline_config`.
    *   API возвращает JSON-объект конфигурации.
    *   Скрипт проверяет корректность ответа.
    *   Формирует имя файла на основе шаблона и данных из ответа.
    *   **Сохраняет JSON во временный файл (`.tmp`) в `output_path_base`.**
    *   **При успехе сохранения, переименовывает временный файл в основной (`.json.status.*`).**
    *   Если задан `delivery_path_base`:
        *   Формирует путь к целевой папке.
        *   **Копирует основной файл во временный файл (`.tmp`) в папке доставки.**
        *   **При успехе копирования, переименовывает временный файл доставки в основной.**
5.  Логирует свою работу.

**Атомарность:** Использование временных файлов и операции переименования (которая обычно атомарна в пределах одного тома файловой системы) гарантирует, что Гибридный Агент не прочитает частично записанный или скопированный файл конфигурации.

## Конфигурация (`config.json`)

Необходимо создать и настроить файл `config.json` в той же папке:

```json
{
  "api_base_url": "http://localhost:48030/api", // ОБЯЗАТЕЛЬНО
  "api_key": "ВАШ_API_КЛЮЧ_С_РОЛЬЮ_CONFIGURATOR", // ОБЯЗАТЕЛЬНО
  "output_path_base": "F:\\status\\builds\\configs\\Generated", // ОБЯЗАТЕЛЬНО
  "delivery_path_base": "F:\\status\\builds\\delivery_conf", // ОБЯЗАТЕЛЬНО (или null, если доставка не нужна)
  "log_file": "F:\\status\\builds\\Logs\\configurator.log", // ОБЯЗАТЕЛЬНО
  "log_level": "Info", // Опционально (default: Info)
  "subdivision_ids_to_process": [], // ОБЯЗАТЕЛЬНО: [] для авто, [1060, ...] для конкретных
  "output_filename_template": "{version_tag}_assignments.json.status.{transport_code}", // ОБЯЗАТЕЛЬНО
  "delivery_subdir_template": "{transport_code}", // ОБЯЗАТЕЛЬНО
  "api_timeout_sec": 60 // Опционально (default: 60)
}

Запуск и Требования

    PowerShell: Версия 5.1 или выше.

    Сеть: Доступ к api_base_url.

    Права: Права на запись/переименование в output_path_base и delivery_path_base. Права на запись в log_file.

    API Ключ: Действительный ключ с ролью configurator.

    Запуск: Вручную или через Планировщик Задач.

Замечания

    Скрипт генерирует файлы для Гибридного Агента в Offline режиме.

    Убедитесь, что транспортная система (или сам агент) настроена на чтение файлов из папки доставки (delivery_path_base/{transport_code}/).