# PowerShell Гибридный Агент Мониторинга (hybrid-agent) v7.0

Этот скрипт (`hybrid-agent.ps1`) выполняет роль универсального агента мониторинга для системы Status Monitor, способного работать в двух режимах: **Online** и **Offline**.

## Назначение

*   Выполнять мониторинг узлов как с прямым сетевым доступом к API сервера (**Online режим**), так и в изолированных сетевых сегментах без доступа к API (**Offline режим**).
*   Режим работы определяется параметром `"mode"` в файле конфигурации `config.json`.
*   Использовать общий модуль `StatusMonitorAgentUtils` для выполнения конкретных проверок, обеспечивая единообразие логики.
*   Взаимодействовать с API сервера или файловой системой в зависимости от выбранного режима.
*   Вести детальный лог своей работы.

## Режимы Работы

### Online Режим (`"mode": "Online"`)

*   **Получение заданий:** Периодически (раз в `api_poll_interval_seconds`) запрашивает актуальный список активных заданий для своего `object_id` у API сервера (`GET /api/v1/assignments`).
*   **Выполнение:** Планирует и выполняет каждое полученное задание согласно его индивидуальному интервалу (`check_interval_seconds` из задания или `default_check_interval_seconds` из конфига).
*   **Отправка результатов:** Немедленно после выполнения КАЖДОЙ проверки отправляет результат на API сервер (`POST /api/v1/checks`). Результат отправляется в виде **массива из одного элемента**.
*   **Требования:** Прямой сетевой доступ к `api_base_url`, валидный `api_key` с ролью `agent`.

### Offline Режим (`"mode": "Offline"`)

*   **Получение заданий:** Ищет и читает самый новый файл конфигурации (`*.json.status.*`, соответствующий `object_id`) из папки, указанной в `assignments_file_path_pattern`. Задания выполняются только при обнаружении нового/обновленного файла конфигурации или при первом запуске.
*   **Выполнение:** Запускает ВСЕ задания из файла конфигурации за один проход (цикл). Цикличность выполнения всего набора проверок определяется параметром `offline_cycle_interval_seconds`. Если он равен 0, скрипт выполнит проверки один раз и завершится (подходит для запуска по расписанию).
*   **Отправка результатов:** Собирает результаты ВСЕХ проверок за цикл в один массив. **Атомарно** сохраняет этот массив вместе с метаданными (версии, ID объекта) в JSON-файл с расширением `.zrpu` в папку `output_path`. Этот файл затем должен быть передан и обработан **Загрузчиком Результатов**.
*   **Требования:** Доступ к папке с файлами конфигурации, доступ на запись в `output_path`. Сетевой доступ к API не требуется.

## Принцип работы

1.  Скрипт `hybrid-agent.ps1` запускается.
2.  Читает `config.json`.
3.  Определяет режим работы (`mode`).
4.  Валидирует необходимые параметры конфигурации для выбранного режима.
5.  Импортирует модуль `StatusMonitorAgentUtils`.
6.  Запускает логику для выбранного режима (либо бесконечный цикл для Online, либо цикл/однократный запуск для Offline).
7.  **В обоих режимах:** Для выполнения конкретной проверки вызывается `Invoke-StatusMonitorCheck` из модуля `StatusMonitorAgentUtils`.
8.  Логирует свою работу.

## Конфигурация (`config.json`)

Необходимо создать и настроить файл `config.json` в той же папке, что и `hybrid-agent.ps1`.

```json
{
    "mode": "Online", // "Online" или "Offline" - ОБЯЗАТЕЛЬНО
    "object_id": 1516, // ID объекта (подразделения/узла) - ОБЯЗАТЕЛЬНО
    "log_file": "C:/StatusMonitor/Logs/hybrid-agent.log", // ОБЯЗАТЕЛЬНО
    "log_level": "Info", // "Debug", "Verbose", "Info", "Warn", "Error" - ОБЯЗАТЕЛЬНО
    "agent_script_version": "hybrid_agent_v7.0", // Версия скрипта агента - ОБЯЗАТЕЛЬНО

    // --- Параметры для режима "Online" ---
    "api_base_url": "http://your-server-address:5000/api/v1", // ОБЯЗАТЕЛЬНО для Online
    "api_key": "your_agent_api_key",                     // ОБЯЗАТЕЛЬНО для Online (роль 'agent')
    "api_poll_interval_seconds": 60,                      // ОБЯЗАТЕЛЬНО для Online
    "default_check_interval_seconds": 300,               // ОБЯЗАТЕЛЬНО для Online
    "max_api_retries": 3,                                // Опционально для Online (default: 3)
    "retry_delay_seconds": 5,                            // Опционально для Online (default: 5)
    "api_timeout_sec": 60,                               // Опционально для Online (default: 60)

    // --- Параметры для режима "Offline" ---
    "assignments_file_path_pattern": "C:/StatusMonitor/OfflineConfig/*.json.status.*", // ОБЯЗАТЕЛЬНО для Offline
    "output_path": "C:/StatusMonitor/OfflineResults",          // ОБЯЗАТЕЛЬНО для Offline
    "output_name_template": "{ddMMyy_HHmmss}_{object_id}_HybridOffline.zrpu", // ОБЯЗАТЕЛЬНО для Offline
    "offline_cycle_interval_seconds": 3600                   // ОБЯЗАТЕЛЬНО для Offline (0 для однократного запуска)
}

Важно: Убедитесь, что для выбранного режима (mode) заданы все обязательные параметры.
Запуск и Требования

    PowerShell: Версия 5.1 или выше.

    Модуль Utils: Папка StatusMonitorAgentUtils должна находиться рядом с папкой hybrid-agent (т.е. ..\StatusMonitorAgentUtils) или в путях $env:PSModulePath.

    Online режим: Требуется сетевой доступ к api_base_url и к целевым узлам для проверок. Нужен действительный API ключ с ролью agent.

    Offline режим: Требуется доступ на чтение к папке с файлами конфигурации (assignments_file_path_pattern) и на запись в output_path. Необходим механизм доставки файлов конфигурации и отправки файлов результатов (.zrpu).

    Права: Права на запись в log_file. Права, необходимые для выполнения конкретных проверок (зависят от метода проверки).

    Запуск:

        Online: Рекомендуется запускать как Службу Windows для непрерывной работы.

        Offline (циклический): Рекомендуется запускать как Службу Windows.

        Offline (однократный, offline_cycle_interval_seconds = 0): Рекомендуется запускать через Планировщик Задач Windows с нужным интервалом.

Замечания

    Логика конкретных проверок находится в скриптах Checks/Check-*.ps1 модуля StatusMonitorAgentUtils.

    Атомарная запись .zrpu в Offline режиме обеспечивается через создание временного файла и его переименование.