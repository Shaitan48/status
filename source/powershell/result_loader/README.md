
---

### 2. README для Загрузчика Результатов

**Файл:** `powershell/result_loader/README.md` (Обновленный)

```markdown
# PowerShell Загрузчик Результатов (result_loader) v4.2

Этот скрипт (`result_loader.ps1`) предназначен для обработки файлов с результатами мониторинга (`*.zrpu`), сгенерированных **Гибридным Агентом** в **Offline режиме**, и загрузки этих данных в центральное API системы Status Monitor v5.2+.

## Назначение

*   Периодически сканировать указанную папку (`check_folder`) на наличие файлов результатов (`*.zrpu`).
*   Читать содержимое каждого файла `.zrpu`.
*   Извлекать метаданные (`agent_script_version`, `assignment_config_version`, `object_id`) и массив `results`.
*   Для **каждой** записи результата проверки из массива `results` формировать объект для API, **добавляя метаданные файла**.
*   Отправлять **весь пакет** результатов из одного файла **одним POST-запросом** на унифицированный эндпоинт `/api/v1/checks` центрального API.
*   После обработки файла API, отправить событие `FILE_PROCESSED` на эндпоинт `/api/v1/events` для логирования факта и статуса обработки файла.
*   **Атомарно** перемещать обработанный файл в соответствующую подпапку (`Processed`, `Error`, `Unrecoverable`).

## Принцип работы

1.  Транспортная Система доставляет файлы результатов (`*.zrpu`) от Гибридных Агентов (Offline режим) в папку, указанную как `check_folder` в `config.json` загрузчика.
2.  Скрипт `result_loader.ps1` запускается (например, через Планировщик Задач) на машине, имеющей доступ к `check_folder` и центральному API.
3.  Читает параметры из своего файла `config.json`.
4.  В бесконечном цикле (с интервалом `scan_interval_seconds`):
    *   Сканирует папку `check_folder` на наличие файлов `*.zrpu`.
    *   Для каждого найденного файла:
        *   Пытается прочитать и распарсить его как JSON. **При ошибке** - логирует и перемещает файл в **`error_folder`**.
        *   Извлекает метаданные и массив `results`. Валидирует базовую структуру. **При ошибке** - логирует и перемещает файл в **`error_folder`**.
        *   Формирует **массив** объектов (`$payloadArray`) для отправки на `POST /checks`, добавляя метаданные файла в каждый элемент.
        *   Если `$payloadArray` не пуст, отправляет его **одним POST-запросом** на `/api/v1/checks`, используя функцию `Invoke-ApiRequestWithRetry`.
        *   Анализирует ответ API (ожидается 200 OK или 207 Multi-Status). Определяет статус обработки (`success`, `error_api`).
        *   Формирует тело события `FILE_PROCESSED` с информацией об обработке (включая количество ошибок API, если были).
        *   Отправляет событие в API `/api/v1/events`. Обрабатывает возможные ошибки отправки события.
        *   **Атомарно перемещает файл:**
            *   В `processed_folder` - если API вернул 200 OK (или 207 без ошибок *для этого файла*) И событие успешно отправлено.
            *   В **`unrecoverable_error_folder` (DLQ)** - если API вернул ошибку (любой статус, кроме 200/207) ИЛИ вернул 207 с ошибками ИЛИ не удалось отправить событие `FILE_PROCESSED`. Эти файлы требуют ручного анализа.
            *   В `error_folder` - если произошла ошибка чтения/парсинга файла (до отправки в API).
        *   Логирует результат обработки файла.
    *   Ожидает интервал `scan_interval_seconds` перед следующим сканированием.

## Конфигурация (`config.json`)

Необходимо создать и настроить файл `config.json` в той же папке, что и `result_loader.ps1`.

```json
{
    "api_base_url": "http://localhost:48030/api", // ОБЯЗАТЕЛЬНО
    "api_key": "ВАШ_API_КЛЮЧ_С_РОЛЬЮ_LOADER",     // ОБЯЗАТЕЛЬНО
    "check_folder": "C:/StatusMonitor/IncomingResults", // ОБЯЗАТЕЛЬНО - Откуда брать .zrpu
    "processed_folder": "C:/StatusMonitor/Processed",    // ОБЯЗАТЕЛЬНО - Куда перемещать успешно обработанные
    "error_folder": "C:/StatusMonitor/Error",            // ОБЯЗАТЕЛЬНО - Куда перемещать при ошибках чтения/парсинга
    "unrecoverable_error_folder": "C:/StatusMonitor/Unrecoverable", // ОБЯЗАТЕЛЬНО - Куда перемещать при ошибках API/событий (DLQ)
    "log_file": "C:/Logs/StatusMonitor/result_loader.log", // ОБЯЗАТЕЛЬНО
    "log_level": "Info", // "Debug", "Verbose", "Info", "Warn", "Error" - ОБЯЗАТЕЛЬНО
    "scan_interval_seconds": 30, // Опционально (default: 30)
    "api_timeout_sec": 60,       // Опционально (default: 60)
    "max_api_retries": 3,        // Опционально (default: 3)
    "retry_delay_seconds": 5     // Опционально (default: 5)
}


Запуск и Требования

    PowerShell: Версия 5.1 или выше.

    Сеть: Требуется сетевой доступ с машины загрузчика к api_base_url.

    Доступ к Файлам: Требуются права на чтение, запись и удаление файлов в check_folder и ее подпапках Processed, Error, Unrecoverable.

    Права: Скрипту нужны права на запись в log_file.

    API Ключ: Убедитесь, что API ключ имеет роль loader.

    Запуск: Рекомендуется запускать через Планировщик Задач Windows или как Службу Windows для обеспечения непрерывной работы.

Замечания

    Скрипт ожидает, что файлы *.zrpu имеют корректную JSON-структуру, созданную hybrid-agent.ps1 (v7.0+).

    Файлы, вызвавшие ошибки при взаимодействии с API (например, из-за невалидных assignment_id внутри), будут перемещены в папку unrecoverable_error_folder для последующего анализа.