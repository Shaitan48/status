
---

**7. `powershell/result_loader/README.md` (Обновление)**

(Замени существующий README.md на этот, так как предыдущий был сгенерирован до финальных исправлений)

```markdown
# PowerShell Загрузчик Результатов (result_loader) v3.16

Этот скрипт (`result_loader.ps1`) предназначен для обработки файлов с результатами мониторинга (`*.zrpu`), сгенерированных **оффлайн-агентами**, и загрузки этих данных в центральное API системы Status Monitor.

## Назначение

*   Периодически сканировать указанную папку (`check_folder`) на наличие файлов результатов (`*_OfflineChecks.json.status*.zrpu`).
*   Читать содержимое каждого файла `.zrpu`.
*   Извлекать метаданные (`agent_script_version`, `assignment_config_version`) и массив `results`.
*   Для каждой записи результата проверки из массива `results`:
    *   Извлечь `assignment_id` и другие данные (статус, детали и т.д.).
    *   Отправить POST-запрос на эндпоинт `/api/v1/checks` центрального API, передавая все необходимые данные, включая версии из метаданных файла.
*   После успешной обработки всех записей в файле, отправить событие `FILE_PROCESSED` на эндпоинт `/api/v1/events` для логирования факта обработки файла.
*   Перемещать обработанный файл в подпапку `Processed` или `Error` внутри `check_folder`.

## Принцип работы

1.  Транспортная Система доставляет файлы результатов (`*.zrpu`) от оффлайн-агентов в папку, указанную как `check_folder` в `config.json` загрузчика.
2.  Скрипт `result_loader.ps1` запускается (например, через Планировщик Задач) на машине, имеющей доступ к `check_folder` и центральному API.
3.  Читает параметры из своего файла `config.json`.
4.  В бесконечном цикле:
    *   Сканирует папку `check_folder` на наличие файлов, соответствующих маске `*_OfflineChecks.json.status*.zrpu`.
    *   Для каждого найденного файла:
        *   Пытается прочитать и распарсить его как JSON.
        *   Извлекает `agent_script_version`, `assignment_config_version` из корневого объекта JSON.
        *   Извлекает массив `results`.
        *   Для **каждой** записи (`$resultItem`) в `results`:
            *   Проверяет наличие `assignment_id`, `IsAvailable`, `Timestamp`. Если чего-то нет, пропускает запись и логирует ошибку.
            *   Формирует тело запроса для `/api/v1/checks`, используя поля из `$resultItem` (такие как `is_available`, `check_timestamp`, `details`, `check_success`, `error_message` и т.д.), `assignment_id` из записи, а также `agent_script_version` и `assignment_config_version` из метаданных файла.
            *   Формирует полные заголовки запроса (включая `X-API-Key`).
            *   Отправляет POST-запрос к API с помощью функции `Invoke-ApiRequestWithRetry`. Обрабатывает возможные ошибки и повторные попытки.
        *   Если **все** записи из файла успешно отправлены (или пропущены из-за отсутствия `assignment_id`), статус обработки файла считается `success` или `partial_error`.
        *   Если при чтении/парсинге файла или при отправке записей возникли **критические** ошибки (не удалось отправить после ретраев), статус обработки файла считается `error`.
        *   Формирует тело события `FILE_PROCESSED` с информацией об обработке.
        *   Формирует полные заголовки и отправляет событие в API `/api/v1/events`.
        *   Перемещает файл в подпапку `Processed` (если статус `success`) или `Error` (если статус `partial_error` или `error`).
    *   Ожидает интервал `scan_interval_seconds` перед следующим сканированием.
    *   Логирует свою работу.

## Конфигурация (`config.json`)

Необходимо создать и настроить файл `config.json` в той же папке, что и `result_loader.ps1`:

```json
{
    "api_base_url": "http://localhost:48030/api",
    "api_key": "ВАШ_API_КЛЮЧ_С_РОЛЬЮ_LOADER",
    "check_folder": "F:\\StatusMonitor\\IncomingResults",
    "log_file": "F:\\Logs\\StatusMonitor\\result_loader.log",
    "log_level": "Info",
    "scan_interval_seconds": 30,
    "api_timeout_sec": 30,
    "max_api_retries": 3,
    "retry_delay_sec": 5
}

Поля конфигурации:

    api_base_url: (Строка, Обязательно) Базовый URL API сервера Status Monitor.

    api_key: (Строка, Обязательно) API ключ, сгенерированный в системе Status Monitor с ролью loader.

    check_folder: (Строка, Обязательно) Папка, куда Транспортная Система доставляет файлы результатов (*.zrpu) от оффлайн-агентов.

    log_file: (Строка, Обязательно) Полный путь к лог-файлу загрузчика.

    log_level: (Строка, Опционально, По умолчанию "Info") Уровень детализации логов (Debug, Verbose, Info, Warn, Error).

    scan_interval_seconds: (Число, Опционально, По умолчанию 30) Интервал сканирования папки check_folder в секундах.

    api_timeout_sec: (Число, Опционально, По умолчанию 30) Таймаут ожидания ответа от API в секундах.

    max_api_retries: (Число, Опционально, По умолчанию 3) Максимальное количество попыток запроса к API при сбое.

    retry_delay_sec: (Число, Опционально, По умолчанию 5) Задержка в секундах перед повторной попыткой запроса к API.

Запуск и Требования

    PowerShell: Версия 5.1 или выше.

    Сеть: Требуется сетевой доступ с машины загрузчика к apiBaseUrl.

    Доступ к Файлам: Требуются права на чтение, запись и удаление файлов в check_folder и ее подпапках Processed, Error.

    Права: Скрипту нужны права на запись в logFile.

    Запуск: Рекомендуется запускать через Планировщик Задач Windows или как Службу Windows для обеспечения непрерывной работы.

Замечания

    Убедитесь, что API ключ имеет роль loader.

    Скрипт ожидает, что файлы *.zrpu имеют корректную JSON-структуру, созданную offline-agent.ps1 версии 3.0 или выше (т.е. содержат assignment_id в каждой записи results).

    Ошибки при отправке отдельных записей или пропуск записей без assignment_id приведут к перемещению всего файла в папку Error. Детали ошибок будут в логе скрипта и в событии FILE_PROCESSED.