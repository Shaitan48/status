# PowerShell Online Агент (online-agent) v5.5

Этот скрипт (`online-agent.ps1`) выполняет роль агента мониторинга для узлов, имеющих **прямой сетевой доступ** к центральному API системы Status Monitor.

## Назначение

*   Периодически подключаться к API и запрашивать актуальный список заданий мониторинга (`Assignments`), предназначенных для подразделения, в котором он работает (определяется по `object_id` в конфигурации).
*   Самостоятельно планировать и выполнять полученные задания с заданными интервалами.
*   Для выполнения каждой проверки использовать **локально** модуль `StatusMonitorAgentUtils` и его функцию-диспетчер `Invoke-StatusMonitorCheck`.
*   Немедленно отправлять стандартизированный результат **каждой** выполненной проверки обратно в API (`POST /api/v1/checks`), используя API-ключ для аутентификации.

## Принцип работы

1.  Скрипт `online-agent.ps1` запускается (например, через Планировщик Задач или как Служба Windows).
2.  Читает параметры из локального файла `config.json`.
3.  Импортирует модуль `StatusMonitorAgentUtils` (он должен находиться рядом или в путях PowerShell).
4.  Периодически (с интервалом `api_poll_interval_seconds`) выполняет GET-запрос к API (`/api/v1/assignments?object_id=...`), используя `object_id` и `api_key`.
5.  Хранит полученный список активных заданий в памяти (`$script:ActiveAssignments`). Сравнивает с предыдущим списком, добавляет новые, удаляет неактуальные.
6.  В бесконечном цикле проверяет, не пришло ли время выполнить какое-либо из активных заданий (с учетом `check_interval_seconds` из задания или `default_check_interval_seconds` из конфига).
7.  При наступлении времени выполнения для задания:
    *   Вызывает **локально** `Invoke-StatusMonitorCheck`, передавая ему объект задания.
    *   `Invoke-StatusMonitorCheck` находит и **локально** запускает соответствующий скрипт `Checks/Check-*.ps1`.
    *   Скрипт `Check-*.ps1` выполняет проверку (например, `Test-Connection` к целевому IP, `Get-Service` и т.д.).
    *   Агент получает стандартизированный результат (`IsAvailable`, `CheckSuccess`, `Timestamp`, `Details`, `ErrorMessage`).
    *   Агент формирует тело запроса для `POST /api/v1/checks`, включая `assignment_id`, статус `is_available` (из результата), `timestamp` (из результата), `details` (включая `CheckSuccess` и `ErrorMessage`), `agent_script_version`.
    *   Отправляет POST-запрос в API с помощью функции `Send-CheckResultToApi`, используя API-ключ.
    *   Обновляет время последнего выполнения для этого задания локально (только при успешной отправке).
8.  Логирует свою работу в файл, указанный в `config.json`.

## Конфигурация (`config.json`)

Необходимо создать и настроить файл `config.json` в той же папке, что и `online-agent.ps1`:

```json
{
    "object_id": 1516,
    "config_type": "online_multi_check_agent_v5.5",
    "apiBaseUrl": "http://localhost:48030/api",
    "api_key": "ВАШ_API_КЛЮЧ_С_РОЛЬЮ_AGENT",
    "api_poll_interval_seconds": 60,
    "default_check_interval_seconds": 120,
    "logFile": "C:\\Logs\\StatusMonitor\\online_agent.log",
    "LogLevel": "Info"
}

Поля конфигурации:

    object_id: (Число, Обязательно) Уникальный внешний ID подразделения (subdivisions.object_id) из центральной БД. Агент будет получать задания только для узлов этого подразделения.

    config_type: (Строка, Информационно) Тип и версия агента.

    apiBaseUrl: (Строка, Обязательно) Базовый URL API сервера Status Monitor (например, http://status.example.com/api). Без /v1/ в конце.

    api_key: (Строка, Обязательно) API ключ, сгенерированный в системе Status Monitor с ролью agent. Используется для аутентификации при запросах к API.

    api_poll_interval_seconds: (Число, Опционально, По умолчанию 60) Как часто (в секундах) агент будет опрашивать API для обновления списка своих заданий.

    default_check_interval_seconds: (Число, Опционально, По умолчанию 120) Интервал выполнения проверки (в секундах), который будет использоваться, если интервал не указан в самом задании, полученном от API.

    logFile: (Строка, Обязательно) Полный путь к файлу, куда агент будет писать логи. Папка должна существовать и быть доступна для записи.

    LogLevel: (Строка, Опционально, По умолчанию "Info") Уровень детализации логов (Debug, Verbose, Info, Warn, Error).

Запуск и Требования

    PowerShell: Версия 5.1 или выше.

    Модуль StatusMonitorAgentUtils: Папка StatusMonitorAgentUtils должна находиться рядом с папкой online-agent (т.е. ..\StatusMonitorAgentUtils) или в одном из путей, перечисленных в $env:PSModulePath.

    Сеть: Требуется сетевой доступ с машины агента к apiBaseUrl И к целевым узлам, которые он будет проверять (например, для PING, Get-Service).

    Права:

        Права на запись в logFile.

        Права, необходимые для выполнения конкретных проверок (например, для Get-Service на удаленной машине могут потребоваться права администратора и настроенный WinRM).

    Запуск: Рекомендуется запускать через Планировщик Задач Windows или как Службу Windows для обеспечения непрерывной работы и автоматического перезапуска.

Замечания

    Убедитесь, что API ключ, указанный в config.json, действителен и имеет роль agent.

    Для методов проверки, отличных от PING, необходимо реализовать соответствующую логику в скриптах Checks/Check-*.ps1 модуля StatusMonitorAgentUtils.