# PowerShell Компоненты для Status Monitor (v5.x - Гибридная Архитектура)

Эта папка содержит PowerShell скрипты и модули, которые составляют клиентскую часть системы мониторинга Status Monitor, основанную на концепции **Гибридного Агента** и **pipeline-заданий**.

## Структура

*   **`HybridAgent/`**:
    *   `hybrid-agent.ps1`: Основной скрипт **Гибридного Агента**.
    *   `config.json` (пример): Файл конфигурации для Гибридного Агента.
    *   `README.md`: Подробное описание настройки и работы Гибридного Агента.
*   **`StatusMonitorAgentUtils/`**:
    *   `StatusMonitorAgentUtils.psm1`: **Общий модуль PowerShell**, содержащий логику выполнения отдельных шагов проверки (pipeline steps) и вспомогательные функции.
    *   `StatusMonitorAgentUtils.psd1`: Манифест модуля.
    *   `Checks/`: Папка со скриптами для конкретных типов шагов проверки (например, `Check-PING.ps1`, `Check-SERVICE_STATUS.ps1`). Каждый такой скрипт реализует логику одного атомарного действия/проверки.
    *   `README.md`: Описание модуля, его функций и принципов добавления новых типов шагов.
*   **`configurator/`**:
    *   `generate_and_deliver_config.ps1`: Скрипт **Конфигуратора**. Генерирует файлы конфигурации с pipeline-заданиями для Гибридных Агентов, работающих в оффлайн-режиме.
    *   `config.json` (пример): Файл конфигурации для Конфигуратора.
    *   `README.md`: Описание Конфигуратора.
*   **`result_loader/`**:
    *   `result_loader.ps1`: Скрипт **Загрузчика Результатов**. Обрабатывает файлы (`*.zrpu`) от Гибридных Агентов (работающих в оффлайн-режиме) и отправляет данные в API сервера.
    *   `config.json` (пример): Файл конфигурации для Загрузчика.
    *   `README.md`: Описание Загрузчика.
*   `Dockerfile.tests`: Dockerfile для запуска Pester-тестов для модуля `StatusMonitorAgentUtils`.

## Ключевые Компоненты и Принципы

### 1. Гибридный Агент (`HybridAgent/hybrid-agent.ps1`)

Единый агент, способный работать в двух режимах в зависимости от конфигурации (`config.json` -> `"mode"`):

*   **Online режим:**
    *   Агент напрямую подключается к API сервера Status Monitor.
    *   Периодически запрашивает назначенные ему **pipeline-задания** (`GET /api/v1/assignments?object_id=...`).
    *   Для каждого задания выполняет последовательно все шаги из его `pipeline`.
    *   Собирает результаты всех шагов и формирует **один агрегированный результат** для всего pipeline-задания.
    *   Немедленно отправляет этот агрегированный результат на API сервер (`POST /api/v1/checks`). Поле `detail_data` этого результата должно содержать массив с результатами каждого отдельного шага.
*   **Offline режим:**
    *   Агент читает **pipeline-задания** из локального файла конфигурации (`*.json.status.*`), сгенерированного Конфигуратором.
    *   Для каждого задания выполняет все шаги из его `pipeline`.
    *   Собирает результаты выполнения всех pipeline-заданий (каждый с детализацией по шагам) и сохраняет их в один агрегированный файл (`*.zrpu`).
    *   Этот `.zrpu` файл затем должен быть передан и обработан **Загрузчиком Результатов**.

### 2. Модуль Утилит (`StatusMonitorAgentUtils/StatusMonitorAgentUtils.psm1`)

Является ядром выполнения отдельных шагов проверок.

*   **`Invoke-PipelineStep` (Новая или рефакторенная функция):**
    *   **Роль:** Выполнение одного конкретного шага из pipeline. Вызывается Гибридным Агентом для каждого шага.
    *   **Вход:** Объект одного шага pipeline (содержащий `type`, `description`, `parameters`, `success_criteria`) и контекст узла/задания (например, `TargetIP`, `NodeName`).
    *   **Логика:**
        1.  Определяет `type` шага.
        2.  Находит и вызывает соответствующий скрипт `Checks/Check-TYPE.ps1`.
        3.  Передает в скрипт `Check-*.ps1` параметры из `step.parameters` и `step.success_criteria`.
        4.  Возвращает стандартизированный результат выполнения этого шага (сформированный через `New-CheckResultObject`).
*   **Скрипты Проверок (`Checks/Check-*.ps1`):** Каждый скрипт реализует логику одного атомарного типа шага (например, пинг, проверка службы, выполнение SQL).
    *   Принимает параметры, специфичные для этого типа шага (из поля `parameters` объекта шага).
    *   Опционально обрабатывает `success_criteria` для этого конкретного шага с помощью `Test-SuccessCriteria`.
    *   Возвращает результат через `New-CheckResultObject` (`IsAvailable`, `CheckSuccess`, `Details`, `ErrorMessage`).
*   **Вспомогательные функции:** `New-CheckResultObject` (для стандартизации результата шага), `Test-SuccessCriteria` (для оценки `success_criteria` отдельного шага).

### 3. Pipeline-Задания

Каждое задание, назначаемое узлу, теперь представляет собой **pipeline** – упорядоченный массив шагов, хранящийся в поле `pipeline` (JSONB) таблицы `node_check_assignments`.

*   **Структура Шага в Pipeline (пример):**
    ```json
    {
      "type": "PING", // Имя из check_methods, соответствует Check-PING.ps1
      "description": "Пинг основного шлюза (шаг 1)", // Описание шага
      "parameters": { "target": "192.168.1.1", "count": 3 }, // Параметры для Check-PING.ps1
      "success_criteria": { "rtt_ms": { "<=": 100 } },      // Критерии успеха для этого шага
      "continue_on_failure": false // Продолжать ли pipeline, если этот шаг не прошел (CheckSuccess=false/null)
    }
    ```
*   **Гибридный Агент** отвечает за последовательное выполнение шагов в pipeline, передачу необходимых данных между шагами (если это предусмотрено отдельными типами шагов, например, через специальный контекстный объект), и агрегацию общего результата pipeline.

### 4. Конфигуратор и Загрузчик

*   **Конфигуратор (`configurator/`)**: Запрашивает у API (`GET /api/v1/objects/{id}/offline_config`) полную конфигурацию для оффлайн-агента, включающую **pipeline-задания**, и сохраняет ее в файл.
*   **Загрузчик (`result_loader/`)**: Читает файлы `*.zrpu`, содержащие результаты выполнения **pipeline-заданий** (включая детализацию по шагам в `detail_data` каждого результата), и отправляет их на API (`POST /api/v1/checks/bulk`).

## Рабочий Процесс (Общий для Гибридного Агента)

1.  **Администратор** через UI (или API) создает/изменяет **pipeline-задания** для узлов в БД.
2.  **Гибридный Агент:**
    *   **Online:** Получает свои pipeline-задания от API.
    *   **Offline:** Получает pipeline-задания из файла, сгенерированного Конфигуратором.
3.  **Гибридный Агент** для каждого задания итерирует по его `pipeline`:
    *   Для каждого шага агент вызывает `Invoke-PipelineStep` из `StatusMonitorAgentUtils`, передавая ему данные шага.
    *   `Invoke-PipelineStep` вызывает соответствующий `Checks/Check-TYPE.ps1`.
    *   Собирает результат шага.
    *   Принимает решение о продолжении/прерывании pipeline на основе флага `continue_on_failure` и результата (`CheckSuccess`) текущего шага.
4.  **Гибридный Агент** формирует итоговый **агрегированный результат** для всего pipeline-задания. Этот результат содержит:
    *   Общий `is_available` (например, `false`, если критический шаг упал).
    *   Общий `check_success` (например, `false`, если важный критерий не пройден).
    *   В поле `detail_data` этого агрегированного результата помещается массив с результатами каждого выполненного шага.
5.  **Отправка результатов:**
    *   **Online:** Отправляет агрегированный результат pipeline в API (`POST /api/v1/checks`).
    *   **Offline:** Записывает агрегированный результат pipeline в `.zrpu` файл для Загрузчика.

## Добавление Новых Типов Шагов Проверки

1.  Добавить новую запись в таблицу `check_methods` в БД (например, `MY_CUSTOM_CHECK`).
2.  Создать скрипт `Checks/Check-MY_CUSTOM_CHECK.ps1` в модуле `StatusMonitorAgentUtils/`.
3.  Реализовать в этом скрипте логику проверки, принимая `$Parameters` и `$SuccessCriteria`, возвращая результат через `New-CheckResultObject`.
4.  Теперь шаги с `type: "MY_CUSTOM_CHECK"` можно использовать в pipeline-заданиях.