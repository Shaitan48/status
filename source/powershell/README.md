# PowerShell Скрипты для Status Monitor

Эта папка содержит PowerShell скрипты и модули, которые выполняют роль агентов мониторинга и вспомогательных утилит для системы Status Monitor.

## Структура

*   **`online-agent/`**: Содержит скрипт и конфигурацию для **Онлайн-агента**, работающего на машинах с прямым доступом к API сервера мониторинга.
    *   [`online-agent/README.md`](online-agent/README.md)
*   **`offline-agent/`**: Содержит скрипт и конфигурацию для **Оффлайн-агента**, работающего в изолированных сетях без доступа к API.
    *   [`offline-agent/README.md`](offline-agent/README.md)
*   **`result_loader/`**: Скрипт и конфигурация **Загрузчика Результатов**, который обрабатывает файлы (`*.zrpu`) от оффлайн-агентов и отправляет данные в API.
    *   [`result_loader/README.md`](result_loader/README.md)
*   **`configurator/`**: Скрипт и конфигурация **Конфигуратора**, который генерирует файлы с заданиями для оффлайн-агентов, запрашивая данные у API.
    *   [`configurator/README.md`](configurator/README.md)
*   **`StatusMonitorAgentUtils/`**: **ОБЩИЙ МОДУЛЬ PowerShell**, содержащий основную логику выполнения проверок. Используется как онлайн, так и оффлайн агентами.
    *   [`StatusMonitorAgentUtils/README.md`](StatusMonitorAgentUtils/README.md)

## Ключевой компонент: `StatusMonitorAgentUtils`

Этот модуль является сердцем выполнения проверок на стороне PowerShell.

*   **Диспетчер (`Invoke-StatusMonitorCheck`)**: Основная экспортируемая функция модуля. Агенты вызывают именно ее, передавая объект задания. Функция определяет, какой метод проверки нужно выполнить (`method_name` из задания), находит соответствующий скрипт `Checks/Check-*.ps1` и **запускает его локально** на машине агента, передавая нужные параметры.
*   **Скрипты проверок (`Checks/Check-*.ps1`)**: Папка `Checks` внутри `StatusMonitorAgentUtils` содержит отдельные `.ps1` файлы для каждого метода проверки (например, `Check-PING.ps1`, `Check-SERVICE_STATUS.ps1`). Каждый такой скрипт выполняет **только свою конкретную проверку**, используя переданные ему параметры (например, IP-адрес цели, имя службы), и возвращает стандартизированный результат.
*   **Вспомогательные функции**: Модуль также содержит функции для стандартизации формата результата (`New-CheckResultObject`) и, в будущем, может содержать другие общие утилиты.

**Важно:** Для добавления поддержки нового метода мониторинга необходимо создать соответствующий `Check-METHOD_NAME.ps1` файл в папке `Checks/` и реализовать в нем логику проверки и возврата стандартизированного результата.

## Принцип работы с Заданиями (Assignments)

Система использует модель "Заданий" (`Assignments`), хранящихся в центральной БД. Каждый результат проверки должен быть связан с конкретным заданием через `assignment_id`.

*   **Online-агент:** Получает задания (с `assignment_id`) от API. Вызывает `Invoke-StatusMonitorCheck`. Получает результат. Отправляет результат **вместе с `assignment_id`** в API `/api/v1/checks`.
*   **Offline-агент:** Получает задания (с `assignment_id`) из файла `.json.status.КОД_ТС`. Вызывает `Invoke-StatusMonitorCheck`. Получает результат. **Добавляет `assignment_id`** к полученному результату. Сохраняет массив дополненных результатов в файл `*.zrpu`.
*   **Загрузчик (`result_loader`):** Читает файл `*.zrpu`. Для каждой записи результата извлекает `assignment_id` и остальные данные, формирует запрос и отправляет его в API `/api/v1/checks`.

Это позволяет серверу точно сопоставить каждый полученный результат с конкретным заданием, настроенным администратором.